<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>زکوٰۃ کیلکولیٹر اور مینیجمنٹ ایپ</title>
    <style>
        :root {
            --primary-color: #006400; /* Dark Green */
            --secondary-color: #f4f4f4;
            --text-color: #333;
            --border-color: #ccc;
            --hover-color: #004d00;
            --button-text-color: #fff;
            --error-color: #dc3545;
            --success-color: #28a745;
            --info-bg-color: #d1ecf1;
            --info-border-color: #bee5eb;
            --warning-bg-color: #fff3cd;
            --warning-border-color: #ffeeba;
        }

        body {
            font-family: 'Noto Nastaliq Urdu', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
            direction: rtl; /* Right-to-left for Urdu */
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        header {
            background-color: var(--primary-color);
            color: var(--button-text-color);
            padding: 15px;
            border-radius: 8px 8px 0 0;
            text-align: center;
        }

        header h1 {
            margin: 0;
            font-size: 1.8em;
        }

        .zakat-rules {
            background-color: #e8f5e9; /* Light green background */
            border: 1px solid #a5d6a7;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .zakat-rules h2 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 1.4em;
        }

        .zakat-rules ul {
            padding-right: 20px; /* Indentation for Urdu list */
            margin-bottom: 0;
        }
         .zakat-rules li {
            margin-bottom: 10px;
         }
        .zakat-rules strong {
             color: var(--primary-color);
        }

        nav {
            background-color: #333;
            padding: 10px 0;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 0 0 8px 8px; /* Rounded bottom corners when header is separate */
        }

         nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }

        nav ul li {
            margin: 5px 10px;
        }

        nav ul li button {
            background-color: #555;
            color: var(--button-text-color);
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-family: inherit;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        nav ul li button:hover, nav ul li button.active {
            background-color: var(--primary-color);
        }


        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: #fff;
            margin-top: -1px; /* Connect visually with nav */
        }

        .tab-content.active {
            display: block;
        }

        h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
            margin-top: 0; /* Adjust margin for content sections */
             margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input[type="number"],
        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box; /* Include padding and border in element's total width and height */
            font-family: inherit; /* Ensure consistent font */
             text-align: right; /* Align text to right for Urdu */
        }

        textarea {
            resize: vertical;
             min-height: 80px;
        }

        button {
            background-color: var(--primary-color);
            color: var(--button-text-color);
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-family: inherit;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: var(--hover-color);
        }

        button.secondary {
            background-color: #6c757d; /* Gray */
        }
        button.secondary:hover {
            background-color: #5a6268;
        }
         button.danger {
            background-color: var(--error-color); /* Red */
        }
        button.danger:hover {
            background-color: #c82333;
        }


        .result-area, .info-area, .history-area, .report-area {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }

        .result-area strong {
            color: var(--primary-color);
        }
         .info-area {
            background-color: var(--info-bg-color);
            border-color: var(--info-border-color);
            color: #0c5460; /* Darker text for info */
         }
        .info-area.warning {
             background-color: var(--warning-bg-color);
             border-color: var(--warning-border-color);
             color: #856404; /* Darker text for warning */
         }


        .error-message {
            color: var(--error-color);
            font-weight: bold;
            margin-top: 10px;
             padding: 10px;
             background-color: #f8d7da;
             border: 1px solid #f5c6cb;
             border-radius: 4px;
             display: block; /* Ensure it takes full width */
         }


        .success-message {
            color: var(--success-color);
            font-weight: bold;
            margin-top: 10px;
             padding: 10px;
             background-color: #d4edda;
             border: 1px solid #c3e6cb;
             border-radius: 4px;
             display: block; /* Ensure it takes full width */
        }


        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: right; /* Right align for Urdu */
        }

        th {
            background-color: var(--primary-color);
            color: var(--button-text-color);
        }

        tbody tr:nth-child(even) {
            background-color: var(--secondary-color);
        }

        .year-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px dashed var(--border-color);
        }
        .year-section:last-child {
             border-bottom: none;
             margin-bottom: 0;
             padding-bottom: 0;
        }

         .year-section h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.3em;
        }


        .help-section dl {
            margin-bottom: 20px;
        }
        .help-section dt {
            font-weight: bold;
            margin-top: 10px;
             color: var(--primary-color);
        }
        .help-section dd {
             margin-right: 20px; /* Indentation for Urdu */
             margin-bottom: 10px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 15px;
            }

            nav ul {
                flex-direction: column; /* Stack nav items vertically */
                 align-items: stretch;
            }
             nav ul li {
                margin: 5px 0;
             }
            nav ul li button {
                width: 100%; /* Full width buttons */
                text-align: center;
             }

            header h1 {
                font-size: 1.5em;
            }

            .zakat-rules h2 {
                 font-size: 1.2em;
            }
            .form-group input[type="number"],
            .form-group input[type="text"],
            .form-group input[type="date"],
            .form-group select,
            .form-group textarea {
                padding: 8px;
            }

            button {
                 padding: 10px 15px;
                 font-size: 0.95em;
            }
            th, td {
                padding: 8px;
                font-size: 0.9em; /* Smaller font in tables */
            }
             .tab-content {
                padding: 15px;
            }
        }
         @media (max-width: 480px) {
            header h1 {
                font-size: 1.3em;
            }
            .zakat-rules h2 {
                 font-size: 1.1em;
            }
             nav ul li button {
                padding: 8px 10px;
                font-size: 0.9em;
            }
             th, td {
                padding: 6px;
                font-size: 0.85em;
            }
             button {
                 padding: 8px 12px;
                 font-size: 0.9em;
             }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>زکوٰۃ کیلکولیٹر اور مینیجمنٹ ایپ</h1>
        </header>

         <div class="zakat-rules">
            <h2>زکوٰۃ کا حساب لگانے کا طریقہ</h2>
            <ul>
                 <li><strong>نصاب کا تعین:</strong>
                    <ul>
                        <li>اگر آپ کے پاس <strong>صرف سونا</strong> ہے اور وہ <strong>7.5 تولے</strong> (87.48 گرام) یا اس سے زیادہ ہے، تو آپ صاحبِ نصاب ہیں۔</li>
                        <li>اگر آپ کے پاس <strong>صرف چاندی</strong> ہے اور وہ <strong>52.5 تولے</strong> (612.36 گرام) یا اس سے زیادہ ہے، تو آپ صاحبِ نصاب ہیں۔</li>
                         <li>اگر آپ کے پاس <strong>ملا جلا مال</strong> (سونا، چاندی، نقد رقم، مالِ تجارت، وصول طلب قرضے میں سے کوئی دو یا زیادہ اشیاء) ہے، تو نصاب کا تعین <strong>52.5 تولے چاندی کی موجودہ قیمت</strong> سے کیا جائے گا۔ اگر آپ کے تمام قابلِ زکوٰۃ اثاثوں کی مجموعی مالیت 52.5 تولے چاندی کی قیمت کے برابر یا اس سے زیادہ ہے، تو آپ صاحبِ نصاب ہیں۔ (یہ سب سے عام صورتحال ہے)۔</li>
                    </ul>
                </li>
                <li><strong>قابلِ زکوٰۃ اثاثے:</strong> سونا، چاندی، نقد رقم (کیش، بینک بیلنس، پرائز بانڈ وغیرہ)، مالِ تجارت (فروخت کی نیت سے خریدا گیا سامان)، قابلِ فروخت شیئرز، وصول طلب قرضے (جن کی واپسی کی امید ہو)۔</li>
                 <li><strong>واجب الادا قرضے:</strong> زکوٰۃ کا حساب کرتے وقت، آپ اپنے کل قابلِ زکوٰۃ اثاثوں میں سے اپنی فوری واجب الادا ذمہ داریاں اور قرضے (جو زکوٰۃ کا سال مکمل ہونے پر ادا کرنے ہیں) منہا کر سکتے ہیں۔</li>
                <li><strong>زکوٰۃ کی شرح:</strong> اگر آپ صاحبِ نصاب ہیں اور آپ کے قابلِ زکوٰۃ اثاثوں پر ایک قمری سال (حول) گزر چکا ہے، تو آپ کو اپنے <strong>کل قابلِ زکوٰۃ اثاثوں میں سے واجب الادا قرضے منہا کرنے کے بعد بچنے والی رقم</strong> کا <strong>2.5 فیصد</strong> بطور زکوٰۃ ادا کرنا ہوگا۔ اگر قرضے منہا کرنے کے بعد کچھ نہیں بچتا یا منفی میں چلا جاتا ہے تو زکوٰۃ واجب نہیں ہوگی (اگرچہ نصاب پورا ہو)۔</li>
                 <li><strong>سال کا پورا ہونا (حول):</strong> زکوٰۃ اس مال پر واجب ہوتی ہے جو نصاب تک پہنچ جائے اور اس پر ایک پورا قمری سال (تقریباً 354 دن) گزر جائے۔ جس تاریخ کو آپ پہلی بار صاحبِ نصاب بنے تھے، وہی آپ کی زکوٰۃ کی سالانہ تاریخ (Zakat Anniversary) ہے۔ ہر سال اسی قمری تاریخ کو اپنے مال کا حساب کر کے زکوٰۃ ادا کرنی چاہیے۔</li>
             </ul>
        </div>


        <nav>
            <ul>
                <li><button id="tab-calc" onclick="showTab('calculator')">کیلکولیٹر</button></li>
                <li><button id="tab-hist" onclick="showTab('history')">حساب کتاب کی تاریخ</button></li>
                <li><button id="tab-pay" onclick="showTab('payments')">ادائیگیوں کا ریکارڈ</button></li>
                <li><button id="tab-rep" onclick="showTab('reports')">رپورٹس</button></li>
                <li><button id="tab-set" onclick="showTab('setting')">سیٹنگز</button></li>
                <li><button id="tab-help" onclick="showTab('help')">مدد</button></li>
            </ul>
        </nav>

        <div id="calculator" class="tab-content">
            <h2>زکوٰۃ کیلکولیٹر</h2>
            <div id="reminder-message" class="info-area warning" style="display:none; margin-bottom: 15px;"></div>
             <div class="info-area" id="calc-info-prices" style="margin-bottom: 15px; background-color: #fff3cd; border-color: #ffeeba;">
                 براہ کرم پہلے 'سیٹنگز' میں سونے اور چاندی کی موجودہ قیمتیں فی تولہ درج کریں۔
            </div>
            <form id="zakat-form">
                 <div class="form-group">
                     <label for="year">سال (جس سال کا حساب کر رہے ہیں):</label>
                     <input type="number" id="year" name="year" required>
                 </div>
                <div class="form-group">
                    <label for="gold">سونا (تولے میں):</label>
                    <input type="number" id="gold" name="gold" step="any" value="0" required>
                </div>
                <div class="form-group">
                    <label for="silver">چاندی (تولے میں):</label>
                    <input type="number" id="silver" name="silver" step="any" value="0" required>
                </div>
                <div class="form-group">
                    <label for="cash">نقد رقم / بینک بیلنس:</label>
                    <input type="number" id="cash" name="cash" step="any" value="0" required>
                </div>
                <div class="form-group">
                    <label for="business-goods">مالِ تجارت اور قابلِ فروخت سرمایہ کاری:</label>
                    <input type="number" id="business-goods" name="business-goods" step="any" value="0" required>
                </div>
                <div class="form-group">
                    <label for="receivables">وصول طلب قرضے (دوسروں سے لینے ہیں، واپسی کی امید ہو):</label>
                    <input type="number" id="receivables" name="receivables" step="any" value="0" required>
                </div>
                <div class="form-group">
                    <label for="liabilities">فوری واجب الادا قرضے / ذمہ داریاں (منہا کرنے کے لیے):</label>
                    <input type="number" id="liabilities" name="liabilities" step="any" value="0" required>
                </div>
                <button type="submit">حساب لگائیں</button>
                <button type="button" onclick="saveCalculation()" id="save-calc-btn" style="display: none; margin-right: 10px;">حساب محفوظ کریں</button>
            </form>
            <div id="zakat-result" class="result-area" style="display:none;">
                <h3>نتیجہ برائے سال <span id="result-year"></span>:</h3>
                <p id="result-details"></p>
                <p id="zakat-due-message"></p>
            </div>
             <div id="calc-error" class="error-message" style="display:none;"></div>
             <div id="calc-success" class="success-message" style="display:none;"></div>
        </div>

        <div id="history" class="tab-content">
            <h2>حساب کتاب کی تاریخ</h2>
            <div id="history-list">
                <p>کوئی حسابی ریکارڈ موجود نہیں ہے۔</p>
            </div>
        </div>

        <div id="payments" class="tab-content">
            <h2>ادائیگیوں کا ریکارڈ</h2>
             <div id="payment-reminder" class="info-area warning" style="display:none; margin-bottom: 15px;"></div>
            <h3>نئی ادائیگی شامل کریں</h3>
            <form id="payment-form">
                <div class="form-group">
                     <label for="payment-year">سال (جس سال کی زکوٰۃ ہے):</label>
                     <input type="number" id="payment-year" required>
                 </div>
                <div class="form-group">
                    <label for="payment-amount">رقم:</label>
                    <input type="number" id="payment-amount" step="any" required>
                </div>
                <div class="form-group">
                    <label for="payment-date">تاریخ:</label>
                    <input type="date" id="payment-date" required>
                </div>
                <div class="form-group">
                    <label for="payment-recipient">وصول کنندہ:</label>
                    <input type="text" id="payment-recipient">
                </div>
                 <div class="form-group">
                    <label for="payment-category">کیٹیگری:</label>
                    <input type="text" id="payment-category">
                </div>
                <div class="form-group">
                    <label for="payment-notes">نوٹس:</label>
                    <textarea id="payment-notes"></textarea>
                </div>
                <button type="submit">ادائیگی محفوظ کریں</button>
            </form>
            <div id="payment-success" class="success-message" style="display:none;"></div>
             <div id="payment-error" class="error-message" style="display:none;"></div>

            <h3 style="margin-top: 30px;">ادائیگیوں کی تفصیل</h3>
             <div class="form-group">
                <label for="payment-history-year-filter">سال کے لحاظ سے فلٹر کریں:</label>
                <select id="payment-history-year-filter" onchange="renderPaymentHistory()">
                    <option value="">تمام سال</option>
                    </select>
            </div>
            <div id="payment-history-list">
                <table>
                    <thead>
                        <tr>
                             <th>سال</th>
                            <th>تاریخ</th>
                            <th>رقم</th>
                            <th>وصول کنندہ</th>
                             <th>کیٹیگری</th>
                            <th>نوٹس</th>
                             <th>عمل</th>
                        </tr>
                    </thead>
                    <tbody id="payment-history-table-body">
                        <tr><td colspan="7">کوئی ادائیگی ریکارڈ موجود نہیں ہے۔</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

         <div id="reports" class="tab-content">
            <h2>رپورٹس اور ڈیٹا</h2>
            <h3>خلاصہ رپورٹ</h3>
            <div class="form-group">
                <label for="report-year-filter">سال منتخب کریں:</label>
                <select id="report-year-filter" onchange="generateReport()">
                    <option value="">سال منتخب کریں</option>
                    </select>
            </div>
             <div id="report-area" class="report-area" style="display:none;">
                 <h4 id="report-year-heading"></h4>
                <table id="report-summary-table">
                     <tbody>
                        <tr><td>کل اثاثے (بشمول سونا/چاندی کی قیمت):</td><td id="report-total-assets"></td></tr>
                        <tr><td>واجب الادا قرضے:</td><td id="report-liabilities"></td></tr>
                        <tr><td>قابلِ زکوٰۃ اثاثے (قرض منہا کرنے کے بعد):</td><td id="report-zakatable-assets"></td></tr>
                         <tr><td>نصاب (چاندی کی قیمت):</td><td id="report-nisab-value"></td></tr>
                         <tr><td>نصاب پورا ہوا؟:</td><td id="report-nisab-status"></td></tr>
                        <tr><td>زکوٰۃ واجب ہے؟:</td><td id="report-zakat-status"></td></tr>
                        <tr><td>واجب الادا زکوٰۃ (2.5%):</td><td id="report-zakat-due"></td></tr>
                        <tr><td>ادا شدہ زکوٰۃ (اس سال):</td><td id="report-zakat-paid"></td></tr>
                        <tr><td>بقیہ زکوٰۃ (اس سال):</td><td id="report-zakat-remaining"></td></tr>
                    </tbody>
                </table>
                 <h4>اس سال کی ادائیگیاں:</h4>
                 <table id="report-payments-table">
                     <thead>
                         <tr>
                            <th>تاریخ</th>
                            <th>رقم</th>
                            <th>وصول کنندہ</th>
                            <th>کیٹیگری</th>
                            <th>نوٹس</th>
                        </tr>
                     </thead>
                     <tbody id="report-payments-body">
                         <tr><td colspan="5">اس سال کوئی ادائیگی نہیں ہوئی۔</td></tr>
                     </tbody>
                 </table>
            </div>
             <div id="report-error" class="error-message" style="display:none;"></div>

            <h3 style="margin-top: 30px;">ڈیٹا ایکسپورٹ / امپورٹ</h3>
            <div class="form-group">
                <button onclick="exportData()">ڈیٹا ایکسپورٹ کریں (JSON)</button>
                <a id="download-link" style="display:none;"></a>
            </div>
            <div class="form-group">
                 <label for="import-file">ڈیٹا امپورٹ کریں (JSON فائل):</label>
                 <input type="file" id="import-file" accept=".json" style="padding: 5px;">
                <button onclick="importData()" style="margin-top: 10px;">فائل امپورٹ کریں</button>
            </div>
            <div id="import-status" style="margin-top: 10px;"></div>
        </div>


        <div id="settings" class="tab-content">
            <h2>سیٹنگز</h2>
             <p>یہاں سونے اور چاندی کی موجودہ قیمتیں فی تولہ درج کریں۔ یہ قیمتیں زکوٰۃ کے حساب کتاب کے لیے استعمال ہوں گی۔</p>
            <form id="settings-form">
                <div class="form-group">
                    <label for="gold-price">سونے کی قیمت (فی تولہ):</label>
                    <input type="number" id="gold-price" step="any" required>
                </div>
                <div class="form-group">
                    <label for="silver-price">چاندی کی قیمت (فی تولہ):</label>
                    <input type="number" id="silver-price" step="any" required>
                </div>
                 <div class="form-group">
                    <label for="zakat-due-date-pref">ترجیحی زکوٰۃ کی تاریخ (اختیاری، مثلاً 1 رمضان، 15 شعبان):</label>
                    <input type="text" id="zakat-due-date-pref" placeholder="مثلاً 1 رمضان">
                    <small>یہ صرف یاد دہانی کے لیے ہے۔ اصل حساب آپ کی زکوٰۃ کی سالگرہ پر منحصر ہے۔</small>
                 </div>
                <button type="submit">سیٹنگز محفوظ کریں</button>
            </form>
            <div id="settings-success" class="success-message" style="display:none;"></div>
            <div id="settings-error" class="error-message" style="display:none;"></div>
        </div>

        <div id="help" class="tab-content">
            <h2>مدد اور رہنمائی</h2>

            <div class="help-section">
                <h3>بنیادی اسلامی رہنمائی</h3>
                <p>زکوٰۃ اسلام کے پانچ بنیادی ارکان میں سے ایک ہے۔ یہ صاحبِ نصاب مسلمان پر فرض ہے کہ وہ اپنے مال کا ایک مخصوص حصہ (عموماً 2.5 فیصد) اللہ کی راہ میں خرچ کرے۔ زکوٰۃ کا مقصد معاشرے سے غربت کا خاتمہ، مال کی پاکیزگی اور اللہ کی خوشنودی حاصل کرنا ہے۔</p>
                 <p><strong>نصاب:</strong> وہ کم از کم مالیت ہے جس پر زکوٰۃ فرض ہوتی ہے۔</p>
                 <ul>
                     <li><strong>سونا:</strong> اگر کسی کے پاس صرف سونا ہو تو نصاب 7.5 تولہ (تقریباً 87.48 گرام) ہے۔</li>
                    <li><strong>چاندی:</strong> اگر کسی کے پاس صرف چاندی ہو تو نصاب 52.5 تولہ (تقریباً 612.36 گرام) ہے۔</li>
                     <li><strong>مخلوط اثاثے:</strong> اگر سونا، چاندی، نقدی، مالِ تجارت وغیرہ ملا جلا ہو تو نصاب کا تعین 52.5 تولہ چاندی کی قیمت سے کیا جاتا ہے۔ اگر کل قابلِ زکوٰۃ مال کی قیمت اس حد سے زیادہ ہو تو زکوٰۃ فرض ہو گی۔</li>
                 </ul>
                 <p><strong>حول (سال کا گزرنا):</strong> زکوٰۃ اس مال پر فرض ہوتی ہے جو نصاب کے برابر یا اس سے زیادہ ہو اور اس پر ایک پورا قمری سال (تقریباً 354 دن) گزر جائے۔ جس تاریخ کو آپ پہلی بار صاحبِ نصاب بنے اور سال مکمل ہونے پر بھی صاحبِ نصاب رہے، وہ آپ کی زکوٰۃ کی سالانہ تاریخ (Zakat Anniversary) ہے۔ ہر سال اسی تاریخ کو اپنے اثاثوں کا حساب کر کے زکوٰۃ ادا کرنا ہوتی ہے۔</p>


                 <h3>اکثر پوچھے جانے والے سوالات (FAQs)</h3>
                <dl>
                    <dt>سوال: کن چیزوں پر زکوٰۃ فرض ہے؟</dt>
                    <dd>سونا، چاندی، نقد رقم (کیش، بینک بیلنس، پرائز بانڈ وغیرہ)، مالِ تجارت (فروخت کی نیت سے خریدا گیا سامان)، قابلِ فروخت شیئرز، وصول طلب قرضے (جو واپس ملنے کی امید ہو)۔</dd>

                     <dt>سوال: کن چیزوں پر زکوٰۃ نہیں ہے؟</dt>
                    <dd>ذاتی استعمال کی چیزیں جیسے رہائشی مکان، استعمال کی گاڑی، کپڑے، فرنیچر وغیرہ پر زکوٰۃ نہیں۔ اسی طرح فیکٹری کی مشینری، اوزار وغیرہ جو پیداوار کے لیے استعمال ہوں، ان پر بھی زکوٰۃ نہیں۔ تاہم، ان سے حاصل ہونے والی آمدنی اگر نصاب تک پہنچ جائے اور سال گزر جائے تو اس آمدنی پر زکوٰۃ ہو گی۔</dd>

                    <dt>سوال: قرض کی صورت میں زکوٰۃ کا کیا حکم ہے؟</dt>
                    <dd>اگر آپ نے کسی کو قرض دیا ہے اور اس کی واپسی کی امید ہے تو وہ رقم آپ کے قابلِ زکوٰۃ اثاثوں میں شمار ہو گی۔ اگر آپ نے کسی سے قرض لیا ہوا ہے اور وہ فوری واجب الادا ہے (مثلاً زکوٰۃ کی تاریخ پر ادا کرنا ہے)، تو زکوٰۃ کا حساب کرتے وقت اس قرض کی رقم اپنے کل اثاثوں سے منہا کر سکتے ہیں۔ طویل مدتی قرضوں (جیسے ہاؤسنگ لون کی مستقبل کی اقساط) کو عام طور پر منہا نہیں کیا جاتا، لیکن اس میں تفصیل ہے، لہٰذا عالم سے پوچھنا بہتر ہے۔</dd>

                     <dt>سوال: کیا سال کے دوران مال کم زیادہ ہونے سے فرق پڑتا ہے؟</dt>
                    <dd>زکوٰۃ کی فرضیت کے لیے سال کے شروع اور آخر میں نصاب کا مالک ہونا ضروری ہے۔ سال کے دوران مال کم ہو کر نصاب سے نیچے چلا جائے اور پھر سال ختم ہونے سے پہلے دوبارہ نصاب کے برابر یا زیادہ ہو جائے تو زکوٰۃ واجب رہے گی۔ زکوٰۃ کا حساب سال کے اختتام پر (آپ کی زکوٰۃ کی تاریخ پر) موجود کل قابلِ زکوٰۃ مالیت پر ہوتا ہے۔</dd>

                     <dt>سوال: میں سونے اور چاندی کی قیمت کہاں سے حاصل کروں؟</dt>
                     <dd>آپ مقامی صرافہ بازار یا معتبر آن لائن ذرائع سے سونے اور چاندی کی تازہ ترین قیمتیں معلوم کر سکتے ہیں اور انہیں 'سیٹنگز' ٹیب میں درج کر سکتے ہیں۔</dd>

                    <dt>سوال: زکوٰۃ کی تاریخ کیسے یاد رکھوں؟</dt>
                     <dd>جس دن آپ پہلی بار صاحبِ نصاب بنے تھے، اس دن کی قمری تاریخ نوٹ کر لیں۔ ہر سال اسی قمری تاریخ کو زکوٰۃ کا حساب کریں۔ آپ اپنی سہولت کے لیے 'سیٹنگز' میں اپنی ترجیحی تاریخ (مثلاً "1 رمضان") لکھ سکتے ہیں تاکہ ایپ آپ کو یاد دہانی کرا سکے۔ تاہم، یاد دہانی کا انحصار آپ کے آخری محفوظ کردہ حساب کی تاریخ پر ہوگا۔</p></dd>
                 </dl>

                 <h3>ایپ استعمال کرنے کی ہدایات</h3>
                 <ol>
                     <li><strong>سیٹنگز:</strong> سب سے پہلے 'سیTINGز' ٹیب میں جا کر سونے اور چاندی کی موجودہ قیمت فی تولہ درج کریں اور محفوظ کریں۔ آپ اختیاری طور پر اپنی زکوٰۃ کی ترجیحی تاریخ بھی درج کر سکتے ہیں۔</li>
                    <li><strong>کیلکولیٹر:</strong> 'کیلکولیٹر' ٹیب میں مطلوبہ سال درج کریں، پھر اپنے تمام اثاثے (سونا، چاندی، نقد رقم، مالِ تجارت، وصول طلب قرضے) اور فوری واجب الادا قرضوں کی تفصیلات درج کریں۔ 'حساب لگائیں' بٹن دبائیں۔ ایپ نصاب اور واجب الادا زکوٰۃ کا حساب لگا کر نتیجہ دکھائے گی۔ آپ اس حساب کو 'حساب محفوظ کریں' بٹن دبا کر ریکارڈ میں شامل کر سکتے ہیں۔ حساب محفوظ کرنے سے آپ کی زکوٰۃ کی یاد دہانی بھی اپ ڈیٹ ہو جائے گی۔</li>
                    <li><strong>حساب کتاب کی تاریخ:</strong> 'حساب کتاب کی تاریخ' ٹیب میں آپ کے محفوظ کردہ تمام سالانہ زکوٰۃ حسابات کی تفصیلات دیکھی جا سکتی ہیں۔</li>
                    <li><strong>ادائیگیوں کا ریکارڈ:</strong> 'ادائیگیوں کا ریکارڈ' ٹیب میں آپ اپنی زکوٰۃ کی ادائیگیوں کو درج کر سکتے ہیں (رقم، تاریخ، وصول کنندہ، نوٹس وغیرہ)۔ یہاں آپ اپنی تمام پچھلی ادائیگیوں کی فہرست بھی دیکھ سکتے ہیں اور سال کے لحاظ سے فلٹر کر سکتے ہیں۔ اگر آپ کی پچھلے حساب کے مطابق زکوٰۃ باقی ہے تو یہاں یاد دہانی بھی نظر آئے گی۔</li>
                    <li><strong>رپورٹس:</strong> 'رپورٹس' ٹیب میں کسی مخصوص سال کے لیے اپنے اثاثوں، واجب الادا زکوٰۃ اور ادا شدہ زکوٰۃ کا خلاصہ دیکھ سکتے ہیں۔ آپ یہاں سے اپنا تمام ڈیٹا (حسابات، ادائیگیاں، سیٹنگز) JSON فائل کی صورت میں ڈاؤن لوڈ (ایکسپورٹ) کر سکتے ہیں اور بعد میں اسی فائل سے ڈیٹا واپس اپ لوڈ (امپورٹ) بھی کر سکتے ہیں۔</li>
                     <li><strong>مدد:</strong> اس ٹیب میں زکوٰۃ سے متعلق بنیادی معلومات اور ایپ کے استعمال کی ہدایات موجود ہیں۔</li>
                 </ol>
                  <p><strong>اہم نوٹ:</strong> یہ ایپ حساب کتاب میں مدد کے لیے بنائی گئی ہے۔ زکوٰۃ کے تفصیلی مسائل اور پیچیدہ صورتحال کے لیے مستند عالمِ دین سے رجوع کرنا ضروری ہے۔ ایپ میں درج تمام ڈیٹا آپ کے براؤزر میں مقامی طور پر محفوظ ہوتا ہے اور کسی سرور پر نہیں بھیجا جاتا۔ براؤزر کا ڈیٹا صاف کرنے سے یہ معلومات ضائع ہو سکتی ہیں، لہذا وقتاً فوقتاً ڈیٹا ایکسپورٹ کرتے رہیں۔</p>
            </div>
        </div>

    </div>

    <script>
        const DB_NAME = 'zakatAppDB';
        const DB_VERSION = 1; // Keep version 1 unless schema changes significantly
        const STORES = {
            settings: 'settings',
            calculations: 'calculations',
            payments: 'payments'
        };

        let db;
        let currentCalculationResult = null; // To hold the latest calculation before saving
        let currentSettings = { goldPrice: 0, silverPrice: 0, zakatDueDatePref: '' }; // Global settings cache including preference

        // --- Database Functions ---

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    // Check and create stores if they don't exist
                    if (!db.objectStoreNames.contains(STORES.settings)) {
                         // Add zakatDueDatePref here if upgrading from a version without it
                         db.createObjectStore(STORES.settings, { keyPath: 'id' });
                     }
                    if (!db.objectStoreNames.contains(STORES.calculations)) {
                        db.createObjectStore(STORES.calculations, { keyPath: 'year' });
                    }
                    if (!db.objectStoreNames.contains(STORES.payments)) {
                        const paymentStore = db.createObjectStore(STORES.payments, { keyPath: 'id', autoIncrement: true });
                        paymentStore.createIndex('year_idx', 'year', { unique: false });
                        paymentStore.createIndex('date_idx', 'date', { unique: false });
                    }
                     console.log('Database upgrade needed or initial setup complete.');
                 };


                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('Database opened successfully.');
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error('Database error:', event.target.errorCode);
                    reject('ڈیٹا بیس کھولنے میں خرابی: ' + event.target.errorCode);
                };
            });
        }

        function getStore(storeName, mode) {
             if (!db) {
                 console.error("Database is not open.");
                 // Attempt to reopen might be complex, better to inform user or reject
                 return Promise.reject("ڈیٹا بیس شروع نہیں ہوا۔ براہ کرم صفحہ ریفریش کریں۔");
            }
            try {
                const transaction = db.transaction(storeName, mode);
                return transaction.objectStore(storeName);
            } catch (error) {
                 console.error(`Error getting store ${storeName}:`, error);
                 return Promise.reject(`اسٹور تک رسائی میں خرابی: ${storeName}`);
             }
        }


        async function saveSettings(goldPrice, silverPrice, zakatDueDatePref) {
             try {
                 const store = await getStore(STORES.settings, 'readwrite');
                 // Use a fixed key 'current'
                 const request = store.put({
                     id: 'current',
                     goldPrice: goldPrice,
                     silverPrice: silverPrice,
                     zakatDueDatePref: zakatDueDatePref || '' // Ensure it's a string, default to empty
                 });
                 return new Promise((resolve, reject) => {
                     request.onsuccess = () => {
                         currentSettings = { goldPrice, silverPrice, zakatDueDatePref: zakatDueDatePref || '' }; // Update cache
                         updatePriceInfoInCalculator(); // Update UI
                         resolve('سیٹنگز کامیابی سے محفوظ ہو گئیں۔');
                    };
                     request.onerror = (event) => reject('سیٹنگز محفوظ کرنے میں خرابی: ' + event.target.error);
                 });
             } catch (error) {
                 console.error("Save settings error:", error);
                 return Promise.reject("سیٹنگز تک رسائی میں خرابی۔ " + error);
             }
         }

        async function loadSettings() {
             try {
                 const store = await getStore(STORES.settings, 'readonly');
                 const request = store.get('current');
                 return new Promise((resolve) => { // No reject, just resolve with defaults on error
                     request.onsuccess = (event) => {
                         if (event.target.result) {
                             currentSettings = event.target.result; // Update cache
                             document.getElementById('gold-price').value = currentSettings.goldPrice || '';
                             document.getElementById('silver-price').value = currentSettings.silverPrice || '';
                             document.getElementById('zakat-due-date-pref').value = currentSettings.zakatDueDatePref || '';
                         } else {
                             // Initialize with defaults if no settings found
                             currentSettings = { goldPrice: 0, silverPrice: 0, zakatDueDatePref: '' };
                         }
                         updatePriceInfoInCalculator(); // Update UI
                         resolve(currentSettings);
                     };
                     request.onerror = (event) => {
                         console.error("Load settings error:", event.target.error);
                         // Fallback to defaults on error
                         currentSettings = { goldPrice: 0, silverPrice: 0, zakatDueDatePref: '' };
                         updatePriceInfoInCalculator();
                         resolve(currentSettings); // Resolve with defaults, don't block app
                     };
                 });
             } catch (error) {
                 console.error("Load settings store access error:", error);
                 // Fallback to defaults on error
                 currentSettings = { goldPrice: 0, silverPrice: 0, zakatDueDatePref: '' };
                 updatePriceInfoInCalculator();
                 return Promise.resolve(currentSettings); // Return default settings
             }
         }


        // --- Calculation Logic (REVISED) ---
async function checkZakatDueForPaymentReminder() {
    const reminderDiv = document.getElementById('payment-reminder');
    reminderDiv.innerHTML = '';
    reminderDiv.style.display = 'none';

    try {
        const calcStore = getStore(STORES.calculations, 'readonly');
        const calculations = (await dbRequest(calcStore.getAll())).sort((a, b) => b.year - a.year);

        if (calculations.length === 0) return;

        const latestCalc = calculations[0];
        const paymentStore = getStore(STORES.payments, 'readonly');
        const index = paymentStore.index('year_idx');
        const payments = await dbRequest(index.getAll(IDBKeyRange.only(latestCalc.year)));
        const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);

        let message = '';
        let statusType = 'info';

        if (latestCalc.isZakatDue && latestCalc.zakatAmount > 0) {
            const remaining = latestCalc.zakatAmount - totalPaid;
            if (remaining > 0) {
                message = `یاد دہانی: سال ${latestCalc.year} کی زکوٰۃ میں سے <strong>${formatCurrency(remaining)}</strong> ادا کرنا باقی ہے۔`;
                statusType = 'warning';
            } else {
                message = `سال ${latestCalc.year} کی زکوٰۃ (${formatCurrency(latestCalc.zakatAmount)}) مکمل طور پر ادا ہو چکی ہے۔`;
                statusType = 'success';
            }
        } else {
            message = `سال ${latestCalc.year} کے حساب کے مطابق زکوٰۃ واجب نہیں تھی۔`;
            statusType = 'info';
        }
        
        if (message) {
            const styles = {
                warning: { icon: 'exclamation-triangle', color: '#ffc107' },
                success: { icon: 'check-circle', color: '#28a745' },
                info:    { icon: 'info-circle', color: '#17a2b8' }
            };
            reminderDiv.innerHTML = `<i class="bi bi-${styles[statusType].icon}-fill"></i> ${message}`;
            reminderDiv.style.borderColor = styles[statusType].color;
            reminderDiv.style.display = 'block';
        }

    } catch (error) {
        console.error("Error checking payment reminder:", error);
    }
}
function calculateZakat(data, prices) {
    const { gold, silver, cash, businessGoods, receivables, liabilities } = data;
    const { goldPrice, silverPrice } = prices;

    const result = {
        inputs: data,
        prices: prices,
        goldValue: gold * goldPrice,
        silverValue: silver * silverPrice,
        nisabValue: 52.5 * silverPrice,
        totalAssets: 0,
        zakatableAssets: 0,
        isZakatDue: false,
        zakatAmount: 0,
        message: ''
    };

    if (silverPrice <= 0) {
        result.message = "چاندی کی قیمت سیٹنگز میں درکار ہے۔ نصاب کا تعین نہیں کیا جا سکتا۔";
        return result;
    }
    if (gold > 0 && goldPrice <= 0) {
        result.message = "سونا موجود ہے، لہذا सोने की क़ीमत सेटिंग्स में दरकार है।";
        return result;
    }
    
    const totalValueAllAssets = result.goldValue + result.silverValue + cash + businessGoods + receivables;
    result.totalAssets = totalValueAllAssets;

    let meetsNisab = false;

    if (gold > 0 && silver === 0 && cash === 0 && businessGoods === 0 && receivables === 0) {
        if (gold >= 7.5) {
            meetsNisab = true;
            result.message = `نصاب پورا ہے (صرف سونا 7.5 تولے سے زیادہ ہے)۔`;
        } else {
            result.message = `نصاب پورا نہیں ہے (سونا 7.5 تولے سے کم ہے)۔`;
        }
    } 
    else if (silver > 0 && gold === 0 && cash === 0 && businessGoods === 0 && receivables === 0) {
        if (silver >= 52.5) {
            meetsNisab = true;
            result.message = `نصاب پورا ہے (صرف چاندی 52.5 تولے سے زیادہ ہے)۔`;
        } else {
            result.message = `نصاب پورا نہیں ہے (چاندی 52.5 تولے سے کم ہے)۔`;
        }
    } 
    else {
        if (totalValueAllAssets >= result.nisabValue) {
            meetsNisab = true;
            result.message = `نصاب پورا ہے (کل مالیت چاندی کے نصاب ${formatCurrency(result.nisabValue)} سے زیادہ ہے)۔`;
        } else {
            result.message = `نصاب پورا نہیں ہے (کل مالیت چاندی کے نصاب ${formatCurrency(result.nisabValue)} سے کم ہے)۔`;
        }
    }

    if (meetsNisab) {
        const netAssets = totalValueAllAssets - liabilities;
        result.zakatableAssets = Math.max(0, netAssets);

        if (result.zakatableAssets > 0) {
            result.isZakatDue = true;
            result.zakatAmount = result.zakatableAssets * 0.025;
        } else {
            result.isZakatDue = false;
            result.zakatAmount = 0;
            result.message += " تاہم، واجب الادا قرضے منہا کرنے کے بعد قابلِ زکوٰۃ رقم صفر ہے، لہٰذا زکوٰۃ واجب نہیں۔";
        }
    } else {
        result.isZakatDue = false;
        result.zakatAmount = 0;
        result.zakatableAssets = Math.max(0, totalValueAllAssets - liabilities);
    }

    appState.currentCalculationResult = {
        year: data.year,
        ...data,
        goldPrice: prices.goldPrice,
        silverPrice: prices.silverPrice,
        totalAssets: result.totalAssets,
        nisabValue: result.nisabValue,
        zakatableAssets: result.zakatableAssets,
        isZakatDue: result.isZakatDue,
        zakatAmount: result.zakatAmount,
        calculationDate: new Date().toISOString()
    };
    
    return result;
}
        // --- UI Update Functions ---

         function displayCalculationResult(result) {
             const resultArea = document.getElementById('zakat-result');
             const resultDetails = document.getElementById('result-details');
             const zakatDueMessage = document.getElementById('zakat-due-message');
             const saveBtn = document.getElementById('save-calc-btn');
             const calcError = document.getElementById('calc-error');
             calcError.style.display = 'none'; // Hide previous errors

             document.getElementById('result-year').textContent = result.year;

             let detailsHtml = `
                 <p><strong>اثاثوں کی تفصیل:</strong></p>
                 <ul>
                     <li>سونے کی قیمت (${result.inputs.gold} تولہ @ ${formatCurrency(result.prices.goldPrice)}): ${formatCurrency(result.goldValue)}</li>
                     <li>چاندی کی قیمت (${result.inputs.silver} تولہ @ ${formatCurrency(result.prices.silverPrice)}): ${formatCurrency(result.silverValue)}</li>
                     <li>نقد رقم / بینک بیلنس: ${formatCurrency(result.inputs.cash)}</li>
                     <li>مالِ تجارت / سرمایہ کاری: ${formatCurrency(result.inputs.businessGoods)}</li>
                     <li>وصول طلب قرضے: ${formatCurrency(result.inputs.receivables)}</li>
                     <li><strong>کل مالیت (اثاثے): ${formatCurrency(result.totalValue)}</strong></li>
                     <li>واجب الادا قرضے (منہا): ${formatCurrency(result.inputs.liabilities)}</li>
                     <li><strong>کل قابلِ زکوٰۃ اثاثے (Net): ${formatCurrency(result.zakatableAssets)}</strong></li>
                 </ul>
                  <p><strong>نصاب کی تفصیل:</strong></p>
                 <ul>
                    <li>چاندی کا نصاب (قیمت): ${result.nisabSilverThresholdTolas} تولہ چاندی @ ${formatCurrency(result.prices.silverPrice)} = <strong>${formatCurrency(result.nisabSilverThresholdValue)}</strong></li>
                     <li>سونے کا نصاب (مقدار): ${result.nisabGoldThresholdTolas} تولہ</li>
                 </ul>
                 <p><em>${result.nisabMessage}</em></p>
             `;
             resultDetails.innerHTML = detailsHtml;

             zakatDueMessage.innerHTML = `<strong>${result.zakatMessage}</strong>`;
             zakatDueMessage.style.color = result.isZakatDue ? 'var(--primary-color)' : 'var(--text-color)';

             // Show save button only if a calculation was possible (necessary prices available)
             // It can be saved even if Zakat amount is zero, for record keeping.
             const necessaryPricesAvailable = !(result.message.includes("قیمت سیٹنگز میں درکار ہے"));
             saveBtn.style.display = necessaryPricesAvailable ? 'inline-block' : 'none';

             resultArea.style.display = 'block';
         }

         function updatePriceInfoInCalculator() {
            const infoDiv = document.getElementById('calc-info-prices');
             if (currentSettings && currentSettings.goldPrice > 0 && currentSettings.silverPrice > 0) {
                 infoDiv.innerHTML = `موجودہ قیمتیں: سونا: ${formatCurrency(currentSettings.goldPrice)} فی تولہ, چاندی: ${formatCurrency(currentSettings.silverPrice)} فی تولہ۔ (سیٹنگز سے تبدیل کیا جا سکتا ہے)`;
                 infoDiv.style.backgroundColor = '#d4edda'; // Success background
                 infoDiv.style.borderColor = '#c3e6cb';
                 infoDiv.classList.remove('warning');
             } else {
                 infoDiv.innerHTML = `براہ کرم پہلے 'سیٹنگز' میں سونے اور چاندی کی موجودہ قیمتیں فی تولہ درج کریں۔ حساب کتاب کے لیے یہ ضروری ہیں۔`;
                 infoDiv.style.backgroundColor = 'var(--warning-bg-color)';
                 infoDiv.style.borderColor = 'var(--warning-border-color)';
                 infoDiv.classList.add('warning');
              }
          }

        // --- Event Handlers & Saving Logic ---

        document.getElementById('zakat-form').addEventListener('submit', function(event) {
            event.preventDefault();
             const calcError = document.getElementById('calc-error');
             const calcSuccess = document.getElementById('calc-success');
             const resultArea = document.getElementById('zakat-result');
             calcSuccess.style.display = 'none';
             calcError.style.display = 'none';
             resultArea.style.display = 'none'; // Hide previous result
             currentCalculationResult = null; // Reset
             document.getElementById('save-calc-btn').style.display = 'none';

             const data = {
                 year: parseInt(document.getElementById('year').value),
                 gold: parseFloat(document.getElementById('gold').value) || 0,
                 silver: parseFloat(document.getElementById('silver').value) || 0,
                 cash: parseFloat(document.getElementById('cash').value) || 0,
                 businessGoods: parseFloat(document.getElementById('business-goods').value) || 0,
                 receivables: parseFloat(document.getElementById('receivables').value) || 0,
                 liabilities: parseFloat(document.getElementById('liabilities').value) || 0,
             };

             if (isNaN(data.year) || data.year < 1900 || data.year > 2100) {
                 calcError.textContent = "براہ کرم ایک درست سال درج کریں (مثلاً " + new Date().getFullYear() + ")۔";
                 calcError.style.display = 'block';
                 return;
            }

             // Perform calculation using current loaded settings
             const result = calculateZakat(data, currentSettings);

             // Display result or error message from calculation function
             if (result.message.includes("قیمت سیٹنگز میں درکار ہے")) {
                calcError.textContent = result.message;
                calcError.style.display = 'block';
                showTab('settings'); // Guide user
            } else {
                 displayCalculationResult(result);
             }
        });

         async function saveCalculation() {
            // Uses global `currentCalculationResult` set by `calculateZakat`
             const calcSuccess = document.getElementById('calc-success');
             const calcError = document.getElementById('calc-error');
             calcSuccess.style.display = 'none';
             calcError.style.display = 'none';

             if (!currentCalculationResult || typeof currentCalculationResult.year !== 'number') {
                displayMessage('calc-error', "محفوظ کرنے کے لیے کوئی درست حساب موجود نہیں ہے۔ پہلے حساب لگائیں۔", true);
                return;
             }

             // Add the calculation date just before saving
             currentCalculationResult.calculationDate = new Date().toISOString();

             try {
                const existingCalc = await getCalculation(currentCalculationResult.year);
                if (existingCalc) {
                     const overwrite = confirm(`سال ${currentCalculationResult.year} کا حساب پہلے سے موجود ہے۔ کیا آپ اسے اوور رائٹ کرنا چاہتے ہیں؟`);
                     if (!overwrite) {
                         displayMessage('calc-error', "محفوظ کرنے کا عمل منسوخ کر دیا گیا۔", false); // Use non-error style
                         return;
                     }
                 }

                 const message = await saveCalculationToDB(currentCalculationResult);
                 displayMessage('calc-success', message, false);
                 currentCalculationResult = null; // Clear after successful save
                 document.getElementById('save-calc-btn').style.display = 'none'; // Hide button
                 // Refresh related views
                 if (document.getElementById('history').classList.contains('active')) renderCalculationHistory();
                 if (document.getElementById('reports').classList.contains('active')) { populateReportYearFilter(); generateReport(); }
                 if (document.getElementById('payments').classList.contains('active')) checkZakatDueForPaymentReminder();
                 checkAndDisplayLastCalculationReminder(); // Update main reminder
             } catch (error) {
                 displayMessage('calc-error', 'خرابی: ' + error, true);
             }
         }

        document.getElementById('settings-form').addEventListener('submit', async function(event) {
             event.preventDefault();
             const successDiv = document.getElementById('settings-success');
             const errorDiv = document.getElementById('settings-error');
             successDiv.style.display = 'none';
             errorDiv.style.display = 'none';

             const goldPrice = parseFloat(document.getElementById('gold-price').value);
             const silverPrice = parseFloat(document.getElementById('silver-price').value);
             const zakatDueDatePref = document.getElementById('zakat-due-date-pref').value.trim();


             if (isNaN(goldPrice) || isNaN(silverPrice) || goldPrice < 0 || silverPrice < 0) {
                 displayMessage('settings-error', "براہ کرم سونے اور چاندی کی درست مثبت قیمتیں درج کریں۔", true);
                 return;
             }
            // Price validation specifically for calculation needs
             if (silverPrice <= 0) {
                 displayMessage('settings-error', "چاندی کی قیمت صفر یا منفی نہیں ہو سکتی، یہ مخلوط اثاثوں کے نصاب کے لیے ضروری ہے۔", true);
                 return;
             }


             try {
                 const message = await saveSettings(goldPrice, silverPrice, zakatDueDatePref);
                 displayMessage('settings-success', message, false);
             } catch (error) {
                 displayMessage('settings-error', 'خرابی: ' + error, true);
             }
         });

        // --- Rendering Functions (History, Payments, Reports) ---
        // (These functions remain largely the same as before, but need to display the revised calculation data correctly)

         async function renderCalculationHistory() {
            const historyList = document.getElementById('history-list');
             historyList.innerHTML = '<p>لوڈ ہو رہا ہے...</p>';

            try {
                const calculations = await getAllCalculations(); // Sorted desc by year

                if (!calculations || calculations.length === 0) {
                     historyList.innerHTML = '<p>کوئی حسابی ریکارڈ موجود نہیں ہے۔ \'کیلکولیٹر\' ٹیب میں حساب لگائیں اور محفوظ کریں۔</p>';
                     return;
                 }

                let historyHtml = '';
                calculations.forEach(calc => {
                     // Use ?. optional chaining for potentially missing dates in older data
                    const calcDateStr = calc.calculationDate ? new Date(calc.calculationDate).toLocaleDateString('ur-PK', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';
                    historyHtml += `
                        <div class="year-section">
                             <h3>سال: ${calc.year}</h3>
                             <p><strong>حساب کی تاریخ:</strong> ${calcDateStr}</p>
                             <table>
                                 <thead>
                                     <tr><th>آئٹم</th><th>مقدار/قیمت</th></tr>
                                 </thead>
                                 <tbody>
                                     <tr><td>سونا</td><td>${calc.goldTolas} تولہ (@ ${formatCurrency(calc.goldPrice)} = ${formatCurrency(calc.goldTolas * calc.goldPrice)})</td></tr>
                                     <tr><td>چاندی</td><td>${calc.silverTolas} تولہ (@ ${formatCurrency(calc.silverPrice)} = ${formatCurrency(calc.silverTolas * calc.silverPrice)})</td></tr>
                                     <tr><td>نقد رقم / بینک بیلنس</td><td>${formatCurrency(calc.cash)}</td></tr>
                                     <tr><td>مالِ تجارت / سرمایہ کاری</td><td>${formatCurrency(calc.businessGoods)}</td></tr>
                                     <tr><td>وصول طلب قرضے</td><td>${formatCurrency(calc.receivables)}</td></tr>
                                     <tr><td><strong>کل مالیت (اثاثے)</strong></td><td><strong>${formatCurrency(calc.totalValue)}</strong></td></tr>
                                      <tr><td>واجب الادا قرضے (منہا)</td><td>${formatCurrency(calc.liabilities)}</td></tr>
                                     <tr><td><strong>کل قابلِ زکوٰۃ اثاثے (Net)</strong></td><td><strong>${formatCurrency(calc.zakatableAssets)}</strong></td></tr>
                                      <tr><td>نصاب (چاندی کی قیمت)</td><td>${formatCurrency(calc.nisabValue)}</td></tr>
                                      <tr><td><strong>نصاب پورا ہوا؟</strong></td><td><strong>${calc.isNisabMet ? 'ہاں' : 'نہیں'}</strong></td></tr>
                                     <tr><td><strong>زکوٰۃ واجب تھی؟</strong></td><td><strong>${calc.isZakatDue ? 'ہاں' : 'نہیں'}</strong></td></tr>
                                     <tr><td><strong>واجب الادا زکوٰۃ</strong></td><td><strong>${formatCurrency(calc.zakatAmount)}</strong></td></tr>
                                 </tbody>
                             </table>
                         </div>
                     `;
                 });
                 historyList.innerHTML = historyHtml;
             } catch (error) {
                 historyList.innerHTML = `<p class="error-message">تاریخ لوڈ کرنے میں خرابی: ${error}</p>`;
             }
         }

        async function generateReport() {
             const selectedYear = document.getElementById('report-year-filter').value;
             const reportArea = document.getElementById('report-area');
             const reportError = document.getElementById('report-error');
             reportArea.style.display = 'none';
             reportError.style.display = 'none';

             if (!selectedYear) {
                 reportError.textContent = "رپورٹ دیکھنے کے لیے براہ کرم ایک سال منتخب کریں۔";
                 reportError.style.display = 'block';
                 return;
            }

            const year = parseInt(selectedYear);
            document.getElementById('report-year-heading').textContent = `سال ${year} کی رپورٹ`;

             try {
                 const calculation = await getCalculation(year);
                 const payments = await getPaymentsByYear(year);

                 if (!calculation) {
                     reportError.textContent = `سال ${year} کے لیے کوئی حساب کتاب کا ریکارڈ نہیں ملا۔`;
                     reportError.style.display = 'block';
                     return;
                 }

                 let totalPaid = 0;
                 payments.forEach(p => totalPaid += p.amount);

                  // Check if zakat payment was due (Nisab met AND net assets > 0)
                  const zakatPaymentRequired = calculation.isNisabMet && calculation.zakatableAssets > 0;
                  const remainingZakat = zakatPaymentRequired ? Math.max(0, calculation.zakatAmount - totalPaid) : 0;


                 // Populate summary table
                 document.getElementById('report-total-assets').textContent = formatCurrency(calculation.totalValue); // Use totalValue
                 document.getElementById('report-liabilities').textContent = formatCurrency(calculation.liabilities);
                 document.getElementById('report-zakatable-assets').textContent = formatCurrency(calculation.zakatableAssets);
                 document.getElementById('report-nisab-value').textContent = formatCurrency(calculation.nisabValue);
                 document.getElementById('report-nisab-status').textContent = calculation.isNisabMet ? 'ہاں' : 'نہیں';
                 document.getElementById('report-zakat-status').textContent = calculation.isZakatDue ? 'ہاں' : 'نہیں'; // Whether payment is required
                 document.getElementById('report-zakat-due').textContent = formatCurrency(calculation.zakatAmount);
                 document.getElementById('report-zakat-paid').textContent = formatCurrency(totalPaid);
                 document.getElementById('report-zakat-remaining').textContent = formatCurrency(remainingZakat);
                 document.getElementById('report-zakat-remaining').style.fontWeight = remainingZakat > 0 ? 'bold' : 'normal';
                document.getElementById('report-zakat-remaining').style.color = remainingZakat > 0 ? 'var(--error-color)' : 'var(--success-color)';

                 // Populate payments table (remains same)
                 const paymentsBody = document.getElementById('report-payments-body');
                 if (payments.length > 0) {
                     let paymentsHtml = '';
                     payments.forEach(p => { /* ... existing payment row generation ... */
                         paymentsHtml += `
                             <tr>
                                <td>${new Date(p.date).toLocaleDateString('ur-PK')}</td>
                                <td>${formatCurrency(p.amount)}</td>
                                <td>${p.recipient || '-'}</td>
                                <td>${p.category || '-'}</td>
                                <td>${p.notes || '-'}</td>
                             </tr>
                         `;
                     });
                     paymentsBody.innerHTML = paymentsHtml;
                 } else {
                     paymentsBody.innerHTML = `<tr><td colspan="5">اس سال کوئی ادائیگی ریکارڈ نہیں ہوئی۔</td></tr>`;
                 }

                 reportArea.style.display = 'block';

             } catch (error) {
                 reportError.textContent = `رپورٹ بنانے میں خرابی: ${error}`;
                 reportError.style.display = 'block';
             }
         }

        // --- Reminder Logic (REVISED) ---

        async function checkAndDisplayLastCalculationReminder() {
            const reminderDiv = document.getElementById('reminder-message');
             reminderDiv.style.display = 'none'; // Hide initially
             reminderDiv.className = 'info-area warning'; // Default style

            try {
                const calculations = await getAllCalculations(); // Sorted desc by year
                if (calculations.length > 0) {
                    const lastCalc = calculations[0];
                    if (!lastCalc.calculationDate) {
                         console.log("Last calculation exists but has no calculationDate. Cannot generate reminder.");
                        return; // Cannot proceed without the date
                    }

                     const lastCalcDate = new Date(lastCalc.calculationDate);
                     const estimatedNextDueDate = new Date(lastCalcDate);
                     estimatedNextDueDate.setDate(estimatedNextDueDate.getDate() + 354); // Approx. 1 lunar year

                     const currentDate = new Date();
                     // Show reminder if current date is within 30 days before or any time after the estimated due date
                     const reminderThresholdDate = new Date(estimatedNextDueDate);
                     reminderThresholdDate.setDate(reminderThresholdDate.getDate() - 30); // 30 days before

                     let message = `آپ کا آخری حساب برائے سال ${lastCalc.year} کو ${lastCalcDate.toLocaleDateString('ur-PK', { year: 'numeric', month: 'long', day: 'numeric' })} محفوظ کیا گیا تھا۔ `;
                     let showReminder = false;

                     if (currentDate >= reminderThresholdDate) {
                         message += `اس حساب کی بنیاد پر، آپ کی اگلی زکوٰۃ کا حساب تقریباً ${estimatedNextDueDate.toLocaleDateString('ur-PK', { month: 'long', day: 'numeric' })} کو یا اس کے بعد واجب الادا ہو سکتا ہے۔ `;
                         showReminder = true;
                     }

                     // Add user's preferred date if set
                     if (currentSettings.zakatDueDatePref) {
                         message += `(آپ کی ترجیحی تاریخ: ${currentSettings.zakatDueDatePref})۔ `;
                     }

                     if (showReminder) {
                         message += "براہ کرم اپنی اصل زکوٰۃ کی سالگرہ (anniversary/hawl) کی تصدیق کریں اور وقت پر حساب لگائیں۔";
                         reminderDiv.textContent = message;
                         reminderDiv.style.display = 'block';
                     } else {
                         // Optional: Show a simple info message if not due yet
                         // reminderDiv.textContent = `Last calculation saved on ${lastCalcDate.toLocaleDateString()}.`;
                         // reminderDiv.className = 'info-area'; // Use normal info style
                         // reminderDiv.style.display = 'block';
                         reminderDiv.style.display = 'none'; // Or just hide if no reminder needed
                      }

                 } else {
                     reminderDiv.textContent = "خوش آمدید! زکوٰۃ کا حساب لگانے کے لیے کیلکولیٹر استعمال کریں اور حساب محفوظ کریں تاکہ آپ کو اگلی مقررہ تاریخ کی یاد دہانی کرائی جا سکے۔";
                     reminderDiv.className = 'info-area'; // Normal info style
                     reminderDiv.style.display = 'block';
                 }
            } catch (error) {
                console.error("Error checking last calculation date:", error);
                reminderDiv.textContent = "یاد دہانی لوڈ کرنے میں خرابی۔";
                 reminderDiv.style.display = 'block';
            }
        }

        async function checkZakatDueForPaymentReminder() {
             const reminderDiv = document.getElementById('payment-reminder');
             reminderDiv.style.display = 'none'; // Hide initially
             reminderDiv.className = 'info-area warning'; // Default style

             try {
                 const calculations = await getAllCalculations(); // Sorted desc
                 if (calculations.length > 0) {
                    const latestCalc = calculations[0]; // Get the latest year's calculation

                     // Check if Zakat payment was required for that year
                     const zakatPaymentRequired = latestCalc.isNisabMet && latestCalc.zakatableAssets > 0;

                     if (zakatPaymentRequired && latestCalc.zakatAmount > 0) {
                         const paymentsThisYear = await getPaymentsByYear(latestCalc.year);
                         let totalPaid = 0;
                         paymentsThisYear.forEach(p => totalPaid += p.amount);
                         const remaining = latestCalc.zakatAmount - totalPaid;

                        if (remaining > 0) {
                             reminderDiv.textContent = `یاد دہانی: سال ${latestCalc.year} کی واجب الادا زکوٰۃ (${formatCurrency(latestCalc.zakatAmount)}) میں سے ${formatCurrency(remaining)} ادا کرنا باقی ہے۔`;
                             reminderDiv.style.display = 'block';
                        } else {
                            // Paid in full or overpaid for the latest calculated year
                             reminderDiv.textContent = `سال ${latestCalc.year} کی زکوٰۃ (${formatCurrency(latestCalc.zakatAmount)}) ادا ہو چکی ہے۔ کل ادائیگی: ${formatCurrency(totalPaid)}۔`;
                             reminderDiv.className = 'info-area success'; // Use success style
                             reminderDiv.style.backgroundColor = '#d4edda';
                             reminderDiv.style.borderColor = '#c3e6cb';
                             reminderDiv.style.color = '#155724';
                             reminderDiv.style.display = 'block';
                         }
                    } else if (latestCalc.isNisabMet && latestCalc.zakatableAssets <= 0) {
                         // Nisab met but Zakat amount was zero
                        reminderDiv.textContent = `سال ${latestCalc.year} کے حساب کے مطابق نصاب پورا تھا، لیکن واجب الادا قرضوں کی وجہ سے زکوٰۃ کی رقم صفر تھی۔`;
                        reminderDiv.className = 'info-area';
                        reminderDiv.style.display = 'block';
                    } else if (!latestCalc.isNisabMet) {
                        // Nisab was not met for the latest calculated year
                        reminderDiv.textContent = `سال ${latestCalc.year} کے حساب کے مطابق نصاب پورا نہیں ہوا تھا، لہذا زکوٰۃ واجب نہیں تھی۔`;
                        reminderDiv.className = 'info-area';
                         reminderDiv.style.display = 'block';
                     }
                 }
             } catch (error) {
                console.error("Error checking payment reminder:", error);
                reminderDiv.textContent = 'ادائیگی کی یاد دہانی لوڈ کرنے میں خرابی۔';
                reminderDiv.style.display = 'block';
             }
         }

        // --- Utility Functions (Formatting, etc.) ---
         function formatCurrency(value) {
             // Basic formatting, adjust as needed
             return value ? Number(value).toLocaleString('ur-PK', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00';
         }

        function displayMessage(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = isError ? 'error-message' : 'success-message';
                element.style.display = 'block';
                // Auto-hide success/info messages after 5 seconds
                if (!isError) {
                    setTimeout(() => {
                        if (element.textContent === message) { // Avoid hiding subsequent messages
                            element.style.display = 'none';
                         }
                     }, 5000);
                 }
             }
         }

        // --- Tab Switching ---
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });
            document.querySelectorAll('nav ul li button').forEach(button => {
                button.classList.remove('active');
            });

            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.style.display = 'block';
                selectedTab.classList.add('active');
                 const selectedButtonId = `tab-${tabId.substring(0, 4)}`; // e.g., tab-calc
                 const selectedButton = document.getElementById(selectedButtonId);
                 if (selectedButton) {
                    selectedButton.classList.add('active');
                }

                 // --- Load/Refresh data for the activated tab ---
                 switch(tabId) {
                     case 'calculator':
                         // Set default year if empty
                        const currentYearInput = document.getElementById('year');
                         if (!currentYearInput.value) {
                             currentYearInput.value = new Date().getFullYear();
                         }
                        checkAndDisplayLastCalculationReminder(); // Show/update general reminder
                        break;
                    case 'history':
                        renderCalculationHistory();
                        break;
                     case 'payments':
                         populatePaymentYearFilter(); // Update dropdown first
                         renderPaymentHistory(); // Render based on (possibly new) selection
                         checkZakatDueForPaymentReminder(); // Show payment status reminder
                         break;
                     case 'reports':
                         populateReportYearFilter(); // Update dropdown first
                         generateReport(); // Generate report based on (possibly new) selection
                         break;
                    case 'settings':
                        // Ensure form reflects current loaded settings
                        loadSettings(); // Reload settings to make sure form is up-to-date
                        break;
                    case 'help':
                        // Static content, no action needed
                        break;
                 }
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await openDB();
                await loadSettings(); // Load settings first
                showTab('calculator'); // Show default tab
            } catch (error) {
                console.error('Initialization failed:', error);
                 alert('ایپلی کیشن شروع کرنے میں خرابی: ' + error + '\nبراؤزر کنسول میں مزید تفصیلات دیکھیں۔');
                 const container = document.querySelector('.container');
                 if (container) {
                     container.innerHTML = '<p class="error-message" style="text-align: center; padding: 20px;">ایپلی کیشن لوڈ کرنے میں مسئلہ پیش آیا۔ براہ کرم صفحہ ریفریش کریں یا اپنے براؤزر کی سیٹنگز چیک کریں (IndexedDB فعال ہونا ضروری ہے)۔</p>';
                }
             }
        });


        // --- Existing Functions (DB operations, Export/Import, Payment Handling) ---
        // Assume functions like savePayment, getAllPayments, deletePayment,
        // populatePaymentYearFilter, renderPaymentHistory, confirmDeletePayment,
        // exportData, importData, getCalculation, getAllCalculations, saveCalculationToDB
        // are present and correct from the previous version, unless modified above.
        // Make sure they use the updated data structures if necessary (e.g., report generation uses revised calc fields).

        // --- Placeholder for functions assumed to be correct from previous version ---
        async function savePayment(paymentData) {
             try {
                const store = await getStore(STORES.payments, 'readwrite');
                const request = store.add(paymentData);
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve('ادائیگی کامیابی سے محفوظ ہو گئی۔');
                    request.onerror = (event) => reject('ادائیگی محفوظ کرنے میں خرابی: ' + event.target.error);
                });
             } catch (error) {
                 console.error("Save payment error:", error);
                 return Promise.reject("ادائیگیوں کے سٹور تک رسائی میں خرابی۔ " + error);
            }
        }

        async function getAllPayments() {
             try {
                const store = await getStore(STORES.payments, 'readonly');
                const request = store.getAll();
                return new Promise((resolve, reject) => {
                     request.onsuccess = (event) => {
                        const sortedPayments = event.target.result.sort((a, b) => new Date(b.date) - new Date(a.date));
                        resolve(sortedPayments);
                    };
                    request.onerror = (event) => reject('تمام ادائیگیاں حاصل کرنے میں خرابی: ' + event.target.error);
                });
             } catch (error) {
                 console.error("Get all payments error:", error);
                 return Promise.reject("ادائیگیوں کے سٹور تک رسائی میں خرابی۔ " + error);
             }
        }

        async function deletePayment(paymentId) {
            try {
                const store = await getStore(STORES.payments, 'readwrite');
                const request = store.delete(paymentId);
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve('ادائیگی کامیابی سے حذف کر دی گئی۔');
                    request.onerror = (event) => reject('ادائیگی حذف کرنے میں خرابی: ' + event.target.error);
                });
            } catch (error) {
                console.error("Delete payment error:", error);
                 return Promise.reject("ادائیگیوں کے سٹور تک رسائی میں خرابی۔ " + error);
            }
        }

        async function getPaymentsByYear(year) {
            if (!year) return getAllPayments();

            try {
                const store = await getStore(STORES.payments, 'readonly');
                const index = store.index('year_idx');
                const request = index.getAll(IDBKeyRange.only(Number(year)));
                return new Promise((resolve, reject) => {
                    request.onsuccess = (event) => {
                         const sortedPayments = event.target.result.sort((a, b) => new Date(b.date) - new Date(a.date));
                         resolve(sortedPayments);
                     };
                     request.onerror = (event) => reject(`سال ${year} کی ادائیگیاں حاصل کرنے میں خرابی: ` + event.target.error);
                 });
            } catch (error) {
                console.error("Get payments by year error:", error);
                return Promise.reject("ادائیگیوں کے سٹور تک رسائی میں خرابی۔ " + error);
            }
        }

        async function populatePaymentYearFilter() {
             const filterSelect = document.getElementById('payment-history-year-filter');
             const currentVal = filterSelect.value;
             filterSelect.innerHTML = '<option value="">تمام سال</option>';

             try {
                 const calculations = await getAllCalculations();
                 const payments = await getAllPayments();
                 const years = new Set();

                 calculations.forEach(c => years.add(c.year));
                 payments.forEach(p => years.add(p.year));

                 const sortedYears = Array.from(years).sort((a, b) => b - a);

                 sortedYears.forEach(year => {
                     const option = document.createElement('option');
                     option.value = year;
                     option.textContent = year;
                     filterSelect.appendChild(option);
                 });

                 if (sortedYears.includes(parseInt(currentVal))) {
                     filterSelect.value = currentVal;
                 }

             } catch (error) {
                 console.error("Error populating payment year filter:", error);
            }
         }

        async function renderPaymentHistory() {
            const tableBody = document.getElementById('payment-history-table-body');
            const filterYear = document.getElementById('payment-history-year-filter').value;
            tableBody.innerHTML = '<tr><td colspan="7">لوڈ ہو رہا ہے...</td></tr>';

             try {
                 const payments = await getPaymentsByYear(filterYear ? parseInt(filterYear) : null);

                 if (!payments || payments.length === 0) {
                     tableBody.innerHTML = `<tr><td colspan="7">${filterYear ? `سال ${filterYear} کے لیے` : ''} کوئی ادائیگی ریکارڈ موجود نہیں ہے۔</td></tr>`;
                     return;
                 }

                 let tableHtml = '';
                 payments.forEach(p => {
                     tableHtml += `
                         <tr>
                            <td>${p.year}</td>
                             <td>${new Date(p.date).toLocaleDateString('ur-PK')}</td>
                             <td>${formatCurrency(p.amount)}</td>
                             <td>${p.recipient || '-'}</td>
                              <td>${p.category || '-'}</td>
                             <td>${p.notes || '-'}</td>
                              <td><button class="danger small" onclick="confirmDeletePayment(${p.id})">حذف کریں</button></td>
                         </tr>
                     `;
                 });
                 tableBody.innerHTML = tableHtml;
             } catch (error) {
                 tableBody.innerHTML = `<tr><td colspan="7" class="error-message">ادائیگیوں کی تاریخ لوڈ کرنے میں خرابی: ${error}</td></tr>`;
            }
        }

        async function confirmDeletePayment(paymentId) {
             if (confirm("کیا آپ واقعی اس ادائیگی کو حذف کرنا چاہتے ہیں؟ یہ عمل واپس نہیں لیا جا سکتا۔")) {
                 try {
                     const message = await deletePayment(paymentId);
                     alert(message);
                     renderPaymentHistory(); // Refresh list
                     // Also refresh payment reminder and report if relevant tab active
                     if (document.getElementById('payments').classList.contains('active')) checkZakatDueForPaymentReminder();
                     if (document.getElementById('reports').classList.contains('active')) generateReport();

                 } catch (error) {
                     alert('ادائیگی حذف کرنے میں خرابی: ' + error);
                 }
            }
        }

        async function populateReportYearFilter() {
             const filterSelect = document.getElementById('report-year-filter');
             const currentVal = filterSelect.value;
             filterSelect.innerHTML = '<option value="">سال منتخب کریں</option>';

            try {
                const calculations = await getAllCalculations();
                 if (calculations.length > 0) {
                     calculations.forEach(calc => {
                         const option = document.createElement('option');
                         option.value = calc.year;
                         option.textContent = calc.year;
                         filterSelect.appendChild(option);
                     });
                     if (calculations.map(c=>c.year).includes(parseInt(currentVal))) {
                         filterSelect.value = currentVal;
                    } else {
                        filterSelect.value = calculations[0].year; // Default to latest
                    }
                 }
            } catch (error) {
                console.error("Error populating report year filter:", error);
                document.getElementById('report-error').textContent = "رپورٹ کے سال لوڈ کرنے میں خرابی۔";
                 document.getElementById('report-error').style.display = 'block';
            }
        }

        async function exportData() {
             const statusDiv = document.getElementById('import-status');
             statusDiv.textContent = 'ڈیٹا ایکسپورٹ کیا جا رہا ہے...';
             statusDiv.className = ''; statusDiv.style.display = 'block';

             try {
                 const [settingsData, calculationsData, paymentsData] = await Promise.all([
                     (await getStore(STORES.settings, 'readonly')).getAll(),
                     (await getStore(STORES.calculations, 'readonly')).getAll(),
                     (await getStore(STORES.payments, 'readonly')).getAll()
                 ].map(p => new Promise((resolve, reject) => { p.onsuccess = () => resolve(p.result); p.onerror = (e) => reject(e.target.error); })));


                 const dataToExport = {
                     settings: settingsData,
                     calculations: calculationsData,
                     payments: paymentsData
                 };

                 const jsonString = JSON.stringify(dataToExport, null, 2);
                 const blob = new Blob([jsonString], { type: 'application/json' });
                 const url = URL.createObjectURL(blob);
                 const downloadLink = document.getElementById('download-link');
                 const filename = `zakat_data_backup_${new Date().toISOString().split('T')[0]}.json`;
                 downloadLink.href = url;
                 downloadLink.download = filename;
                 downloadLink.click();
                 URL.revokeObjectURL(url);

                 statusDiv.textContent = `ڈیٹا کامیابی سے "${filename}" میں ایکسپورٹ ہو گیا۔`;
                 statusDiv.className = 'success-message';

             } catch (error) {
                 statusDiv.textContent = `ایکسپورٹ میں خرابی: ${error}`;
                 statusDiv.className = 'error-message';
             }
         }

        async function importData() {
             const fileInput = document.getElementById('import-file');
             const statusDiv = document.getElementById('import-status');
             statusDiv.textContent = ''; statusDiv.className = ''; statusDiv.style.display = 'none';

             if (!fileInput.files || fileInput.files.length === 0) {
                 statusDiv.textContent = 'براہ کرم امپورٹ کرنے کے لیے ایک JSON فائل منتخب کریں۔'; statusDiv.className = 'error-message'; statusDiv.style.display = 'block'; return;
             }
             const file = fileInput.files[0];
             if (file.type !== 'application/json') {
                 statusDiv.textContent = 'غلط فائل کی قسم۔ براہ کرم ایک .json فائل منتخب کریں۔'; statusDiv.className = 'error-message'; statusDiv.style.display = 'block'; return;
             }
             if (!confirm("کیا آپ واقعی ڈیٹا امپورٹ کرنا چاہتے ہیں؟ موجودہ تمام ڈیٹا اوور رائٹ ہو جائے گا۔ جاری رکھنے سے پہلے موجودہ ڈیٹا کا بیک اپ (ایکسپورٹ) لیں۔")) {
                 statusDiv.textContent = 'امپورٹ منسوخ کر دیا گیا۔'; statusDiv.style.display = 'block'; fileInput.value = ''; return;
             }

             statusDiv.textContent = 'ڈیٹا امپورٹ کیا جا رہا ہے...'; statusDiv.style.display = 'block';
             const reader = new FileReader();

             reader.onload = async (event) => {
                 try {
                     const importedData = JSON.parse(event.target.result);
                     if (!importedData || typeof importedData !== 'object' || !importedData.settings || !importedData.calculations || !importedData.payments) {
                         throw new Error("درآمد شدہ فائل کی ساخت درست نہیں ہے۔");
                     }

                     const tx = db.transaction([STORES.settings, STORES.calculations, STORES.payments], 'readwrite');
                     const stores = {
                         settings: tx.objectStore(STORES.settings),
                         calculations: tx.objectStore(STORES.calculations),
                         payments: tx.objectStore(STORES.payments)
                     };

                     // Clear existing data
                     await Promise.all(Object.values(stores).map(store =>
                         new Promise((resolve, reject) => {
                             const req = store.clear();
                             req.onsuccess = resolve;
                             req.onerror = (e) => reject(`اسٹور ${store.name} صاف کرنے میں خرابی: ${e.target.error}`);
                         })
                     ));

                     // Add imported data
                     await Promise.all([
                         ...importedData.settings.map(item => stores.settings.put(item)),
                         ...importedData.calculations.map(item => stores.calculations.put(item)),
                         ...importedData.payments.map(item => stores.payments.put(item)) // Use put for payments too, handles potential duplicates if structure changed, though unlikely with autoIncrement
                     ].map(p => new Promise((resolve, reject) => { p.onsuccess = resolve; p.onerror = (e) => reject(e.target.error); })));


                     await new Promise((resolve, reject) => { tx.oncomplete = resolve; tx.onerror = (e) => reject("ڈیٹا امپورٹ ٹرانزیکشن میں خرابی: " + e.target.error); });

                     statusDiv.textContent = 'ڈیٹا کامیابی سے امپورٹ ہو گیا۔ ایپ دوبارہ لوڈ کی جا رہی ہے۔';
                     statusDiv.className = 'success-message';
                     setTimeout(() => window.location.reload(), 2000);

                 } catch (error) {
                     console.error("Import error:", error);
                     statusDiv.textContent = `امپورٹ میں خرابی: ${error.message || error}`;
                     statusDiv.className = 'error-message';
                 } finally {
                     fileInput.value = '';
                 }
             };
             reader.onerror = () => { statusDiv.textContent = 'فائل پڑھنے میں خرابی۔'; statusDiv.className = 'error-message'; statusDiv.style.display = 'block'; fileInput.value = ''; };
             reader.readAsText(file);
         }

        // --- Helper DB Functions ---
        async function getCalculation(year) {
             try {
                const store = await getStore(STORES.calculations, 'readonly');
                const request = store.get(Number(year));
                 return new Promise((resolve, reject) => {
                     request.onsuccess = (event) => resolve(event.target.result);
                     request.onerror = (event) => reject('حساب حاصل کرنے میں خرابی: ' + event.target.error);
                 });
             } catch (error) { return Promise.reject("حساب کتاب کے سٹور تک رسائی میں خرابی۔ " + error); }
        }

        async function getAllCalculations() {
             try {
                const store = await getStore(STORES.calculations, 'readonly');
                const request = store.getAll();
                 return new Promise((resolve, reject) => {
                    request.onsuccess = (event) => resolve(event.target.result.sort((a, b) => b.year - a.year));
                    request.onerror = (event) => reject('تمام حسابات حاصل کرنے میں خرابی: ' + event.target.error);
                });
             } catch (error) { return Promise.reject("حساب کتاب کے سٹور تک رسائی میں خرابی۔ " + error); }
        }

        async function saveCalculationToDB(calculationData) {
             if (!calculationData || typeof calculationData.year !== 'number') {
                return Promise.reject("محفوظ کرنے کے لیے حساب کا درست ڈیٹا درکار ہے۔");
             }
            try {
                const store = await getStore(STORES.calculations, 'readwrite');
                const request = store.put(calculationData); // put adds or updates
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => resolve('حساب کامیابی سے محفوظ ہو گیا۔');
                    request.onerror = (event) => reject('حساب محفوظ کرنے میں خرابی: ' + event.target.error);
                });
             } catch (error) { return Promise.reject("حساب کتاب کے سٹور تک رسائی میں خرابی۔ " + error); }
        }


        // --- End of Script ---
    </script>

</body>
</html>