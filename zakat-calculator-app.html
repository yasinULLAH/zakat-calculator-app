<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>زکٰوۃ کیلکولیٹر اور مینجمنٹ</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #27ae60;
            --accent-color: #e67e22;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Calibri, 'Noto Nastaliq Urdu', 'Jameel Noori Nastaleeq', Arial, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            border-radius: 5px 5px 0 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        h1, h2, h3, h4 {
            margin-bottom: 1rem;
        }

        .tab-container {
            margin-top: 20px;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            position: relative;
            opacity: 0.7;
            transition: all 0.3s;
        }

        .tab-button.active {
            color: var(--secondary-color);
            opacity: 1;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--secondary-color);
        }

        .tab-content {
            display: none;
            padding: 20px;
            background-color: white;
            border-radius: 0 0 5px 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        .info-box {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-right: 5px solid var(--secondary-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="number"],
        input[type="text"],
        input[type="date"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.3s;
            margin-top: 10px;
        }

        .btn-primary {
            background-color: var(--secondary-color);
        }

        .btn-primary:hover {
            background-color: #219653;
        }

        .btn-danger {
            background-color: var(--danger-color);
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-warning {
            background-color: var(--warning-color);
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .result-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f8ff;
            border-radius: 5px;
            border-right: 5px solid var(--secondary-color);
        }

        .result-success {
            color: var(--secondary-color);
            font-weight: bold;
        }

        .result-warning {
            color: var(--warning-color);
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: var(--light-color);
            font-weight: bold;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .card {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .summary-box {
            padding: 20px;
            border-radius: 5px;
            color: white;
            text-align: center;
        }

        .summary-box h3 {
            margin-bottom: 10px;
        }

        .summary-box p {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .nisab-info {
            background-color: var(--primary-color);
        }

        .asset-info {
            background-color: var(--secondary-color);
        }

        .liability-info {
            background-color: var(--warning-color);
        }

        .zakat-info {
            background-color: var(--accent-color);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: var(--secondary-color);
            color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab-button {
                width: 100%;
                text-align: center;
            }
            
            .modal-content {
                margin: 20% auto;
                width: 90%;
            }
        }

        .help-section h3 {
            margin-top: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .help-section p {
            margin-bottom: 10px;
        }

        .form-flex {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .form-flex .form-group {
            flex: 1 0 300px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .export-import {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <header>
        <h1>زکٰوۃ کیلکولیٹر اور مینجمنٹ سسٹم</h1>
    </header>

    <div class="container">
        <div class="info-box">
            <h3>زکٰوۃ کی حساب کی بنیادی معلومات:</h3>
            <ul>
                <li>زکٰوۃ 2.5% کی شرح سے واجب ہوتی ہے اگر:</li>
                <li>1. اگر آپ کے پاس صرف سونا ہے اور وہ 7.5 تولے یا اس سے زیادہ ہے۔</li>
                <li>2. اگر آپ کے پاس صرف چاندی ہے اور وہ 52.5 تولے یا اس سے زیادہ ہے۔</li>
                <li>3. یا، آپ کی کل دولت (سونا، چاندی، نقد، تجارتی اموال یا ان میں سے کوئی دو یا زیادہ، یا سونا یا چاندی کے علاوہ کوئی ایک) موجودہ چاندی کی قیمت کا استعمال کرتے ہوئے 52.5 تولے چاندی کی قیمت کے برابر یا اس سے زیادہ ہے۔</li>
                <li>اگر زکٰوۃ واجب ہے، تو کل اہل دولت کا 2.5% حساب کیا جاتا ہے۔</li>
            </ul>
        </div>

        <div class="tab-container">
            <div class="tabs">
                <button class="tab-button active" data-tab="calculator">زکٰوۃ کیلکولیٹر</button>
                <button class="tab-button" data-tab="management">زکٰوۃ مینجمنٹ</button>
                <button class="tab-button" data-tab="reports">رپورٹس</button>
                <button class="tab-button" data-tab="settings">ترتیبات</button>
                <button class="tab-button" data-tab="help">مدد</button>
            </div>

            <!-- Calculator Tab -->
            <div id="calculator" class="tab-content active">
                <h2>زکٰوۃ کیلکولیٹر</h2>
                <p>اپنی دولت اور قرض کی تفصیلات درج کریں تاکہ آپ کی زکٰوۃ کا حساب کیا جا سکے۔</p>
                
                <form id="zakatCalculatorForm" class="form-flex">
                    <div class="form-group">
                        <label for="gold">سونا (تولے میں):</label>
                        <input type="number" id="gold" min="0" step="0.1" placeholder="مثال: 5.5">
                    </div>
                    
                    <div class="form-group">
                        <label for="silver">چاندی (تولے میں):</label>
                        <input type="number" id="silver" min="0" step="0.1" placeholder="مثال: 60">
                    </div>
                    
                    <div class="form-group">
                        <label for="cash">نقد رقم / بینک بیلنس (روپے میں):</label>
                        <input type="number" id="cash" min="0" placeholder="مثال: 100000">
                    </div>
                    
                    <div class="form-group">
                        <label for="business">تجارتی اموال اور سرمایہ کاری (روپے میں):</label>
                        <input type="number" id="business" min="0" placeholder="مثال: 200000">
                    </div>
                    
                    <div class="form-group">
                        <label for="receivables">وصولی (دیے گئے قرض) (روپے میں):</label>
                        <input type="number" id="receivables" min="0" placeholder="مثال: 50000">
                    </div>
                    
                    <div class="form-group">
                        <label for="liabilities">واجبات (قرض) (روپے میں):</label>
                        <input type="number" id="liabilities" min="0" placeholder="مثال: 75000">
                    </div>
                    
                    <div class="form-group" style="flex-basis: 100%;">
                        <label for="zakatDate">زکٰوۃ کی تاریخ:</label>
                        <input type="date" id="zakatDate">
                    </div>
                    
                    <div class="form-group" style="flex-basis: 100%;">
                        <button type="button" id="calculateZakat" class="btn btn-primary">زکٰوۃ کا حساب کریں</button>
                    </div>
                </form>
                
                <div id="zakatResult" class="result-container hidden">
                    <!-- Results will be displayed here -->
                </div>
                
                <div id="saveCalculationContainer" class="hidden">
                    <h3>حساب محفوظ کریں</h3>
                    <div class="form-group">
                        <label for="calculationNotes">نوٹس (اختیاری):</label>
                        <textarea id="calculationNotes" rows="3" placeholder="کوئی نوٹس شامل کریں..."></textarea>
                    </div>
                    <button type="button" id="saveCalculation" class="btn btn-primary">محفوظ کریں</button>
                </div>
            </div>

            <!-- Management Tab -->
            <div id="management" class="tab-content">
                <h2>زکٰوۃ مینجمنٹ</h2>
                
                <div class="card">
                    <h3>زکٰوۃ کی ادائیگی ریکارڈ کریں</h3>
                    <form id="zakatPaymentForm">
                        <div class="form-flex">
                            <div class="form-group">
                                <label for="paymentAmount">رقم (روپے میں):</label>
                                <input type="number" id="paymentAmount" min="0" required placeholder="مثال: 25000">
                            </div>
                            
                            <div class="form-group">
                                <label for="paymentDate">ادائیگی کی تاریخ:</label>
                                <input type="date" id="paymentDate" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="recipient">وصول کنندہ:</label>
                                <input type="text" id="recipient" placeholder="مثال: مسجد، خیراتی ادارہ، شخص">
                            </div>
                            
                            <div class="form-group">
                                <label for="paymentCategory">زمرہ:</label>
                                <select id="paymentCategory">
                                    <option value="فقیر">فقیر</option>
                                    <option value="مسکین">مسکین</option>
                                    <option value="عاملین">عاملین</option>
                                    <option value="مؤلفۃ القلوب">مؤلفۃ القلوب</option>
                                    <option value="رقاب">رقاب</option>
                                    <option value="غارمین">غارمین</option>
                                    <option value="فی سبیل اللہ">فی سبیل اللہ</option>
                                    <option value="ابن السبیل">ابن السبیل</option>
                                    <option value="دیگر">دیگر</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="flex-basis: 100%;">
                                <label for="paymentNotes">نوٹس (اختیاری):</label>
                                <textarea id="paymentNotes" rows="3" placeholder="اضافی تفصیلات..."></textarea>
                            </div>
                        </div>
                        
                        <button type="button" id="recordPayment" class="btn btn-primary">ادائیگی ریکارڈ کریں</button>
                    </form>
                </div>
                
                <div class="card">
                    <h3>زکٰوۃ کی ادائیگیاں</h3>
                    <div class="form-group">
                        <label for="paymentYearFilter">سال کے مطابق فلٹر کریں:</label>
                        <select id="paymentYearFilter">
                            <option value="all">تمام سال</option>
                            <!-- Years will be added dynamically -->
                        </select>
                    </div>
                    
                    <div id="paymentsTableContainer">
                        <table id="paymentsTable">
                            <thead>
                                <tr>
                                    <th>تاریخ</th>
                                    <th>رقم</th>
                                    <th>وصول کنندہ</th>
                                    <th>زمرہ</th>
                                    <th>نوٹس</th>
                                    <th>اعمال</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsTableBody">
                                <!-- Payments will be displayed here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card">
                    <h3>زکٰوۃ کے حسابات</h3>
                    <div class="form-group">
                        <label for="calculationYearFilter">سال کے مطابق فلٹر کریں:</label>
                        <select id="calculationYearFilter">
                            <option value="all">تمام سال</option>
                            <!-- Years will be added dynamically -->
                        </select>
                    </div>
                    
                    <div id="calculationsTableContainer">
                        <table id="calculationsTable">
                            <thead>
                                <tr>
                                    <th>تاریخ</th>
                                    <th>کل اثاثے</th>
                                    <th>کل واجبات</th>
                                    <th>قابل زکٰوۃ دولت</th>
                                    <th>واجب زکٰوۃ</th>
                                    <th>اعمال</th>
                                </tr>
                            </thead>
                            <tbody id="calculationsTableBody">
                                <!-- Calculations will be displayed here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports" class="tab-content">
                <h2>رپورٹس</h2>
                
                <div class="form-group">
                    <label for="reportYear">سال منتخب کریں:</label>
                    <select id="reportYear">
                        <!-- Years will be added dynamically -->
                    </select>
                </div>
                
                <div class="grid">
                    <div class="card summary-box nisab-info">
                        <h3>نصاب کی حد</h3>
                        <p id="nisabThreshold">0</p>
                    </div>
                    
                    <div class="card summary-box asset-info">
                        <h3>کل اثاثے</h3>
                        <p id="totalAssets">0</p>
                    </div>
                    
                    <div class="card summary-box liability-info">
                        <h3>کل واجبات</h3>
                        <p id="totalLiabilities">0</p>
                    </div>
                    
                    <div class="card summary-box zakat-info">
                        <h3>کل زکٰوۃ واجب</h3>
                        <p id="totalZakatDue">0</p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>زکٰوۃ کی ادائیگی کا خلاصہ</h3>
                    <div id="paymentSummaryContainer">
                        <table id="paymentSummaryTable">
                            <thead>
                                <tr>
                                    <th>زمرہ</th>
                                    <th>ادائیگیوں کی تعداد</th>
                                    <th>کل رقم</th>
                                </tr>
                            </thead>
                            <tbody id="paymentSummaryTableBody">
                                <!-- Payment summary will be displayed here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="export-import">
                    <h3>ڈیٹا برآمد/درآمد کریں</h3>
                    <p>اپنے زکٰوۃ کے ڈیٹا کو بیک اپ یا دوسرے ڈیوائس پر منتقل کرنے کے لیے، آپ اسے برآمد اور درآمد کر سکتے ہیں۔</p>
                    <div class="action-buttons">
                        <button type="button" id="exportData" class="btn btn-primary">ڈیٹا برآمد کریں</button>
                        <input type="file" id="importFileInput" style="display: none;" accept=".json">
                        <button type="button" id="importDataBtn" class="btn btn-warning">ڈیٹا درآمد کریں</button>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <h2>ترتیبات</h2>
                
                <div class="card">
                    <h3>قیمت کی ترتیبات</h3>
                    <form id="priceSettingsForm">
                        <div class="form-flex">
                            <div class="form-group">
                                <label for="goldPrice">سونے کی قیمت (فی تولہ):</label>
                                <input type="number" id="goldPrice" min="0" placeholder="مثال: 180000">
                            </div>
                            
                            <div class="form-group">
                                <label for="silverPrice">چاندی کی قیمت (فی تولہ):</label>
                                <input type="number" id="silverPrice" min="0" placeholder="مثال: 3000">
                            </div>
                        </div>
                        
                        <button type="button" id="saveSettings" class="btn btn-primary">ترتیبات محفوظ کریں</button>
                    </form>
                </div>
                
                <div class="card">
                    <h3>یاددہانی کی ترتیبات</h3>
                    <form id="reminderSettingsForm">
                        <div class="form-group">
                            <label for="zakatAnniversaryDate">آپ کی سالانہ زکٰوۃ کی تاریخ:</label>
                            <input type="date" id="zakatAnniversaryDate">
                        </div>
                        
                        <div class="form-group">
                            <label for="enableReminders">یاددہانیاں فعال کریں:</label>
                            <select id="enableReminders">
                                <option value="yes">جی ہاں</option>
                                <option value="no">نہیں</option>
                            </select>
                        </div>
                        
                        <button type="button" id="saveReminderSettings" class="btn btn-primary">ترتیبات محفوظ کریں</button>
                    </form>
                </div>
                
                <div class="card">
                    <h3>ڈیٹا مینجمنٹ</h3>
                    <p>احتیاط سے استعمال کریں: آپ اپنا سارا ڈیٹا مکمل طور پر صاف کر سکتے ہیں۔ یہ عمل ناقابل واپسی ہے!</p>
                    <button type="button" id="clearAllData" class="btn btn-danger">سارا ڈیٹا صاف کریں</button>
                </div>
            </div>

            <!-- Help Tab -->
            <div id="help" class="tab-content">
                <h2>مدد</h2>
                
                <div class="help-section">
                    <h3>زکٰوۃ کیا ہے؟</h3>
                    <p>زکٰوۃ اسلام کے پانچ بنیادی ارکان میں سے ایک ہے۔ یہ ایک مالی عبادت ہے جس میں نصاب سے زائد دولت کا 2.5% مستحق افراد کو دیا جاتا ہے۔</p>
                </div>
                
                <div class="help-section">
                    <h3>زکٰوۃ کس پر واجب ہے؟</h3>
                    <p>زکٰوۃ ہر اس مسلمان پر واجب ہے جو بالغ ہو، عقل مند ہو اور نصاب کے برابر یا اس سے زیادہ دولت کا مالک ہو۔</p>
                </div>
                
                <div class="help-section">
                    <h3>نصاب کیا ہے؟</h3>
                    <p>نصاب وہ کم از کم مقدار ہے جس کے مالک ہونے پر زکٰوۃ واجب ہوتی ہے۔ یہ درج ذیل میں سے کسی ایک کے برابر ہو سکتا ہے:</p>
                    <ul>
                        <li>7.5 تولے سونا (اگر صرف سونا ہے)</li>
                        <li>52.5 تولے چاندی (اگر صرف چاندی ہے)</li>
                        <li>52.5 تولے چاندی کی قیمت کے برابر دولت (اگر مختلف اقسام کی دولت ہے یا سونا یا چاندی کے علاوہ کوئی ایک قسم کی دولت ہے)</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h3>زکٰوۃ کس پر ادا کی جا سکتی ہے؟</h3>
                    <p>قرآن میں زکٰوۃ کے آٹھ مصارف بیان کیے گئے ہیں:</p>
                    <ul>
                        <li>فقیر: وہ لوگ جن کے پاس بنیادی ضروریات پوری کرنے کے لیے کافی دولت نہیں ہے</li>
                        <li>مسکین: وہ لوگ جو شدید غربت میں ہیں</li>
                        <li>عاملین: زکٰوۃ اکٹھا کرنے والے</li>
                        <li>مؤلفۃ القلوب: وہ لوگ جنہیں اسلام کی طرف مائل کرنا مقصود ہو</li>
                        <li>رقاب: غلامی سے آزادی</li>
                        <li>غارمین: قرض دار لوگ</li>
<li>فی سبیل اللہ: اللہ کی راہ میں</li>
                        <li>ابن السبیل: مسافر جو سفر میں پھنس گیا ہو</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h3>ایپ کے استعمال کے لیے ہدایات</h3>
                    <h4>زکٰوۃ کیلکولیٹر</h4>
                    <p>1. اپنے تمام اثاثے درج کریں (سونا، چاندی، نقد، تجارتی اموال، وصولی)</p>
                    <p>2. اپنے واجبات (قرض) درج کریں</p>
                    <p>3. "زکٰوۃ کا حساب کریں" بٹن پر کلک کریں</p>
                    <p>4. اپنے حساب کو محفوظ کرنے کے لیے "محفوظ کریں" بٹن پر کلک کریں</p>
                    
                    <h4>زکٰوۃ مینجمنٹ</h4>
                    <p>1. اپنی زکٰوۃ کی ادائیگیاں ریکارڈ کریں</p>
                    <p>2. پچھلے حسابات اور ادائیگیوں کا جائزہ لیں</p>
                    
                    <h4>رپورٹس</h4>
                    <p>1. اپنی زکٰوۃ کے حسابات اور ادائیگیوں کا خلاصہ دیکھیں</p>
                    <p>2. اپنا ڈیٹا برآمد یا درآمد کریں</p>
                    
                    <h4>ترتیبات</h4>
                    <p>1. سونے اور چاندی کی تازہ ترین قیمتیں درج کریں</p>
                    <p>2. اپنی سالانہ زکٰوۃ کی تاریخ سیٹ کریں</p>
                    <p>3. یاددہانیاں فعال یا غیر فعال کریں</p>
                </div>
                
                <div class="help-section">
                    <h3>اکثر پوچھے گئے سوالات</h3>
                    <h4>کیا زکٰوۃ صرف نقد رقم پر واجب ہے؟</h4>
                    <p>نہیں، زکٰوۃ سونے، چاندی، نقد، تجارتی اموال، مویشی اور کھیتی پر واجب ہے۔</p>
                    
                    <h4>کیا قرض کی ادائیگی کے لیے رکھی گئی رقم پر زکٰوۃ واجب ہے؟</h4>
                    <p>نہیں، قرض کی ادائیگی کے لیے مختص رقم کو کل دولت سے کم کر دیا جاتا ہے۔</p>
                    
                    <h4>کیا ذاتی استعمال کی اشیاء پر زکٰوۃ ہے؟</h4>
                    <p>نہیں، آپ کے ذاتی استعمال کی اشیاء جیسے گھر، گاڑی، کپڑے وغیرہ پر زکٰوۃ واجب نہیں ہے۔</p>
                    
                    <h4>زکٰوۃ کتنی بار ادا کرنی چاہیے؟</h4>
                    <p>زکٰوۃ سالانہ واجب ہوتی ہے، یعنی ہر قمری سال (حجری سال) کے بعد۔</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Payment Modal -->
    <div id="editPaymentModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeEditPaymentModal">&times;</span>
            <h2>ادائیگی میں ترمیم کریں</h2>
            <form id="editPaymentForm">
                <input type="hidden" id="editPaymentId">
                <div class="form-group">
                    <label for="editPaymentAmount">رقم (روپے میں):</label>
                    <input type="number" id="editPaymentAmount" min="0" required>
                </div>
                <div class="form-group">
                    <label for="editPaymentDate">ادائیگی کی تاریخ:</label>
                    <input type="date" id="editPaymentDate" required>
                </div>
                <div class="form-group">
                    <label for="editRecipient">وصول کنندہ:</label>
                    <input type="text" id="editRecipient">
                </div>
                <div class="form-group">
                    <label for="editPaymentCategory">زمرہ:</label>
                    <select id="editPaymentCategory">
                        <option value="فقیر">فقیر</option>
                        <option value="مسکین">مسکین</option>
                        <option value="عاملین">عاملین</option>
                        <option value="مؤلفۃ القلوب">مؤلفۃ القلوب</option>
                        <option value="رقاب">رقاب</option>
                        <option value="غارمین">غارمین</option>
                        <option value="فی سبیل اللہ">فی سبیل اللہ</option>
                        <option value="ابن السبیل">ابن السبیل</option>
                        <option value="دیگر">دیگر</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editPaymentNotes">نوٹس (اختیاری):</label>
                    <textarea id="editPaymentNotes" rows="3"></textarea>
                </div>
                <button type="button" id="updatePayment" class="btn btn-primary">اپ ڈیٹ کریں</button>
            </form>
        </div>
    </div>

    <!-- View Calculation Details Modal -->
    <div id="calculationDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeCalculationDetailsModal">&times;</span>
            <h2>زکٰوۃ کا حساب تفصیل</h2>
            <div id="calculationDetailsContent">
                <!-- Calculation details will be displayed here -->
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // IndexedDB Setup
        let db;
        const DB_NAME = 'ZakatManagerDB';
        const DB_VERSION = 1;
        const STORES = {
            SETTINGS: 'settings',
            CALCULATIONS: 'calculations',
            PAYMENTS: 'payments'
        };

        // Initialize database
        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Settings store
                    if (!db.objectStoreNames.contains(STORES.SETTINGS)) {
                        db.createObjectStore(STORES.SETTINGS, { keyPath: 'id' });
                    }
                    
                    // Calculations store
                    if (!db.objectStoreNames.contains(STORES.CALCULATIONS)) {
                        const calculationsStore = db.createObjectStore(STORES.CALCULATIONS, { keyPath: 'id', autoIncrement: true });
                        calculationsStore.createIndex('date', 'date', { unique: false });
                        calculationsStore.createIndex('year', 'year', { unique: false });
                    }
                    
                    // Payments store
                    if (!db.objectStoreNames.contains(STORES.PAYMENTS)) {
                        const paymentsStore = db.createObjectStore(STORES.PAYMENTS, { keyPath: 'id', autoIncrement: true });
                        paymentsStore.createIndex('date', 'date', { unique: false });
                        paymentsStore.createIndex('year', 'year', { unique: false });
                        paymentsStore.createIndex('category', 'category', { unique: false });
                    }
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    
                    // Initialize default settings if needed
                    initDefaultSettings().then(() => {
                        resolve(db);
                    });
                };
                
                request.onerror = (event) => {
                    console.error('Database error:', event.target.error);
                    reject(event.target.error);
                };
            });
        };

        // Initialize default settings
        const initDefaultSettings = () => {
            return new Promise((resolve) => {
                const transaction = db.transaction([STORES.SETTINGS], 'readwrite');
                const store = transaction.objectStore(STORES.SETTINGS);
                
                // Check if settings already exist
                const request = store.get('priceSettings');
                
                request.onsuccess = (event) => {
                    if (!event.target.result) {
                        // Set default price settings
                        store.put({
                            id: 'priceSettings',
                            goldPrice: 180000,
                            silverPrice: 3000,
                            lastUpdated: new Date().toISOString()
                        });
                    }
                    
                    // Check if reminder settings exist
                    const reminderRequest = store.get('reminderSettings');
                    
                    reminderRequest.onsuccess = (event) => {
                        if (!event.target.result) {
                            // Set default reminder settings
                            store.put({
                                id: 'reminderSettings',
                                zakatAnniversaryDate: '',
                                enableReminders: 'yes',
                                lastUpdated: new Date().toISOString()
                            });
                        }
                        resolve();
                    };
                };
            });
        };

        // Utility Functions
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('ur-PK', { 
                style: 'currency', 
                currency: 'PKR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        };

        const formatDate = (dateString) => {
            const date = new Date(dateString);
            return new Intl.DateTimeFormat('ur-PK').format(date);
        };

        const extractYear = (dateString) => {
            return new Date(dateString).getFullYear();
        };

        const showNotification = (message, duration = 3000) => {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.opacity = '1';
            }, 10);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 300);
            }, duration);
        };

        // Get settings from DB
        const getSettings = async (settingId) => {
            return new Promise((resolve) => {
                const transaction = db.transaction([STORES.SETTINGS], 'readonly');
                const store = transaction.objectStore(STORES.SETTINGS);
                const request = store.get(settingId);
                
                request.onsuccess = () => {
                    resolve(request.result);
                };
                
                request.onerror = () => {
                    console.error(`Error getting ${settingId}`);
                    resolve(null);
                };
            });
        };

        // Tab functionality
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Remove active class from all tab buttons
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Show selected tab content and mark button as active
                const tabId = button.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
                button.classList.add('active');
                
                // Load tab-specific data
                if (tabId === 'management') {
                    loadPayments();
                    loadCalculations();
                    updateYearFilters();
                } else if (tabId === 'reports') {
                    loadReportYears();
                    updateReportSummary();
                } else if (tabId === 'settings') {
                    loadSettings();
                }
            });
        });

        // Zakat Calculator
        document.getElementById('calculateZakat').addEventListener('click', async () => {
            const gold = parseFloat(document.getElementById('gold').value) || 0;
            const silver = parseFloat(document.getElementById('silver').value) || 0;
            const cash = parseFloat(document.getElementById('cash').value) || 0;
            const business = parseFloat(document.getElementById('business').value) || 0;
            const receivables = parseFloat(document.getElementById('receivables').value) || 0;
            const liabilities = parseFloat(document.getElementById('liabilities').value) || 0;
            const zakatDate = document.getElementById('zakatDate').value || new Date().toISOString().slice(0, 10);
            
            // Get current prices
            const priceSettings = await getSettings('priceSettings');
            const goldPrice = priceSettings?.goldPrice || 180000;
            const silverPrice = priceSettings?.silverPrice || 3000;
            
            // Calculate total assets value
            const goldValue = gold * goldPrice;
            const silverValue = silver * silverPrice;
            const totalAssets = goldValue + silverValue + cash + business + receivables;
            
            // Calculate net wealth
            const netWealth = totalAssets - liabilities > 0 ? totalAssets - liabilities : 0;
            
            // Calculate nisab thresholds
            const goldNisab = 7.5 * goldPrice;
            const silverNisab = 52.5 * silverPrice;
            
            // Determine if zakat is due based on the rules
            let isZakatDue = false;
            let zakatAmount = 0;
            let nisabReason = '';
            
            if (gold > 0 && silver === 0 && cash === 0 && business === 0 && receivables === 0) {
                // Only gold
                if (gold >= 7.5) {
                    isZakatDue = true;
                    zakatAmount = netWealth * 0.025;
                    nisabReason = `سونا 7.5 تولے یا اس سے زیادہ ہے`;
                }
            } else if (silver > 0 && gold === 0 && cash === 0 && business === 0 && receivables === 0) {
                // Only silver
                if (silver >= 52.5) {
                    isZakatDue = true;
                    zakatAmount = netWealth * 0.025;
                    nisabReason = `چاندی 52.5 تولے یا اس سے زیادہ ہے`;
                }
            } else {
                // Combination of assets or one asset type other than gold or silver alone
                if (netWealth >= silverNisab) {
                    isZakatDue = true;
                    zakatAmount = netWealth * 0.025;
                    nisabReason = `کل دولت چاندی کے نصاب (52.5 تولے چاندی) سے زیادہ ہے`;
                }
            }
            
            // Display result
            const resultContainer = document.getElementById('zakatResult');
            resultContainer.classList.remove('hidden');
            
            if (isZakatDue) {
                resultContainer.innerHTML = `
                    <h3 class="result-success">زکٰوۃ واجب ہے</h3>
                    <p><strong>نصاب:</strong> ${nisabReason}</p>
                    <p><strong>کل اثاثے:</strong> ${formatCurrency(totalAssets)}</p>
                    <p><strong>کل واجبات:</strong> ${formatCurrency(liabilities)}</p>
                    <p><strong>قابل زکٰوۃ دولت:</strong> ${formatCurrency(netWealth)}</p>
                    <p><strong>واجب زکٰوۃ (2.5%):</strong> ${formatCurrency(zakatAmount)}</p>
                `;
                
                // Show save calculation option
                document.getElementById('saveCalculationContainer').classList.remove('hidden');
                
                // Store calculation temporarily
                window.currentCalculation = {
                    date: zakatDate,
                    gold: gold,
                    silver: silver,
                    cash: cash,
                    business: business,
                    receivables: receivables,
                    liabilities: liabilities,
                    goldPrice: goldPrice,
                    silverPrice: silverPrice,
                    totalAssets: totalAssets,
                    netWealth: netWealth,
                    zakatAmount: zakatAmount,
                    isZakatDue: isZakatDue,
                    nisabReason: nisabReason,
                    year: extractYear(zakatDate)
                };
            } else {
                resultContainer.innerHTML = `
                    <h3 class="result-warning">زکٰوۃ واجب نہیں ہے</h3>
                    <p>آپ کی کل دولت نصاب سے کم ہے</p>
                    <p><strong>سونے کا نصاب:</strong> ${formatCurrency(goldNisab)} (7.5 تولے)</p>
                    <p><strong>چاندی کا نصاب:</strong> ${formatCurrency(silverNisab)} (52.5 تولے)</p>
                    <p><strong>کل اثاثے:</strong> ${formatCurrency(totalAssets)}</p>
                    <p><strong>کل واجبات:</strong> ${formatCurrency(liabilities)}</p>
                    <p><strong>قابل زکٰوۃ دولت:</strong> ${formatCurrency(netWealth)}</p>
                `;
                
                // Hide save calculation option
                document.getElementById('saveCalculationContainer').classList.add('hidden');
            }
        });

        // Save calculation
        document.getElementById('saveCalculation').addEventListener('click', () => {
            if (!window.currentCalculation) return;
            
            const notes = document.getElementById('calculationNotes').value;
            const calculationData = {
                ...window.currentCalculation,
                notes: notes,
                timestamp: new Date().toISOString()
            };
            
            const transaction = db.transaction([STORES.CALCULATIONS], 'readwrite');
            const store = transaction.objectStore(STORES.CALCULATIONS);
            const request = store.add(calculationData);
            
            request.onsuccess = () => {
                showNotification('حساب کامیابی سے محفوظ کر دیا گیا ہے');
                document.getElementById('calculationNotes').value = '';
                document.getElementById('saveCalculationContainer').classList.add('hidden');
            };
            
            request.onerror = () => {
                showNotification('حساب محفوظ کرنے میں خرابی');
                console.error('Error saving calculation:', request.error);
            };
        });

        // Record payment
        document.getElementById('recordPayment').addEventListener('click', () => {
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const date = document.getElementById('paymentDate').value;
            const recipient = document.getElementById('recipient').value;
            const category = document.getElementById('paymentCategory').value;
            const notes = document.getElementById('paymentNotes').value;
            
            if (!amount || !date) {
                showNotification('براہ کرم رقم اور تاریخ درج کریں');
                return;
            }
            
            const paymentData = {
                amount: amount,
                date: date,
                recipient: recipient,
                category: category,
                notes: notes,
                timestamp: new Date().toISOString(),
                year: extractYear(date)
            };
            
            const transaction = db.transaction([STORES.PAYMENTS], 'readwrite');
            const store = transaction.objectStore(STORES.PAYMENTS);
            const request = store.add(paymentData);
            
            request.onsuccess = () => {
                showNotification('ادائیگی کامیابی سے ریکارڈ کر دی گئی ہے');
                document.getElementById('paymentAmount').value = '';
                document.getElementById('paymentDate').value = '';
                document.getElementById('recipient').value = '';
                document.getElementById('paymentNotes').value = '';
                loadPayments();
                updateReportSummary();
            };
            
            request.onerror = () => {
                showNotification('ادائیگی ریکارڈ کرنے میں خرابی');
                console.error('Error recording payment:', request.error);
            };
        });

        // Load payments
        const loadPayments = () => {
            const transaction = db.transaction([STORES.PAYMENTS], 'readonly');
            const store = transaction.objectStore(STORES.PAYMENTS);
            const yearFilter = document.getElementById('paymentYearFilter').value;
            
            let request;
            if (yearFilter === 'all') {
                request = store.index('date').openCursor(null, 'prev');
            } else {
                const year = parseInt(yearFilter);
                request = store.index('year').openCursor(IDBKeyRange.only(year), 'prev');
            }
            
            const tableBody = document.getElementById('paymentsTableBody');
            tableBody.innerHTML = '';
            
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    const payment = cursor.value;
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${formatDate(payment.date)}</td>
                        <td>${formatCurrency(payment.amount)}</td>
                        <td>${payment.recipient || '-'}</td>
                        <td>${payment.category}</td>
                        <td>${payment.notes || '-'}</td>
                        <td>
                            <button class="btn btn-warning btn-sm edit-payment" data-id="${payment.id}">ترمیم</button>
                            <button class="btn btn-danger btn-sm delete-payment" data-id="${payment.id}">حذف</button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                    cursor.continue();
                }
            };
            
            request.onerror = () => {
                console.error('Error loading payments:', request.error);
            };
        };

        // Load calculations
        const loadCalculations = () => {
            const transaction = db.transaction([STORES.CALCULATIONS], 'readonly');
            const store = transaction.objectStore(STORES.CALCULATIONS);
            const yearFilter = document.getElementById('calculationYearFilter').value;
            
            let request;
            if (yearFilter === 'all') {
                request = store.index('date').openCursor(null, 'prev');
            } else {
                const year = parseInt(yearFilter);
                request = store.index('year').openCursor(IDBKeyRange.only(year), 'prev');
            }
            
            const tableBody = document.getElementById('calculationsTableBody');
            tableBody.innerHTML = '';
            
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    const calculation = cursor.value;
                    if (calculation.isZakatDue) {
                        const row = document.createElement('tr');
                        
                        row.innerHTML = `
                            <td>${formatDate(calculation.date)}</td>
                            <td>${formatCurrency(calculation.totalAssets)}</td>
                            <td>${formatCurrency(calculation.liabilities)}</td>
                            <td>${formatCurrency(calculation.netWealth)}</td>
                            <td>${formatCurrency(calculation.zakatAmount)}</td>
                            <td>
                                <button class="btn btn-primary btn-sm view-calculation" data-id="${calculation.id}">تفصیلات</button>
                                <button class="btn btn-danger btn-sm delete-calculation" data-id="${calculation.id}">حذف</button>
                            </td>
                        `;
                        
                        tableBody.appendChild(row);
                    }
                    cursor.continue();
                }
            };
            
            request.onerror = () => {
                console.error('Error loading calculations:', request.error);
            };
        };

        // Update year filters
        const updateYearFilters = async () => {
            // Get unique years from payments
            const paymentYears = await getUniqueYears(STORES.PAYMENTS);
            const calculationYears = await getUniqueYears(STORES.CALCULATIONS);
            
            // Combine and sort years
            const years = [...new Set([...paymentYears, ...calculationYears])].sort((a, b) => b - a);
            
            // Update payment year filter
            const paymentYearFilter = document.getElementById('paymentYearFilter');
            const paymentCurrentValue = paymentYearFilter.value;
            paymentYearFilter.innerHTML = '<option value="all">تمام سال</option>';
            
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                paymentYearFilter.appendChild(option);
            });
            
            paymentYearFilter.value = paymentCurrentValue || 'all';
            
            // Update calculation year filter
            const calculationYearFilter = document.getElementById('calculationYearFilter');
            const calculationCurrentValue = calculationYearFilter.value;
            calculationYearFilter.innerHTML = '<option value="all">تمام سال</option>';
            
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                calculationYearFilter.appendChild(option);
            });
            
            calculationYearFilter.value = calculationCurrentValue || 'all';
        };

        // Get unique years from a store
        const getUniqueYears = (storeName) => {
            return new Promise((resolve) => {
                const years = new Set();
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.openCursor();
                
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        if (cursor.value.year) {
                            years.add(cursor.value.year);
                        } else if (cursor.value.date) {
                            years.add(extractYear(cursor.value.date));
                        }
                        cursor.continue();
                    } else {
                        resolve([...years]);
                    }
                };
                
                request.onerror = () => {
                    console.error(`Error getting years from ${storeName}:`, request.error);
                    resolve([]);
                };
            });
        };

        // Load years for reports
        const loadReportYears = async () => {
            const years = await getUniqueYears(STORES.CALCULATIONS);
            
            // Update report year filter
            const reportYear = document.getElementById('reportYear');
            const currentValue = reportYear.value;
            reportYear.innerHTML = '';
            
            // Add current year by default
            const currentYear = new Date().getFullYear();
            
            // Add all available years
            const allYears = [...new Set([...years, currentYear])].sort((a, b) => b - a);
            
            allYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                reportYear.appendChild(option);
            });
            
            reportYear.value = currentValue || currentYear;
        };

        // Update report summary
        const updateReportSummary = async () => {
            const selectedYear = document.getElementById('reportYear').value;
            
            // Get price settings for nisab calculation
            const priceSettings = await getSettings('priceSettings');
            const silverPrice = priceSettings?.silverPrice || 3000;
            const nisabValue = 52.5 * silverPrice;
            
            // Update nisab threshold display
            document.getElementById('nisabThreshold').textContent = formatCurrency(nisabValue);
            
            // Get calculations for the selected year
            const calculationsForYear = await getDataForYear(STORES.CALCULATIONS, selectedYear);
            
            // Get latest calculation for the year
            const latestCalculation = calculationsForYear.length > 0 
                ? calculationsForYear.sort((a, b) => new Date(b.date) - new Date(a.date))[0] 
                : null;
            
            // Update assets, liabilities and zakat due
            document.getElementById('totalAssets').textContent = latestCalculation 
                ? formatCurrency(latestCalculation.totalAssets) 
                : formatCurrency(0);
                
            document.getElementById('totalLiabilities').textContent = latestCalculation 
                ? formatCurrency(latestCalculation.liabilities) 
                : formatCurrency(0);
                
            document.getElementById('totalZakatDue').textContent = latestCalculation && latestCalculation.isZakatDue 
                ? formatCurrency(latestCalculation.zakatAmount) 
                : formatCurrency(0);
            
            // Get payments for the selected year
            const paymentsForYear = await getDataForYear(STORES.PAYMENTS, selectedYear);
            
            // Group payments by category
// Group payments by category
            const categorySummary = {};
            let totalPayments = 0;
            
            paymentsForYear.forEach(payment => {
                if (!categorySummary[payment.category]) {
                    categorySummary[payment.category] = {
                        count: 0,
                        total: 0
                    };
                }
                
                categorySummary[payment.category].count++;
                categorySummary[payment.category].total += payment.amount;
                totalPayments += payment.amount;
            });
            
            // Update payment summary table
            const summaryTableBody = document.getElementById('paymentSummaryTableBody');
            summaryTableBody.innerHTML = '';
            
            Object.keys(categorySummary).forEach(category => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${category}</td>
                    <td>${categorySummary[category].count}</td>
                    <td>${formatCurrency(categorySummary[category].total)}</td>
                `;
                summaryTableBody.appendChild(row);
            });
            
            // Add total row
            const totalRow = document.createElement('tr');
            totalRow.style.fontWeight = 'bold';
            totalRow.innerHTML = `
                <td>مجموعی</td>
                <td>${paymentsForYear.length}</td>
                <td>${formatCurrency(totalPayments)}</td>
            `;
            summaryTableBody.appendChild(totalRow);
        };

        // Get data for specific year
        const getDataForYear = (storeName, year) => {
            return new Promise((resolve) => {
                const data = [];
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                
                let request;
                if (year === 'all') {
                    request = store.openCursor();
                } else {
                    year = parseInt(year);
                    request = store.index('year').openCursor(IDBKeyRange.only(year));
                }
                
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        data.push(cursor.value);
                        cursor.continue();
                    } else {
                        resolve(data);
                    }
                };
                
                request.onerror = () => {
                    console.error(`Error getting data from ${storeName}:`, request.error);
                    resolve([]);
                };
            });
        };

        // Load settings
        const loadSettings = async () => {
            const priceSettings = await getSettings('priceSettings');
            const reminderSettings = await getSettings('reminderSettings');
            
            // Update price settings form
            document.getElementById('goldPrice').value = priceSettings?.goldPrice || '';
            document.getElementById('silverPrice').value = priceSettings?.silverPrice || '';
            
            // Update reminder settings form
            document.getElementById('zakatAnniversaryDate').value = reminderSettings?.zakatAnniversaryDate || '';
            document.getElementById('enableReminders').value = reminderSettings?.enableReminders || 'yes';
        };

        // Save price settings
        document.getElementById('saveSettings').addEventListener('click', () => {
            const goldPrice = parseFloat(document.getElementById('goldPrice').value);
            const silverPrice = parseFloat(document.getElementById('silverPrice').value);
            
            if (!goldPrice || !silverPrice) {
                showNotification('براہ کرم درست قیمتیں درج کریں');
                return;
            }
            
            const settings = {
                id: 'priceSettings',
                goldPrice: goldPrice,
                silverPrice: silverPrice,
                lastUpdated: new Date().toISOString()
            };
            
            const transaction = db.transaction([STORES.SETTINGS], 'readwrite');
            const store = transaction.objectStore(STORES.SETTINGS);
            const request = store.put(settings);
            
            request.onsuccess = () => {
                showNotification('قیمت کی ترتیبات محفوظ کر دی گئیں');
            };
            
            request.onerror = () => {
                showNotification('ترتیبات محفوظ کرنے میں خرابی');
                console.error('Error saving settings:', request.error);
            };
        });

        // Save reminder settings
        document.getElementById('saveReminderSettings').addEventListener('click', () => {
            const zakatAnniversaryDate = document.getElementById('zakatAnniversaryDate').value;
            const enableReminders = document.getElementById('enableReminders').value;
            
            const settings = {
                id: 'reminderSettings',
                zakatAnniversaryDate: zakatAnniversaryDate,
                enableReminders: enableReminders,
                lastUpdated: new Date().toISOString()
            };
            
            const transaction = db.transaction([STORES.SETTINGS], 'readwrite');
            const store = transaction.objectStore(STORES.SETTINGS);
            const request = store.put(settings);
            
            request.onsuccess = () => {
                showNotification('یاددہانی کی ترتیبات محفوظ کر دی گئیں');
                checkForReminders();
            };
            
            request.onerror = () => {
                showNotification('ترتیبات محفوظ کرنے میں خرابی');
                console.error('Error saving reminder settings:', request.error);
            };
        });

        // Clear all data
        document.getElementById('clearAllData').addEventListener('click', () => {
            if (confirm('کیا آپ واقعی تمام ڈیٹا صاف کرنا چاہتے ہیں؟ یہ عمل ناقابل واپسی ہے!')) {
                const transaction = db.transaction([STORES.CALCULATIONS, STORES.PAYMENTS], 'readwrite');
                const calculationsStore = transaction.objectStore(STORES.CALCULATIONS);
                const paymentsStore = transaction.objectStore(STORES.PAYMENTS);
                
                calculationsStore.clear();
                paymentsStore.clear();
                
                transaction.oncomplete = () => {
                    showNotification('تمام ڈیٹا صاف کر دیا گیا ہے');
                    loadPayments();
                    loadCalculations();
                    updateYearFilters();
                    updateReportSummary();
                };
                
                transaction.onerror = () => {
                    showNotification('ڈیٹا صاف کرنے میں خرابی');
                    console.error('Error clearing data:', transaction.error);
                };
            }
        });

        // Export data
        document.getElementById('exportData').addEventListener('click', async () => {
            try {
                const calculations = await getAllData(STORES.CALCULATIONS);
                const payments = await getAllData(STORES.PAYMENTS);
                const settings = {
                    priceSettings: await getSettings('priceSettings'),
                    reminderSettings: await getSettings('reminderSettings')
                };
                
                const exportData = {
                    version: DB_VERSION,
                    timestamp: new Date().toISOString(),
                    settings: settings,
                    calculations: calculations,
                    payments: payments
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `zakat_data_${new Date().toISOString().slice(0, 10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showNotification('ڈیٹا کامیابی سے برآمد کر دیا گیا ہے');
            } catch (error) {
                showNotification('ڈیٹا برآمد کرنے میں خرابی');
                console.error('Error exporting data:', error);
            }
        });

        // Get all data from a store
        const getAllData = (storeName) => {
            return new Promise((resolve, reject) => {
                const data = [];
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.openCursor();
                
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        data.push(cursor.value);
                        cursor.continue();
                    } else {
                        resolve(data);
                    }
                };
                
                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        };

        // Import data
        document.getElementById('importDataBtn').addEventListener('click', () => {
            document.getElementById('importFileInput').click();
        });

        document.getElementById('importFileInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    if (!importData.version || !importData.settings || !importData.calculations || !importData.payments) {
                        throw new Error('Invalid data format');
                    }
                    
                    // Import data
                    importSettings(importData.settings)
                        .then(() => importCalculations(importData.calculations))
                        .then(() => importPayments(importData.payments))
                        .then(() => {
                            showNotification('ڈیٹا کامیابی سے درآمد کر دیا گیا ہے');
                            loadPayments();
                            loadCalculations();
                            updateYearFilters();
                            updateReportSummary();
                            loadSettings();
                        })
                        .catch((error) => {
                            showNotification('ڈیٹا درآمد کرنے میں خرابی');
                            console.error('Error importing data:', error);
                        });
                    
                } catch (error) {
                    showNotification('ڈیٹا درآمد کرنے میں خرابی: غلط فائل فارمیٹ');
                    console.error('Error parsing import file:', error);
                }
                
                // Reset file input
                event.target.value = '';
            };
            
            reader.readAsText(file);
        });

        // Import settings
        const importSettings = (settings) => {
            return new Promise((resolve, reject) => {
                try {
                    const transaction = db.transaction([STORES.SETTINGS], 'readwrite');
                    const store = transaction.objectStore(STORES.SETTINGS);
                    
                    if (settings.priceSettings) {
                        store.put(settings.priceSettings);
                    }
                    
                    if (settings.reminderSettings) {
                        store.put(settings.reminderSettings);
                    }
                    
                    transaction.oncomplete = () => {
                        resolve();
                    };
                    
                    transaction.onerror = (event) => {
                        reject(event.target.error);
                    };
                } catch (error) {
                    reject(error);
                }
            });
        };

        // Import calculations
        const importCalculations = (calculations) => {
            return new Promise((resolve, reject) => {
                try {
                    const transaction = db.transaction([STORES.CALCULATIONS], 'readwrite');
                    const store = transaction.objectStore(STORES.CALCULATIONS);
                    
                    let count = 0;
                    const processNext = () => {
                        if (count < calculations.length) {
                            const calculation = calculations[count];
                            // Remove id to prevent conflicts
                            delete calculation.id;
                            const request = store.add(calculation);
                            
                            request.onsuccess = () => {
                                count++;
                                processNext();
                            };
                            
                            request.onerror = (event) => {
                                console.error('Error importing calculation:', event.target.error);
                                count++;
                                processNext();
                            };
                        } else {
                            resolve();
                        }
                    };
                    
                    processNext();
                } catch (error) {
                    reject(error);
                }
            });
        };

        // Import payments
        const importPayments = (payments) => {
            return new Promise((resolve, reject) => {
                try {
                    const transaction = db.transaction([STORES.PAYMENTS], 'readwrite');
                    const store = transaction.objectStore(STORES.PAYMENTS);
                    
                    let count = 0;
                    const processNext = () => {
                        if (count < payments.length) {
                            const payment = payments[count];
                            // Remove id to prevent conflicts
                            delete payment.id;
                            const request = store.add(payment);
                            
                            request.onsuccess = () => {
                                count++;
                                processNext();
                            };
                            
                            request.onerror = (event) => {
                                console.error('Error importing payment:', event.target.error);
                                count++;
                                processNext();
                            };
                        } else {
                            resolve();
                        }
                    };
                    
                    processNext();
                } catch (error) {
                    reject(error);
                }
            });
        };

        // Edit/delete payment handlers
        document.getElementById('paymentsTableBody').addEventListener('click', (event) => {
            const target = event.target;
            
            if (target.classList.contains('edit-payment')) {
                const paymentId = parseInt(target.dataset.id);
                openEditPaymentModal(paymentId);
            } else if (target.classList.contains('delete-payment')) {
                const paymentId = parseInt(target.dataset.id);
                if (confirm('کیا آپ واقعی اس ادائیگی کو حذف کرنا چاہتے ہیں؟')) {
                    deletePayment(paymentId);
                }
            }
        });

        // View/delete calculation handlers
        document.getElementById('calculationsTableBody').addEventListener('click', (event) => {
            const target = event.target;
            
            if (target.classList.contains('view-calculation')) {
                const calculationId = parseInt(target.dataset.id);
                openCalculationDetailsModal(calculationId);
            } else if (target.classList.contains('delete-calculation')) {
                const calculationId = parseInt(target.dataset.id);
                if (confirm('کیا آپ واقعی اس حساب کو حذف کرنا چاہتے ہیں؟')) {
                    deleteCalculation(calculationId);
                }
            }
        });

        // Delete payment
        const deletePayment = (paymentId) => {
            const transaction = db.transaction([STORES.PAYMENTS], 'readwrite');
            const store = transaction.objectStore(STORES.PAYMENTS);
            const request = store.delete(paymentId);
            
            request.onsuccess = () => {
                showNotification('ادائیگی کامیابی سے حذف کر دی گئی');
                loadPayments();
                updateReportSummary();
            };
            
            request.onerror = () => {
                showNotification('ادائیگی حذف کرنے میں خرابی');
                console.error('Error deleting payment:', request.error);
            };
        };

        // Delete calculation
        const deleteCalculation = (calculationId) => {
            const transaction = db.transaction([STORES.CALCULATIONS], 'readwrite');
            const store = transaction.objectStore(STORES.CALCULATIONS);
            const request = store.delete(calculationId);
            
            request.onsuccess = () => {
                showNotification('حساب کامیابی سے حذف کر دیا گیا');
                loadCalculations();
                updateReportSummary();
            };
            
            request.onerror = () => {
                showNotification('حساب حذف کرنے میں خرابی');
                console.error('Error deleting calculation:', request.error);
            };
        };

        // Open edit payment modal
        const openEditPaymentModal = (paymentId) => {
            const transaction = db.transaction([STORES.PAYMENTS], 'readonly');
            const store = transaction.objectStore(STORES.PAYMENTS);
            const request = store.get(paymentId);
            
            request.onsuccess = () => {
                const payment = request.result;
                if (payment) {
                    document.getElementById('editPaymentId').value = payment.id;
                    document.getElementById('editPaymentAmount').value = payment.amount;
                    document.getElementById('editPaymentDate').value = payment.date;
                    document.getElementById('editRecipient').value = payment.recipient || '';
                    document.getElementById('editPaymentCategory').value = payment.category;
                    document.getElementById('editPaymentNotes').value = payment.notes || '';
                    
                    document.getElementById('editPaymentModal').style.display = 'block';
                }
            };
            
            request.onerror = () => {
                console.error('Error getting payment details:', request.error);
            };
        };

        // Update payment
        document.getElementById('updatePayment').addEventListener('click', () => {
            const paymentId = parseInt(document.getElementById('editPaymentId').value);
            const amount = parseFloat(document.getElementById('editPaymentAmount').value);
            const date = document.getElementById('editPaymentDate').value;
            const recipient = document.getElementById('editRecipient').value;
            const category = document.getElementById('editPaymentCategory').value;
            const notes = document.getElementById('editPaymentNotes').value;
            
            if (!amount || !date) {
                showNotification('براہ کرم رقم اور تاریخ درج کریں');
                return;
            }
            
            const transaction = db.transaction([STORES.PAYMENTS], 'readwrite');
            const store = transaction.objectStore(STORES.PAYMENTS);
            const request = store.get(paymentId);
            
            request.onsuccess = () => {
                const payment = request.result;
                if (payment) {
                    payment.amount = amount;
                    payment.date = date;
                    payment.recipient = recipient;
                    payment.category = category;
                    payment.notes = notes;
                    payment.year = extractYear(date);
                    
                    const updateRequest = store.put(payment);
                    
                    updateRequest.onsuccess = () => {
                        showNotification('ادائیگی کامیابی سے اپ ڈیٹ کر دی گئی');
                        document.getElementById('editPaymentModal').style.display = 'none';
                        loadPayments();
                        updateReportSummary();
                    };
                    
                    updateRequest.onerror = () => {
                        showNotification('ادائیگی اپ ڈیٹ کرنے میں خرابی');
                        console.error('Error updating payment:', updateRequest.error);
                    };
                }
            };
            
            request.onerror = () => {
                showNotification('ادائیگی حاصل کرنے میں خرابی');
                console.error('Error getting payment for update:', request.error);
            };
        });

        // Open calculation details modal
        const openCalculationDetailsModal = (calculationId) => {
            const transaction = db.transaction([STORES.CALCULATIONS], 'readonly');
            const store = transaction.objectStore(STORES.CALCULATIONS);
            const request = store.get(calculationId);
            
            request.onsuccess = () => {
                const calculation = request.result;
                if (calculation) {
                    const detailsContent = document.getElementById('calculationDetailsContent');
                    
                    detailsContent.innerHTML = `
                        <div class="calculation-details">
                            <p><strong>تاریخ:</strong> ${formatDate(calculation.date)}</p>
                            <p><strong>سونا:</strong> ${calculation.gold} تولے (${formatCurrency(calculation.gold * calculation.goldPrice)})</p>
                            <p><strong>چاندی:</strong> ${calculation.silver} تولے (${formatCurrency(calculation.silver * calculation.silverPrice)})</p>
                            <p><strong>نقد رقم:</strong> ${formatCurrency(calculation.cash)}</p>
                            <p><strong>تجارتی اموال:</strong> ${formatCurrency(calculation.business)}</p>
                            <p><strong>وصولی:</strong> ${formatCurrency(calculation.receivables)}</p>
                            <p><strong>کل اثاثے:</strong> ${formatCurrency(calculation.totalAssets)}</p>
                            <p><strong>کل واجبات:</strong> ${formatCurrency(calculation.liabilities)}</p>
                            <p><strong>قابل زکٰوۃ دولت:</strong> ${formatCurrency(calculation.netWealth)}</p>
                            <p><strong>واجب زکٰوۃ (2.5%):</strong> ${formatCurrency(calculation.zakatAmount)}</p>
                            <p><strong>نصاب معلومات:</strong> ${calculation.nisabReason}</p>
                            ${calculation.notes ? `<p><strong>نوٹس:</strong> ${calculation.notes}</p>` : ''}
                        </div>
                    `;
                    
                    document.getElementById('calculationDetailsModal').style.display = 'block';
                }
            };
            
            request.onerror = () => {
                console.error('Error getting calculation details:', request.error);
            };
        };

        // Close modals
        document.getElementById('closeEditPaymentModal').addEventListener('click', () => {
            document.getElementById('editPaymentModal').style.display = 'none';
        });

        document.getElementById('closeCalculationDetailsModal').addEventListener('click', () => {
            document.getElementById('calculationDetailsModal').style.display = 'none';
        });

        // Close modals when clicking outside
        window.addEventListener('click', (event) => {
            if (event.target === document.getElementById('editPaymentModal')) {
                document.getElementById('editPaymentModal').style.display = 'none';
            }
            
            if (event.target === document.getElementById('calculationDetailsModal')) {
                document.getElementById('calculationDetailsModal').style.display = 'none';
            }
        });

        // Year filter change handlers
        document.getElementById('paymentYearFilter').addEventListener('change', loadPayments);
        document.getElementById('calculationYearFilter').addEventListener('change', loadCalculations);
        document.getElementById('reportYear').addEventListener('change', updateReportSummary);

        // Check for reminders
        const checkForReminders = async () => {
            const reminderSettings = await getSettings('reminderSettings');
            
            if (reminderSettings && reminderSettings.enableReminders === 'yes' && reminderSettings.zakatAnniversaryDate) {
                const today = new Date();
                const anniversaryDate = new Date(reminderSettings.zakatAnniversaryDate);
                
                // Check if it's within 7 days of anniversary date
                const currentMonth = today.getMonth();
                const currentDay = today.getDate();
                const anniversaryMonth = anniversaryDate.getMonth();
                const anniversaryDay = anniversaryDate.getDate();
                
                if (currentMonth === anniversaryMonth) {
                    const dayDiff = anniversaryDay - currentDay;
                    
                    if (dayDiff === 0) {
                        showNotification('آج آپ کی زکٰوۃ کا دن ہے! آپ کی زکٰوۃ کا حساب کریں۔', 5000);
                    } else if (dayDiff > 0 && dayDiff <= 7) {
                        showNotification(`آپ کی زکٰوۃ کا دن ${dayDiff} دن میں ہے۔`, 5000);
                    }
                }
            }
        };

        // Current date for zakat date input
        document.getElementById('zakatDate').valueAsDate = new Date();
        document.getElementById('paymentDate').valueAsDate = new Date();

        // Initialize the application
        initDB().then(() => {
            // Initialize tabs
            loadPayments();
            loadCalculations();
            updateYearFilters();
            loadReportYears();
            updateReportSummary();
            loadSettings();
            checkForReminders();
            
            // Set up reminder check on page load
            setTimeout(checkForReminders, 1000);
        }).catch(error => {
            console.error('Error initializing the application:', error);
            showNotification('ایپلیکیشن شروع کرنے میں خرابی۔ براہ کرم دوبارہ کوشش کریں۔', 5000);
        });
    </script>
</body>
</html>