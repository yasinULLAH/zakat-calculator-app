<!DOCTYPE html>
<html lang="ur" dir="rtl">

<head>
    <base href="/zakat-calculator-app/">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>زکوٰۃ مینیجر</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#006400">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap');

        :root {
            --primary-color: #006400;
            --primary-light: #007a00;
            --primary-dark: #004d00;
            --secondary-color: #f0f2f5;
            --background-color: #ffffff;
            --text-color: #333;
            --text-light: #666;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --error-color: #dc3545;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --button-text-color: #fff;
            --font-family: Calibri, 'Noto Nastaliq Urdu', serif
        }

        #tab-ushr>i {
            color: #00c200;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: var(--font-family)
        }

        html {
            scroll-behavior: smooth
        }

        body {
            direction: rtl;
            background-color: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.8;
            font-size: 16px
        }

        .container {
            max-width: 1100px;
            margin: 1rem auto;
            padding: 0 1rem
        }

        header {
            background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
            color: var(--button-text-color);
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px var(--shadow-color);
            margin-bottom: 1rem
        }

        header h1 {
            font-size: 2em;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: .5rem
        }

        nav {
            background-color: var(--background-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            margin-bottom: 1.5rem;
            padding: .5rem
        }

        nav ul {
            list-style: none;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: .5rem
        }

        nav ul li button {
            background-color: transparent;
            color: var(--text-light);
            border: none;
            padding: .75rem 1rem;
            cursor: pointer;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            transition: all .3s ease;
            display: flex;
            align-items: center;
            gap: .5rem
        }

        nav ul li button:hover {
            background-color: var(--secondary-color);
            color: var(--primary-dark)
        }

        nav ul li button.active {
            background-color: var(--primary-color);
            color: var(--button-text-color);
            box-shadow: 0 2px 8px rgba(0, 100, 0, .3)
        }

        .tab-content {
            display: none;
            animation: fadeIn .5s ease-in-out
        }

        .tab-content.active {
            display: block
        }

        .card {
            background-color: var(--background-color);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color)
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        h2,
        h3 {
            color: var(--primary-dark);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: .5rem;
            margin-bottom: 1.5rem;
            font-weight: 700
        }

        h3.table-header,
        h3.section-header {
            border: none;
            margin-top: 2rem;
            text-align: center;
            position: relative;
            font-size: 1.4em
        }

        h3.table-header::before,
        h3.section-header::before {
            content: '';
            position: absolute;
            width: 80px;
            height: 3px;
            background-color: var(--primary-color);
            bottom: -10px;
            right: 50%;
            transform: translateX(50%);
            border-radius: 2px
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem
        }

        .form-grid.single-col {
            grid-template-columns: 1fr;
            max-width: 500px;
            margin: 0 auto
        }

        .form-group.full-width {
            grid-column: 1/-1
        }

        .form-group label {
            display: flex;
            align-items: center;
            gap: .5rem;
            margin-bottom: .5rem;
            font-weight: bold;
            font-size: 1em
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: .75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            transition: border-color .3s, box-shadow .3s;
            text-align: right
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 100, 0, .1)
        }

        textarea {
            resize: vertical;
            min-height: 100px
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-start;
            margin-top: 1rem
        }

        button,
        .button-like-label {
            background-color: var(--primary-color);
            color: var(--button-text-color);
            padding: .75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all .3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: .5rem
        }

        button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px var(--shadow-color)
        }

        button.secondary {
            background-color: #6c757d
        }

        button.secondary:hover {
            background-color: #5a6268
        }

        button.danger {
            background-color: var(--error-color)
        }

        button.danger:hover {
            background-color: #c82333
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none
        }

        .info-area,
        .result-area {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid
        }

        .info-area {
            background-color: #e2f0fb;
            border-color: #b3d7f7;
            color: #0d6efd
        }

        .result-area {
            background-color: #e8f5e9;
            border-color: var(--success-color);
            margin-top: 1.5rem
        }

        .result-area h3 {
            border: none
        }

        .result-area ul {
            list-style: none;
            padding-right: 0
        }

        .result-area li {
            padding: .25rem 0;
            border-bottom: 1px dashed var(--border-color)
        }

        .result-area li:last-child {
            border: none
        }

        .table-container {
            overflow-x: auto;
            width: 100%;
            margin-top: 1.5rem
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 600px
        }

        th,
        td {
            border-bottom: 1px solid var(--border-color);
            padding: .8rem 1rem;
            text-align: right;
            vertical-align: middle
        }

        th {
            background-color: var(--secondary-color);
            color: var(--primary-dark);
            font-weight: 700;
            border-top: 1px solid var(--border-color)
        }

        tbody tr:hover {
            background-color: #fafafa
        }

        td .danger,
        td .secondary {
            padding: .4rem .8rem;
            font-size: .9em
        }

        .history-item {
            background-color: #fafafa;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: background-color .3s, box-shadow .3s;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .history-item:hover {
            background-color: #f1f1f1;
            box-shadow: 0 2px 8px var(--shadow-color)
        }

        .history-item h3 {
            border: none;
            margin: 0;
            font-size: 1.2em
        }

        .history-item span {
            font-weight: bold;
            font-size: 1.1em;
            color: var(--primary-dark)
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem
        }

        .summary-card {
            background: var(--background-color);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            box-shadow: 0 4px 15px var(--shadow-color);
            transition: transform .3s ease, box-shadow .3s ease
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, .12)
        }

        .summary-icon {
            min-width: 60px;
            height: 60px;
            border-radius: 50%;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em
        }

        .summary-content p {
            margin: 0;
            color: var(--text-light)
        }

        .summary-content h3 {
            margin: .25rem 0 0;
            border: none;
            padding: 0;
            font-size: 1.8em
        }

        .chart-container {
            padding: 1.5rem;
            margin-top: 2rem
        }

        .placeholder-text {
            color: var(--text-light);
            text-align: center;
            padding: 2rem
        }

        .data-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            align-items: center;
            margin-top: 1rem
        }

        .import-group input[type=file] {
            display: none
        }

        .import-group #import-filename {
            color: var(--text-light);
            margin-right: 1rem
        }

        #toast-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1050;
            width: 300px
        }

        .toast {
            background-color: #333;
            color: #fff;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, .2);
            display: flex;
            align-items: center;
            gap: 1rem;
            opacity: 0;
            transform: translateX(-100%);
            transition: all .5s cubic-bezier(.68, -.55, .27, 1.55)
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0)
        }

        .toast-icon {
            font-size: 1.5em
        }

        .toast.success {
            background-color: var(--success-color)
        }

        .toast.error {
            background-color: var(--error-color)
        }

        .toast.info {
            background-color: var(--info-color)
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, .6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn .3s
        }

        .modal-overlay.active {
            display: flex
        }

        .modal-content {
            background-color: var(--background-color);
            padding: 2rem;
            border-radius: 12px;
            text-align: right;
            animation: slideIn .3s;
            overflow-y: auto
        }

        .modal-content h3 {
            border: none;
            text-align: center
        }

        .modal-actions {
            margin-top: 1.5rem;
            display: flex;
            justify-content: center;
            gap: 1rem
        }

        #details-modal-content table {
            margin-top: 1rem
        }

        #details-modal-content td {
            padding: .5rem
        }

        #details-modal-content td:first-child {
            font-weight: bold
        }

        @keyframes slideIn {
            from {
                transform: translateY(-30px) scale(.95);
                opacity: 0
            }

            to {
                transform: translateY(0) scale(1);
                opacity: 1
            }
        }

        .real-time-value {
            font-size: .9em;
            color: var(--text-light);
            display: block;
            margin-top: .25rem;
            min-height: 1.2em
        }

        .lang-switcher {
            display: flex;
            gap: .5rem;
            margin-bottom: 1.5rem;
            justify-content: center
        }

        .lang-switcher button {
            background: var(--secondary-color);
            color: var(--text-light);
            font-size: .9em;
            padding: .5rem 1rem
        }

        .lang-switcher button.active {
            background: var(--primary-color);
            color: var(--button-text-color)
        }

        .lang-content {
            display: none
        }

        .lang-content.active {
            display: block;
            text-align: justify
        }

        #info details {
            background: #fafafa;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem
        }

        #info summary {
            font-weight: 700;
            cursor: pointer;
            color: var(--primary-dark)
        }

        .report-actions {
            margin-top: 1.5rem;
            text-align: center
        }

        @media (max-width:768px) {
            body {
                font-size: 15px
            }

            .container {
                padding: 0 .5rem
            }

            header h1 {
                font-size: 1.5em
            }

            nav ul {
                flex-direction: row;
                overflow-x: auto;
                justify-content: flex-start;
                padding-bottom: .5rem
            }

            nav ul li button span {
                display: none
            }

            nav ul li button {
                padding: .75rem
            }

            .form-grid {
                grid-template-columns: 1fr
            }

            .card,
            .modal-content {
                padding: 1.5rem
            }
        }

        @media print {

            .no-print,
            nav,
            header,
            #toast-container,
            .modal-overlay,
            .report-actions,
            h3.section-header,
            .data-actions {
                display: none !important
            }

            body {
                background-color: #fff
            }

            main,
            main .card,
            main .tab-content {
                box-shadow: none;
                border: none;
                padding: 0;
                margin: 0
            }

            .container {
                max-width: 100%
            }

            #report-area {
                display: block !important
            }

            h2 {
                font-size: 1.5em;
                text-align: center;
                border: none
            }
        }

        main {
            display: flow-root;
        }

        nav {
            background-color: var(--background-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            padding: 1rem;
            float: right;
            width: 220px;
            margin-left: 1.5rem;
        }

        nav ul {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: .5rem;
        }

        @media (max-width:768px) {
            nav {
                float: none;
                width: 100%;
                margin-left: 0;
                margin-bottom: 1.5rem;
                padding: .5rem;
            }

            main {
                overflow: visible;
            }

            nav ul {
                flex-direction: row;
                overflow-x: auto;
                justify-content: flex-start;
                padding-bottom: .5rem;
            }
        }

        .chart-container {
            max-height: 400px;
            padding: 1rem;
            margin-top: 1.5rem;
        }

        header {
            padding: 1rem;
        }

        h2,
        h3 {
            margin-bottom: 1rem;
        }

        .summary-card {
            padding: 1rem;
            gap: 1rem;
        }

        .summary-icon {
            min-width: 50px;
            height: 50px;
            font-size: 1.5em;
        }

        .summary-content h3 {
            font-size: 1.6em;
        }

        #payment-category-chart {
            display: block;
            box-sizing: border-box;
            height: 368px;
            width: 368px;
            direction: rtl !important;
            position: relative;
            top: -45px;
            left: -206px;
        }

        @media (max-width: 767px) {
            #payment-category-chart {
                position: static;
                top: auto;
                left: auto;
                height: auto;
                width: 100%;
            }
        }

        header .bi-moon-stars-fill {
            color: #ffc107;
        }

        #tab-dash .bi-layout-wtf {
            color: #17a2b8;
        }

        #tab-calc .bi-calculator-fill {
            color: #6c757d;
        }

        #tab-ushr .bi-tree-fill {
            color: #28a745;
        }

        #tab-pay .bi-cash-coin {
            color: #ffc107;
        }

        #tab-hist .bi-clock-history {
            color: #0d6efd;
        }

        #tab-rep .bi-bar-chart-line-fill {
            color: #6f42c1;
        }

        #tab-info .bi-info-circle-fill {
            color: #0dcaf0;
        }

        #tab-set .bi-gear-fill {
            color: #495057;
        }

        .form-group .bi-calendar-event,
        .form-group .bi-calendar-check,
        .form-group .bi-calendar-plus,
        .form-group .bi-calendar-heart {
            color: #fd7e14;
        }

        .form-group .bi-gem {
            color: #ffc107;
        }

        .form-group .bi-wallet2,
        .form-group .bi-cash {
            color: #198754;
        }

        .form-group .bi-box-seam {
            color: #8B4513;
        }

        .form-group .bi-arrow-down-left-circle {
            color: #20c997;
        }

        .form-group .bi-arrow-up-right-circle {
            color: #dc3545;
        }

        .form-group .bi-person-fill {
            color: #0d6efd;
        }

        .form-group .bi-tags-fill {
            color: #6f42c1;
        }

        .form-group .bi-pencil-square {
            color: #6c757d;
        }

        .form-group .bi-basket-fill {
            color: #28a745;
        }

        .form-group .bi-tag-fill {
            color: #6c757d;
        }

        .form-group .bi-droplet-half {
            color: #0dcaf0;
        }

        .form-group .bi-currency-dollar {
            color: #198754;
        }

        .form-group .bi-intersect {
            color: #6f42c1;
        }

        .form-group .bi-translate {
            color: #fd7e14;
        }

        #clear-data-btn .bi-trash3-fill,
        button.danger .bi-trash-fill {
            color: #fff;
        }

        #enable-notifications-btn .bi-bell-fill {
            color: #ffc107;
        }

        #tab-hija .bi-calendar-heart {
            color: #fd7e14;
        }

        #tab-mira .bi-diagram-3-fill {
            color: #6f42c1;
        }

        .big-checkbox {
            width: 1.3em;
            height: 1.3em;
            vertical-align: middle;
            margin-left: 0.5rem;
        }

        #miras-result-area .result-step {
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        #miras-result-area .result-step h4 {
            color: var(--primary-dark);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #miras-final-table {
            width: 100%;
            margin-top: 1rem;
            border-collapse: separate;
            border-spacing: 0;
        }

        #miras-final-table th,
        #miras-final-table td {
            padding: 0.8rem 1rem;
            border-bottom: 1px solid var(--border-color);
            text-align: right;
        }

        #miras-final-table th {
            background-color: var(--primary-color);
            color: white;
        }

        #miras-final-table tr:last-child td {
            border-bottom: none;
        }

        #miras-final-table tr:nth-child(even) {
            background-color: #fdfdfd;
        }

        #miras-final-table .total-row td {
            font-weight: bold;
            background-color: var(--secondary-color);
        }

        #upcoming-installments-area h3 {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        .installment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background-color: #fafafa;
        }

        .installment-item.overdue {
            border-left: 5px solid var(--error-color);
        }

        .installment-item.due-soon {
            border-left: 5px solid var(--warning-color);
        }

        .installment-details span {
            display: block;
            color: var(--text-light);
            font-size: 0.9em;
        }

        .installment-details strong {
            font-size: 1.1em;
            color: var(--primary-dark);
        }

        .installment-actions .btn-pay {
            background-color: var(--success-color);
        }
    </style>
</head>

<body>
    <div id="plan-modal" class="modal-overlay no-print">
        <div class="modal-content">
            <h3>ادائیگی کا پلان بنائیں</h3>
            <p>کل واجب الادا زکوٰۃ: <strong id="plan-total-amount"></strong></p>
            <form id="plan-form">
                <div class="form-group">
                    <label for="plan-frequency">ادائیگی کی ترتیب:</label>
                    <select id="plan-frequency" class="form-control">
                        <option value="monthly">ماہانہ (12 قسطیں)</option>
                        <option value="quarterly">سہ ماہی (4 قسطیں)</option>
                        <option value="half-yearly">ششماہی (2 قسطیں)</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="submit" id="plan-create-btn">پلان بنائیں</button>
                    <button type="button" id="plan-cancel-btn" class="secondary">منسوخ کریں</button>
                </div>
            </form>
        </div>
    </div>
    <div class="container">
        <header class="no-print">
            <p id="islamic-date-display"
                style="text-align: left; font-size: 0.9em; margin-bottom: -10px; min-height: 1.2em;"></p>
            <h1><i class="bi bi-moon-stars-fill"></i> زکوٰۃ مینیجر</h1>
        </header>
        <nav class="no-print">
            <ul>
                <li>
                    <button id="tab-dash" onclick="showTab('dashboard')"><i class="bi bi-layout-wtf"></i> <span>ڈیش
                            بورڈ</span></button>
                </li>
                <li>
                    <button id="tab-calc" onclick="showTab('calculator')"><i class="bi bi-calculator-fill"></i>
                        <span>کیلکولیٹر</span></button>
                </li>
                <li>
                    <button id="tab-ushr" onclick="showTab('ushr')"><i class="bi bi-tree-fill"></i>
                        <span>عشر کیلکولیٹر</span></button>
                </li>
                <li>
                    <button id="tab-fidy" onclick="showTab('fidya-kaffara')"><i
                            class="bi bi-shield-fill-exclamation"></i> <span>فدیہ/کفارہ</span></button>
                </li>
                <li>
                    <button id="tab-hija" onclick="showTab('hijri-age')"><i class="bi bi-calendar-heart"></i> <span>ہجری
                            عمر</span></button>
                </li>
                <li>
                    <button id="tab-mira" onclick="showTab('miras')"><i class="bi bi-diagram-3-fill"></i> <span>میراث
                            کیلکولیٹر</span></button>
                </li>
                <li>
                    <button id="tab-pay" onclick="showTab('payments')"><i class="bi bi-cash-coin"></i>
                        <span>ادائیگیاں</span></button>
                </li>
                <li>
                    <button id="tab-hist" onclick="showTab('history')"><i class="bi bi-clock-history"></i>
                        <span>تاریخ</span></button>
                </li>
                <li>
                    <button id="tab-rep" onclick="showTab('reports')"><i class="bi bi-bar-chart-line-fill"></i>
                        <span>رپورٹس</span></button>
                </li>
                <li>
                    <button id="tab-char" onclick="showTab('charities')"><i class="bi bi-building"></i> <span>عطیہ
                            دہندگان</span></button>
                </li>
                <li>
                    <button id="tab-info" onclick="showTab('info')"><i class="bi bi-info-circle-fill"></i>
                        <span>معلومات</span></button>
                </li>
                <li>
                    <button id="tab-set" onclick="showTab('settings')"><i class="bi bi-gear-fill"></i>
                        <span>سیٹنگز</span></button>
                </li>
            </ul>
        </nav>
        <main id="main-content">
            <div id="miras" class="tab-content card">
                <h2>میراث کیلکولیٹر (Hanafi School)</h2>
                <p>یہ کیلکولیٹر سنی حنفی فقہ کے مطابق وراثت کی تقسیم کا حساب کرتا ہے۔ براہ کرم تمام معلومات درست درج
                    کریں۔</p>
                <form id="miras-form">
                    <h3 class="section-header">مرحلہ 1: ترکہ اور اخراجات</h3>
                    <div class="form-grid single-col">
                        <div class="form-group">
                            <label for="miras-estate"><i class="bi bi-bank"></i> کل قابلِ تقسیم جائیداد (ترکہ):</label>
                            <input type="number" id="miras-estate" step="any" required>
                        </div>
                        <div class="form-group">
                            <label for="miras-funeral"><i class="bi bi-box-seam"></i> تجہیز و تکفین کے اخراجات:</label>
                            <input type="number" id="miras-funeral" value="0" step="any">
                        </div>
                        <div class="form-group">
                            <label for="miras-debt"><i class="bi bi-receipt"></i> مرحوم کے ذمہ قرض:</label>
                            <input type="number" id="miras-debt" value="0" step="any">
                        </div>
                        <div class="form-group">
                            <label for="miras-will"><i class="bi bi-pen-fill"></i> جائز وصیت (باقی ترکہ کے 1/3
                                تک):</label>
                            <input type="number" id="miras-will" value="0" step="any">
                        </div>
                    </div>
                    <h3 class="section-header">مرحلہ 2: ورثاء کی تفصیل</h3>
                    <div class="form-grid">
                        <div class="form-group full-width"
                            style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                            <label style="font-size: 1.2em; color: var(--primary-dark);">میاں / بیوی:</label>
                            <div style="display: flex; gap: 2rem; margin-top: 0.5rem;">
                                <label><input type="radio" name="spouse" value="none" checked> کوئی نہیں</label>
                                <label><input type="radio" name="spouse" value="husband"> شوہر</label>
                                <label>
                                    <input type="radio" name="spouse" value="wife"> بیوی
                                    <input type="number" id="miras-wives" value="1" min="1" max="4"
                                        style="width: 60px; display: inline-block; padding: 0.25rem;">
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="miras-sons"><i class="bi bi-person-standing"></i> بیٹے:</label>
                            <input type="number" id="miras-sons" value="0" min="0">
                        </div>
                        <div class="form-group">
                            <label for="miras-daughters"><i class="bi bi-person-standing-dress"></i> بیٹیاں:</label>
                            <input type="number" id="miras-daughters" value="0" min="0">
                        </div>
                        <div class="form-group">
                            <label for="miras-father"><i class="bi bi-person-up"></i> باپ زندہ ہے؟</label>
                            <input type="checkbox" id="miras-father" class="big-checkbox">
                        </div>
                        <div class="form-group">
                            <label for="miras-mother"><i class="bi bi-person-up"></i> ماں زندہ ہے؟</label>
                            <input type="checkbox" id="miras-mother" class="big-checkbox">
                        </div>
                        <div class="form-group">
                            <label for="miras-paternal-grandfather"><i class="bi bi-person-up"></i> دادا (صرف اگر باپ
                                زندہ نہیں):</label>
                            <input type="checkbox" id="miras-paternal-grandfather" class="big-checkbox">
                        </div>
                        <div class="form-group">
                            <label for="miras-maternal-grandmother"><i class="bi bi-person-up"></i> نانی (صرف اگر ماں
                                زندہ نہیں):</label>
                            <input type="checkbox" id="miras-maternal-grandmother" class="big-checkbox">
                        </div>
                        <div class="form-group">
                            <label for="miras-paternal-grandmother"><i class="bi bi-person-up"></i> دادی (صرف اگر ماں
                                زندہ نہیں):</label>
                            <input type="checkbox" id="miras-paternal-grandmother" class="big-checkbox">
                        </div>
                        <div class="form-group"></div>
                        <div class="form-group">
                            <label for="miras-full-brothers"><i class="bi bi-people"></i> سگے بھائی:</label>
                            <input type="number" id="miras-full-brothers" value="0" min="0">
                        </div>
                        <div class="form-group">
                            <label for="miras-full-sisters"><i class="bi bi-people"></i> سگی بہنیں:</label>
                            <input type="number" id="miras-full-sisters" value="0" min="0">
                        </div>
                        <div class="form-group">
                            <label for="miras-paternal-brothers"><i class="bi bi-people"></i> باپ شریک بھائی:</label>
                            <input type="number" id="miras-paternal-brothers" value="0" min="0">
                        </div>
                        <div class="form-group">
                            <label for="miras-paternal-sisters"><i class="bi bi-people"></i> باپ شریک بہنیں:</label>
                            <input type="number" id="miras-paternal-sisters" value="0" min="0">
                        </div>
                        <div class="form-group">
                            <label for="miras-uterine-siblings"><i class="bi bi-people"></i> ماں شریک
                                بھائی/بہنیں:</label>
                            <input type="number" id="miras-uterine-siblings" value="0" min="0">
                        </div>
                    </div>
                    <h3 class="section-header">مرحلہ 3: خصوصی حالات</h3>
                    <div class="form-grid single-col">
                        <div class="form-group">
                            <label><input type="checkbox" id="miras-killer" class="big-checkbox"> کیا کوئی وارث مرحوم کا
                                قاتل ہے؟ (قاتل وراثت سے محروم ہوتا ہے)</label>
                        </div>
                        <div class="form-group">
                            <label><input type="checkbox" id="miras-non-muslim" class="big-checkbox"> کیا کوئی وارث غیر
                                مسلم ہے؟ (غیر مسلم وارث نہیں ہوتا)</label>
                        </div>
                    </div>
                    <div class="form-actions full-width" style="justify-content: center; margin-top: 2rem;">
                        <button type="submit" style="font-size: 1.2em; padding: 1rem 2rem;"><i
                                class="bi bi-calculator-fill"></i> حصوں کا حساب لگائیں</button>
                    </div>
                </form>
                <div id="miras-result-area" style="display:none; margin-top: 2rem;"></div>
            </div>
            <div id="hijri-age" class="tab-content card">
                <h2>ہجری عمر کا کیلکولیٹر</h2>
                <p>اپنی گریگورین تاریخ پیدائش درج کریں تاکہ آپ کی عمر اسلامی (قمری) سالوں کے مطابق معلوم کی جا سکے۔</p>
                <form id="hijri-age-form" class="form-grid single-col" style="margin-top: 1.5rem;">
                    <div class="form-group">
                        <label for="birth-date-gregorian"><i class="bi bi-calendar-event"></i> تاریخ پیدائش
                            (گریگورین):</label>
                        <input type="date" id="birth-date-gregorian" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit"><i class="bi bi-calculator"></i> عمر کا حساب لگائیں</button>
                    </div>
                </form>
                <div id="hijri-age-result" class="result-area" style="display:none;"></div>
            </div>
            <div id="charities" class="tab-content card">
                <h2>توثیق شدہ عطیہ دہندگان</h2>
                <p class="placeholder-text">یہاں کچھ معروف ادارے ہیں جو زکوٰۃ وصول کرتے ہیں۔ براہ کرم عطیہ دینے سے پہلے
                    اپنی تحقیق خود کریں۔</p>
                <div id="charity-list" class="dashboard-grid" style="margin-top: 1.5rem;">
                </div>
            </div>
            <div id="fidya-kaffara" class="tab-content card">
                <h2>فدیہ و کفارہ</h2>
                <details>
                    <summary><strong>کفارہ (Expiation)</strong>: گناہوں یا ٹوٹی ہوئی قسموں کا ازالہ</summary>
                    <h4>کفارہ کی اقسام:</h4>
                    <ul>
                        <li><strong>روزہ توڑنا (جان بوجھ کر):</strong> ایک غلام آزاد کریں، یا 60 دن لگاتار روزے رکھیں،
                            یا 60 مسکینوں کو کھانا کھلائیں۔</li>
                        <li><strong>قسم توڑنا / ایلاء:</strong> ایک غلام آزاد کریں، یا 10 مسکینوں کو کھانا کھلائیں، یا
                            10 مسکینوں کو کپڑے پہنائیں، یا 3 دن روزے رکھیں۔</li>
                        <li><strong>ظہار (بیوی کو ماں جیسا کہنا):</strong> ایک غلام آزاد کریں، یا 60 دن لگاتار روزے
                            رکھیں، یا 60 مسکینوں کو کھانا کھلائیں۔</li>
                    </ul>
                </details>
                <details style="margin-top:1rem;">
                    <summary><strong>فدیہ (روزے کا معاوضہ)</strong>: جب کوئی بڑھاپے یا دائمی بیماری کی وجہ سے روزہ نہ
                        رکھ سکے</summary>
                    <p>یہ اس وقت ادا کیا جاتا ہے جب کوئی شخص بڑھاپے یا ایسی دائمی بیماری کی وجہ سے روزہ رکھنے سے قاصر ہو
                        جس سے صحت یابی کی امید نہ ہو۔</p>
                    <ul>
                        <li><strong>مقدار فی دن:</strong> تقریباً 1.75 کلو گرام گندم یا اس کی موجودہ بازاری قیمت۔</li>
                        <li><strong>مثال (موجودہ قیمت):</strong> تقریباً 90 پاکستانی روپے فی دن۔</li>
                    </ul>
                </details>
                <h3 class="section-header">کیلکولیٹر</h3>
                <form id="fk-form">
                    <div class="form-grid single-col">
                        <div class="form-group">
                            <label for="fk-type"><i class="bi bi-ui-checks"></i> قسم منتخب کریں:</label>
                            <select id="fk-type">
                                <option value="fidya">فدیہ (روزہ نہ رکھنے کا معاوضہ)</option>
                                <option value="kaffara-fast">کفارہ (روزہ توڑنے کا - کھانا کھلانا)</option>
                                <option value="kaffara-oath">کفارہ (قسم توڑنے کا - کھانا/کپڑے)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fk-cost"><i class="bi bi-cash"></i> فی کس/یومیہ لاگت (<span
                                    id="fk-currency-symbol"></span>):</label>
                            <input type="number" id="fk-cost" value="90" required>
                        </div>
                        <div class="form-group">
                            <label for="fk-quantity"><i class="bi bi-people-fill"></i> <span id="fk-quantity-label">دنوں
                                    کی تعداد</span>:</label>
                            <input type="number" id="fk-quantity" value="1" min="1" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit"><i class="bi bi-play-fill"></i> حساب لگائیں</button>
                        </div>
                    </div>
                </form>
                <div id="fk-result" class="result-area" style="display:none"></div>
            </div>
            <div id="ushr" class="tab-content card">
                <h2>عشر کیلکولیٹر (زرعی پیداوار پر زکوٰۃ)</h2>
                <div class="info-area">
                    <i class="bi bi-info-circle"></i> عشر اس زرعی پیداوار پر واجب ہوتا ہے جو زمین سے حاصل ہوتی ہے۔ اس کا
                    نصاب 5 وسق (تقریباً 653 کلوگرام) ہے۔ (1 من = 40 کلوگرام)
                </div>
                <form id="ushr-form" class="form-grid single-col" style="margin-top: 1.5rem;">
                    <div class="form-group">
                        <label for="produce-amount"><i class="bi bi-basket-fill"></i> کل پیداوار (کلوگرام میں):</label>
                        <input type="number" id="produce-amount" step="any" required>
                        <span id="produce-amount-mann-display" class="real-time-value"></span>
                    </div>
                    <div class="form-group">
                        <label for="price-per-kg"><i class="bi bi-tag-fill"></i> فی کلو قیمت:</label>
                        <input type="number" id="price-per-kg" step="any" required>
                    </div>
                    <div class="form-group">
                        <label for="irrigation-type"><i class="bi bi-droplet-half"></i> آبپاشی کی قسم:</label>
                        <select id="irrigation-type" required>
                            <option value="0.10">قدرتی (بارانی، چشمے، دریا) - 10%</option>
                            <option value="0.05">مصنوعی (ٹیوب ویل، نہری پانی) - 5%</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit"><i class="bi bi-calculator"></i> عشر کا حساب لگائیں</button>
                    </div>
                </form>
                <div id="ushr-result" class="result-area" style="display:none;"></div>
            </div>
            <div id="dashboard" class="tab-content card">
                <h2>ڈیش بورڈ</h2>
                <div class="info-area" id="anniversary-reminder"></div>
                <div class="dashboard-grid">
                    <div class="summary-card" id="summary-due-card">
                        <div class="summary-icon" style="background-color:#dc3545"><i
                                class="bi bi-exclamation-triangle-fill"></i></div>
                        <div class="summary-content">
                            <p>تازہ ترین واجب الادا زکوٰۃ</p>
                            <h3 id="summary-due-amount">کوئی حساب نہیں</h3>
                        </div>
                    </div>
                    <div class="summary-card" id="summary-paid-card">
                        <div class="summary-icon" style="background-color:#28a745"><i
                                class="bi bi-check-circle-fill"></i></div>
                        <div class="summary-content">
                            <p>تازہ ترین ادا شدہ رقم</p>
                            <h3 id="summary-paid-amount">کوئی ادائیگی نہیں</h3>
                        </div>
                    </div>
                    <div class="summary-card" id="summary-remaining-card">
                        <div class="summary-icon" style="background-color:#ffc107"><i class="bi bi-hourglass-split"></i>
                        </div>
                        <div class="summary-content">
                            <p>تازہ ترین بقایا رقم</p>
                            <h3 id="summary-remaining-amount">کوئی حساب نہیں</h3>
                        </div>
                    </div>
                </div>
                <h3 class="section-header">آپ کے سنگ میل (Your Milestones)</h3>
                <div id="milestones-container" class="dashboard-grid">
                    <p class="placeholder-text full-width">حساب کتاب اور ادائیگیاں شامل کریں تاکہ آپ اپنے سنگ میل دیکھ
                        سکیں۔</p>
                </div>
                <div class="chart-container card" style="margin-top:2rem">
                    <h3>ادائیگیوں کا خلاصہ (تازہ ترین سال)</h3>
                    <canvas id="payment-category-chart"></canvas>
                    <p id="payment-chart-placeholder" class="placeholder-text">ادائیگیوں کا ڈیٹا دستیاب نہیں۔</p>
                </div>
            </div>
            <div id="calculator" class="tab-content card">
                <h2>زکوٰۃ کیلکولیٹر</h2>
                <div class="info-area" id="calc-info-prices"></div>
                <form id="zakat-form" class="form-grid">
                    <div class="form-group">
                        <label for="year"><i class="bi bi-calendar-event"></i> سال:</label>
                        <input type="number" id="year" name="year" required>
                    </div>
                    <div class="form-group">
                        <label for="gold-karat"><i class="bi bi-gem"></i> سونے کا کیرٹ:
                        </label>
                        <select id="gold-karat" name="gold-karat">
                            <option value="24">24 (خالص)</option>
                            <option value="22">22</option>
                            <option value="18">18</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="gold"><i class="bi bi-gem"></i> سونا (تولے میں):
                        </label>
                        <input type="number" id="gold" name="gold" step="any" value="0" required><span
                            id="gold-value-display" class="real-time-value"></span>
                    </div>
                    <div class="form-group full-width">
                        <label for="silver"><i class="bi bi-gem" style="opacity:0.7"></i> چاندی (تولے میں):</label>
                        <input type="number" id="silver" name="silver" step="any" value="0" required><span
                            id="silver-value-display" class="real-time-value"></span>
                    </div>
                    <div class="form-group">
                        <label for="cash"><i class="bi bi-wallet2"></i> نقد رقم / بینک بیلنس:
                        </label>
                        <input type="number" id="cash" name="cash" step="any" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="business-goods"><i class="bi bi-box-seam"></i> مالِ تجارت و سرمایہ کاری:</label>
                        <input type="number" id="business-goods" name="business-goods" step="any" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="receivables"><i class="bi bi-arrow-down-left-circle"></i> وصول طلب قرضے:</label>
                        <input type="number" id="receivables" name="receivables" step="any" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="liabilities"><i class="bi bi-arrow-up-right-circle"></i> واجب الادا قرضے
                            (منہا):</label>
                        <input type="number" id="liabilities" name="liabilities" step="any" value="0" required>
                    </div>
                    <div class="form-actions full-width">
                        <button type="submit"><i class="bi bi-play-fill"></i> حساب لگائیں
                        </button>
                        <button type="button" onclick="saveCalculation()" id="save-calc-btn" class="secondary"
                            style="display:none"><i class="bi bi-save-fill"></i> حساب محفوظ کریں
                        </button>
                        <button type="button" id="create-plan-btn" class="secondary"
                            style="display:none; background-color: var(--success-color);"><i
                                class="bi bi-calendar2-week-fill"></i> ادائیگی کا پلان بنائیں</button>
                    </div>
                </form>
                <div id="zakat-result" class="result-area" style="display:none"></div>
            </div>
            <div id="payments" class="tab-content card">
                <h2>ادائیگیوں کا ریکارڈ</h2>
                <div id="upcoming-installments-area" style="margin-bottom: 2rem;">
                </div>
                <h3>نئی ادائیگی شامل کریں</h3>
                <form id="payment-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="payment-year"><i class="bi bi-calendar-check"></i> سال (جس سال کی زکوٰۃ
                                ہے):</label>
                            <select id="payment-year" required>
                                <option value="">سال منتخب کریں</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="payment-amount"><i class="bi bi-cash"></i> رقم:
                            </label>
                            <input type="number" id="payment-amount" step="any" required>
                        </div>
                        <div class="form-group">
                            <label for="payment-date"><i class="bi bi-calendar-plus"></i> تاریخ:
                            </label>
                            <input type="date" id="payment-date" required>
                        </div>
                        <div class="form-group">
                            <label for="payment-recipient"><i class="bi bi-person-fill"></i> وصول کنندہ:
                            </label>
                            <input type="text" id="payment-recipient" list="recipient-suggestions">
                            <datalist id="recipient-suggestions"></datalist>
                            <div class="form-group">
                                <label for="payment-impact-tag"><i class="bi bi-award-fill"></i> اثرات کا ٹیگ
                                    (اختیاری):</label>
                                <select id="payment-impact-tag">
                                    <option value="none">منتخب کریں</option>
                                    <option value="خوراک/راشن">خوراک/راشن</option>
                                    <option value="تعلیم">تعلیم</option>
                                    <option value="صحت/علاج">صحت/علاج</option>
                                    <option value="یتیموں کی کفالت">یتیموں کی کفالت</option>
                                    <option value="قرض کی ادائیگی">قرض کی ادائیگی</option>
                                    <option value="عمومی مدد">عمومی مدد</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <label for="payment-category"><i class="bi bi-tags-fill"></i> کیٹیگری:
                            </label>
                            <input type="text" id="payment-category" placeholder="مثلاً: غریب، رشتہ دار، ادارہ">
                        </div>
                        <div class="form-group full-width">
                            <label for="payment-notes"><i class="bi bi-pencil-square"></i> نوٹس:</label>
                            <textarea id="payment-notes"></textarea>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit"><i class="bi bi-plus-circle-fill"></i> ادائیگی محفوظ کریں
                        </button>
                    </div>
                </form>
                <h3 class="table-header">ادائیگیوں کی تفصیل</h3>
                <div class="form-group">
                    <label for="payment-history-year-filter">سال کے لحاظ سے فلٹر کریں:
                    </label>
                    <select id="payment-history-year-filter" onchange="renderPaymentHistory()">
                        <option value="">تمام سال</option>
                    </select>
                </div>
                <div class="table-container">
                    <table id="payment-history-list">
                        <thead>
                            <tr>
                                <th>سال</th>
                                <th>تاریخ</th>
                                <th>رقم</th>
                                <th>وصول کنندہ</th>
                                <th>کیٹیگری</th>
                                <th>نوٹس</th>
                                <th>عمل</th>
                            </tr>
                        </thead>
                        <tbody id="payment-history-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div id="history" class="tab-content card">
                <h2>حساب کتاب کی تاریخ</h2>
                <div id="history-list">
                    <p class="placeholder-text">کوئی حسابی ریکارڈ موجود نہیں ہے۔</p>
                </div>
            </div>
            <div id="reports" class="tab-content card">
                <h2>رپورٹس</h2>
                <div class="form-group no-print">
                    <label for="report-year-filter">سالانہ رپورٹ دیکھیں:</label>
                    <select id="report-year-filter" onchange="generateReport()">
                        <option value="">سال منتخب کریں</option>
                    </select>
                </div>
                <div id="report-area" style="display:none"></div>
                <div class="report-actions no-print">
                    <button onclick="window.print()"><i class="bi bi-printer-fill"></i> رپورٹ پرنٹ کریں</button>
                </div>
                <div class="chart-container card no-print" style="margin-top:2rem">
                    <h3>سالانہ زکوٰۃ کا موازنہ</h3>
                    <canvas id="yearly-comparison-chart"></canvas>
                    <p id="yearly-chart-placeholder" class="placeholder-text">موازنہ کے لیے کم از کم ایک سال کا ڈیٹا
                        درکار ہے۔</p>
                </div>
                <h3 class="section-header no-print">ڈیٹا ایکسپورٹ / امپورٹ</h3>
                <div class="data-actions no-print">
                    <button onclick="exportData()"><i class="bi bi-download"></i> ڈیٹا ایکسپورٹ کریں (JSON)</button>
                    <div class="import-group">
                        <label for="import-file" class="button-like-label"><i class="bi bi-upload"></i> فائل منتخب
                            کریں...</label>
                        <input type="file" id="import-file" accept=".json" onchange="importData()"><span
                            id="import-filename">کوئی فائل منتخب
                            نہیں</span>
                    </div>
                </div>
            </div>
            <div id="info" class="tab-content card">
                <h2>زکوٰۃ کے بارے میں</h2>
                <div class="lang-switcher no-print">
                    <button class="lang-btn active" data-lang="ur">اردو</button>
                    <button class="lang-btn" data-lang="en">English</button>
                    <button class="lang-btn" data-lang="ar">العربية</button>
                    <button class="lang-btn" data-lang="ps">پښتو</button>
                </div>
                <div id="lang-ur" class="lang-content active">
                    <details>
                        <summary>زکوٰۃ کا حساب لگانے کا طریقہ</summary>
                        <p><strong>نصاب کا تعین:</strong></p>
                        <ul>
                            <li>اگر آپ کے پاس صرف سونا ہے اور وہ 7.5 تولے (87.48 گرام) یا اس سے زیادہ ہے، تو آپ صاحبِ
                                نصاب ہیں۔</li>
                            <li>اگر آپ کے پاس صرف چاندی ہے اور وہ 52.5 تولے (612.36 گرام) یا اس سے زیادہ ہے، تو آپ صاحبِ
                                نصاب ہیں۔</li>
                            <li>اگر آپ کے پاس ملا جلا مال (سونا، چاندی، نقد رقم، مالِ تجارت) ہے، تو نصاب کا تعین 52.5
                                تولے چاندی کی موجودہ قیمت سے کیا جائے گا۔ اگر آپ کے تمام قابلِ زکوٰۃ اثاثوں کی مجموعی
                                مالیت اس قیمت سے زیادہ ہے، تو آپ صاحبِ
                                نصاب ہیں۔ (یہ سب سے عام صورتحال ہے)۔
                            </li>
                        </ul>
                        <p><strong>قابلِ زکوٰۃ اثاثے:</strong> سونا، چاندی، نقد رقم، مالِ تجارت (فروخت کی نیت سے خریدا
                            گیا سامان)، وصول طلب قرضے (جن کی واپسی کی امید ہو)۔</p>
                        <p><strong>واجب الادا قرضے:</strong> زکوٰۃ کا حساب کرتے وقت، آپ اپنے کل قابلِ زکوٰۃ اثاثوں میں
                            سے اپنی فوری واجب الادا ذمہ داریاں اور قرضے منہا کر سکتے ہیں۔</p>
                        <p><strong>زکوٰۃ کی شرح:</strong> اگر آپ صاحبِ نصاب ہیں اور آپ کے اثاثوں پر ایک قمری سال گزر چکا
                            ہے، تو واجب الادا قرضے منہا کرنے کے بعد بچنے والی رقم کا 2.5 فیصد بطور زکوٰۃ ادا کرنا ہوگا۔
                        </p>
                        <p><strong>سال کا پورا ہونا (حول):</strong> زکوٰۃ اس مال پر واجب ہوتی ہے جو نصاب تک پہنچ جائے
                            اور اس پر ایک پورا قمری سال (تقریباً 354 دن) گزر جائے۔ جس تاریخ کو آپ پہلی بار صاحبِ نصاب
                            بنے تھے، وہی آپ کی زکوٰۃ کی سالانہ تاریخ ہے۔</p>
                    </details>
                    <details>
                        <summary>زکوٰۃ کس کو دی جا سکتی ہے؟</summary>
                        <p>قرآن مجید (سورۃ التوبہ، آیت 60) میں آٹھ قسم کے لوگوں کا ذکر ہے جنہیں زکوٰۃ دی جا سکتی ہے:
                            فقراء (غریب)، مساکین (انتہائی ضرورت مند)، عاملین (زکوٰۃ جمع کرنے والے)، مؤلفۃ القلوب (نئے
                            مسلمان)، رقاب (غلاموں کو آزاد کرانے کے لیے)، غارمین
                            (قرض دار)، فی سبیل اللہ (اللہ کی راہ میں)، اور ابن السبیل (مسافر)۔</p>
                    </details>
                </div>
                <div id="lang-en" class="lang-content" dir="ltr">
                    <details>
                        <summary>How to Calculate Zakat</summary>
                        <p><strong>Determining Nisab (Threshold):</strong></p>
                        <ul>
                            <li>If you only own gold, and it is 7.5 tolas (87.48g) or more, you have met the Nisab.</li>
                            <li>If you only own silver, and it is 52.5 tolas (612.36g) or more, you have met the Nisab.
                            </li>
                            <li>For mixed assets (gold, silver, cash, business goods), the Nisab is determined by the
                                value of 52.5 tolas of silver. If the total value of your zakatable assets exceeds this,
                                you have met the Nisab (this is the most common case).</li>
                        </ul>
                        <p><strong>Zakatable Assets:</strong> Gold, silver, cash, business goods (items for resale), and
                            receivables (loans given to others that are expected to be returned).</p>
                        <p><strong>Liabilities:</strong> When calculating Zakat, you can deduct your immediate
                            liabilities and debts from your total zakatable assets.</p>
                        <p><strong>Zakat Rate:</strong> If you have met the Nisab and a lunar year has passed over your
                            wealth, you must pay 2.5% of the remaining amount after deducting liabilities.</p>
                        <p><strong>Completion of a Year (Hawl):</strong> Zakat is due on wealth that reaches the Nisab
                            and has been held for one full lunar year (approx. 354 days). The date you first met the
                            Nisab becomes your annual Zakat anniversary.</p>
                    </details>
                    <details>
                        <summary>Who Can Receive Zakat?</summary>
                        <p>The Quran (Surah At-Tawbah, verse 60) specifies eight categories of people who are eligible
                            to receive Zakat: the poor (Fuqara), the needy (Masakin), Zakat administrators (Amilin),
                            those whose hearts are to be reconciled (Mu'allafatul Qulub), for freeing captives (Riqab),
                            those in debt (Gharimin), in the cause of Allah (Fi Sabilillah), and the wayfarer (Ibnus
                            Sabil).</p>
                    </details>
                </div>
                <div id="lang-ar" class="lang-content">
                    <details>
                        <summary>كيفية حساب الزكاة</summary>
                        <p><strong>تحديد النصاب:</strong></p>
                        <ul>
                            <li>إذا كنت تملك ذهباً فقط، ويزن 7.5 تولة (87.48 جرام) أو أكثر، فقد بلغت النصاب.</li>
                            <li>إذا كنت تملك فضة فقط، وتزن 52.5 تولة (612.36 جرام) أو أكثر، فقد بلغت النصاب.</li>
                            <li>إذا كان لديك أموال مختلطة (ذهب، فضة، نقد، عروض تجارة)، يُقدّر النصاب بقيمة 52.5 تولة من
                                الفضة. إذا تجاوزت قيمة جميع أصولك الزكوية هذه القيمة، فأنت تبلغ النصاب (وهذه هي الحالة
                                الأكثر شيوعًا).</li>
                        </ul>
                        <p><strong>الأموال الزكوية:</strong> الذهب، الفضة، النقد، عروض التجارة (البضائع المشتراة بنية
                            البيع)، الديون التي لك على الآخرين (التي يُرجى سدادها).</p>
                        <p><strong>الديون والالتزامات:</strong> عند حساب الزكاة، يمكنك خصم ديونك والتزاماتك واجبة السداد
                            فورًا من إجمالي أصولك الزكوية.</p>
                        <p><strong>نسبة الزكاة:</strong> إذا بلغت النصاب وحال عليه الحول (عام قمري كامل)، فيجب عليك دفع
                            2.5% من المبلغ المتبقي بعد خصم الديون.</p>
                        <p><strong>حولان الحول:</strong> تجب الزكاة على المال الذي يبلغ النصاب ويمر عليه عام قمري كامل
                            (حوالي 354 يومًا). التاريخ الذي بلغت فيه النصاب لأول مرة هو تاريخ زكاتك السنوي.</p>
                    </details>
                    <details>
                        <summary>من هم مستحقو الزكاة؟</summary>
                        <p>حدد القرآن الكريم (سورة التوبة، الآية 60) ثمانية أصناف من الناس الذين تُصرف لهم الزكاة:
                            الفقراء، والمساكين، والعاملين عليها، والمؤلفة قلوبهم، وفي الرقاب، والغارمين، وفي سبيل الله،
                            وابن السبيل.</p>
                    </details>
                </div>
                <div id="lang-ps" class="lang-content">
                    <details>
                        <summary>د زکات حسابولو طریقه</summary>
                        <p><strong>د نصاب ټاکل:</strong></p>
                        <ul>
                            <li>که تاسو یوازې سره زر لرئ او هغه ۷.۵ توله (۸۷.۴۸ ګرامه) یا له هغه ډېر وي، نو تاسو د نصاب
                                خاوند یاست.</li>
                            <li>که تاسو یوازې سپین زر لرئ او هغه ۵۲.۵ توله (۶۱۲.۳۶ ګرامه) یا له هغه ډېر وي، نو تاسو د
                                نصاب خاوند یاست.</li>
                            <li>که تاسو ګډ مال لرئ (سره زر، سپین زر، نغدې پیسې، د سوداګرۍ مال)، نو نصاب به د ۵۲.۵ توله
                                سپینو زرو په اوسني ارزښت ټاکل کیږي. که ستاسو د ټولو زکات وړ شتمنیو مجموعي ارزښت له دې
                                څخه ډېر وي، نو تاسو د نصاب خاوند یاست (دا تر ټولو عام حالت دی).</li>
                        </ul>
                        <p><strong>د زکات وړ شتمنۍ:</strong> سره زر، سپین زر، نغدې پیسې، د سوداګرۍ مال (د پلور په نیت
                            اخیستل شوی سامان)، او هغه پورونه چې د بېرته راستنېدو تمه یې وي.</p>
                        <p><strong>پورونه:</strong> د زکات د حسابولو پر مهال، تاسو کولی شئ له خپلو ټولو زکات وړ شتمنیو
                            څخه خپل فوري پورونه منفي کړئ.</p>
                        <p><strong>د زکات کچه:</strong> که تاسو د نصاب خاوند یاست او ستاسو پر شتمنۍ یو قمري کال تېر شوی
                            وي، نو د پورونو تر منفي کولو وروسته پاتې شوې پیسې ۲.۵ سلنه باید د زکات په توګه ورکړئ.</p>
                        <p><strong>د کال پوره کېدل (حول):</strong> زکات پر هغه مال واجب دی چې نصاب ته ورسیږي او یو بشپړ
                            قمري کال (شاوخوا ۳۵۴ ورځې) پرې تېر شي. هغه نېټه چې تاسو لومړی ځل د نصاب خاوند شوي یاست،
                            هماغه ستاسو د زکات کلنۍ نېټه ده.</p>
                    </details>
                    <details>
                        <summary>زکات چا ته ورکول کیدای شي؟</summary>
                        <p>قرآن کریم (سورة التوبة، ۶۰ آیت) اته ډوله خلک مشخص کړي چې د زکات مستحق دي: فقراء (غریبان)،
                            مساکین (ډېر اړمن)، عاملین (د زکات راټولوونکي)، مؤلفة القلوب (نوي مسلمانان)، رقاب (د غلامانو
                            ازادولو لپاره)، غارمین (پوروړي)، فی سبیل الله (د الله په لاره کې)، او ابن السبیل (مسافر).
                        </p>
                    </details>
                </div>
            </div>
            <div id="settings" class="tab-content card">
                <h2>سیٹنگز</h2>
                <form id="settings-form">
                    <div class="form-grid single-col">
                        <div class="form-group">
                            <label for="gold-price"><i class="bi bi-currency-dollar"></i> سونے کی قیمت (فی تولہ، 24
                                کیرٹ):</label>
                            <input type="number" id="gold-price" step="any" required>
                        </div>
                        <div class="form-group">
                            <label for="silver-price"><i class="bi bi-currency-dollar"></i> چاندی کی قیمت (فی
                                تولہ):</label>
                            <input type="number" id="silver-price" step="any" required>
                        </div>
                        <div class="form-group">
                            <label for="currency-symbol"><i class="bi bi-translate"></i> کرنسی کی علامت:
                            </label>
                            <input type="text" id="currency-symbol" value="PKR" required>
                        </div>
                        <div class="form-group">
                            <label for="calculation-method"><i class="bi bi-intersect"></i> حساب کا طریقہ:</label>
                            <select id="calculation-method" name="calculation-method">
                                <option value="value" selected>بذریعہ قیمت (ضم بالقيمة)</option>
                                <option value="quantity">بذریعہ اجزاء (ضم بالاجزاء)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="zakat-anniversary"><i class="bi bi-calendar-heart"></i> زکوٰۃ کی سالگرہ کی
                                تاریخ:</label>
                            <input type="date" id="zakat-anniversary">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit"><i class="bi bi-check-lg"></i> سیٹنگز محفوظ کریں</button>
                        <button type="button" id="fetch-prices-btn" class="secondary"><i
                                class="bi bi-cloud-download"></i> تازہ
                            ترین قیمتیں حاصل کریں</button>
                    </div>
                </form>
                <h3 class="section-header no-print">اطلاعات (Notifications)</h3>
                <div class="data-actions no-print">
                    <button id="enable-notifications-btn"><i class="bi bi-bell-fill"></i> یاد دہانی کے لیے اطلاعات فعال
                        کریں</button>
                </div>
                <h3 class="section-header no-print">ایپلی کیشن</h3>
                <div class="data-actions no-print">
                    <button id="clear-data-btn" class="danger"><i class="bi bi-trash3-fill"></i> تمام ڈیٹا حذف
                        کریں</button>
                </div>
            </div>
        </main>
    </div>
    <div id="toast-container"></div>
    <div id="confirmation-modal" class="modal-overlay no-print">
        <div class="modal-content">
            <h3 id="modal-title">تصدیق</h3>
            <p id="modal-message">کیا آپ واقعی آگے بڑھنا چاہتے ہیں؟</p>
            <div class="modal-actions">
                <button id="modal-confirm-btn" class="danger">ہاں</button>
                <button id="modal-cancel-btn" class="secondary">منسوخ کریں</button>
            </div>
        </div>
    </div>
    <div id="details-modal" class="modal-overlay no-print">
        <div class="modal-content" id="details-modal-content">
            <h3 id="details-modal-title">تفصیلات</h3>
            <div id="details-modal-body"></div>
            <div class="modal-actions">
                <button id="details-modal-close-btn" class="secondary">بند کریں</button>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const DB_NAME = 'zakatManagerDB';
        const DB_VERSION = 3;
        const STORES = {
            settings: 'settings',
            calculations: 'calculations',
            payments: 'payments',
            plans: 'plans'
        };
        let db;
        let yearlyChart = null;
        let paymentChart = null;
        const appState = {
            settings: {
                goldPrice: 0,
                silverPrice: 0,
                currencySymbol: 'PKR',
                zakatAnniversary: null,
                zakatAnniversaryIslamic: null,
                calculationMethod: 'value'
            },
            currentCalculationResult: null,
            isEditingPayment: null,
            activePlan: { year: null, totalAmount: 0 }
        };
        const CHARITIES_DATA = [
            { name: 'اخوت', description: 'بلا سود قرضوں کے ذریعے غربت کے خاتمے کے لیے کام کرنے والا ادارہ۔', website: 'https://akhuwat.org.pk/' },
            { name: 'ایدھی فاؤنڈیشن', description: 'پاکستان کا سب سے بڑا فلاحی ادارہ جو وسیع پیمانے پر سماجی خدمات فراہم کرتا ہے۔', website: 'https://edhi.org/' },
            { name: 'سیلانی ویلفیئر', description: 'مستحق افراد کو کھانا کھلانے، تعلیم اور صحت کی سہولیات فراہم کرنے میں سرگرم۔', website: 'https://www.saylaniwelfare.com/' },
            { name: 'شوکت خانم ہسپتال', description: 'کینسر کے مریضوں کا مفت علاج کرنے والا معروف ہسپتال۔', website: 'https://shaukatkhanum.org.pk/' }
        ];
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = event => {
                    const dbInstance = event.target.result;
                    if (!dbInstance.objectStoreNames.contains(STORES.settings)) {
                        dbInstance.createObjectStore(STORES.settings, {
                            keyPath: 'id'
                        })
                    }
                    if (!dbInstance.objectStoreNames.contains(STORES.calculations)) {
                        dbInstance.createObjectStore(STORES.calculations, {
                            keyPath: 'year'
                        })
                    }
                    if (!dbInstance.objectStoreNames.contains(STORES.payments)) {
                        const paymentStore = dbInstance.createObjectStore(STORES.payments, {
                            keyPath: 'id',
                            autoIncrement: true
                        });
                        paymentStore.createIndex('year_idx', 'year', {
                            unique: false
                        })
                    }
                    if (!dbInstance.objectStoreNames.contains(STORES.plans)) {
                        dbInstance.createObjectStore(STORES.plans, { keyPath: 'year' });
                    }
                };
                request.onsuccess = event => {
                    db = event.target.result;
                    resolve(db)
                };
                request.onerror = event => {
                    console.error('Database error:', event.target.errorCode);
                    reject('Database error: ' + event.target.errorCode)
                }
            })
        }
        function getStore(storeName, mode) {
            if (!db) return Promise.reject("Database not initialized");
            const transaction = db.transaction(storeName, mode);
            return transaction.objectStore(storeName)
        }
        function dbRequest(request) {
            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error)
            })
        }
        async function saveData(storeName, data) {
            const store = getStore(storeName, 'readwrite');
            return dbRequest(store.put(data))
        }
        async function deleteData(storeName, key) {
            const store = getStore(storeName, 'readwrite');
            return dbRequest(store.delete(key))
        }
        async function fetchLivePrices() {
            try {
                const response = await fetch('prices-history.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const pricesHistory = await response.json();
                if (pricesHistory && pricesHistory.length > 0) {
                    pricesHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                    const latestPrice = pricesHistory[0];
                    appState.settings.goldPrice = latestPrice.gold;
                    appState.settings.silverPrice = latestPrice.silver;
                    document.getElementById('gold-price').value = latestPrice.gold;
                    document.getElementById('silver-price').value = latestPrice.silver;
                    updatePriceInfoInCalculator();
                    showToast('تازہ ترین قیمتیں حاصل کر لی گئیں۔', 'success');
                }
            } catch (error) {
                console.error("Could not fetch live prices:", error);
                showToast('تازہ ترین قیمتیں حاصل کرنے میں ناکامی۔', 'error');
            }
        }
        async function loadSettings() {
            try {
                const store = getStore(STORES.settings, 'readonly');
                const settings = await dbRequest(store.get('current'));
                if (settings) {
                    appState.settings = settings
                }
                document.getElementById('gold-price').value = appState.settings.goldPrice || '';
                document.getElementById('silver-price').value = appState.settings.silverPrice || '';
                document.getElementById('currency-symbol').value = appState.settings.currencySymbol || 'PKR';
                document.getElementById('zakat-anniversary').value = appState.settings.zakatAnniversary || '';
                document.getElementById('calculation-method').value = appState.settings.calculationMethod || 'quantity';
            } catch (error) {
                console.error("Failed to load settings:", error)
            }
            updatePriceInfoInCalculator()
        }
        async function createInstallmentPlan() {
            const { year, totalAmount: zakatAmount } = appState.activePlan;
            const frequency = document.getElementById('plan-frequency').value;
            if (!zakatAmount || zakatAmount <= 0) {
                showToast('پلان بنانے کے لیے کوئی واجب الادا رقم نہیں۔', 'error');
                return;
            }
            const frequencies = { 'monthly': 12, 'quarterly': 4, 'half-yearly': 2 };
            const numInstallments = frequencies[frequency];
            const rawBaseAmount = zakatAmount / numInstallments;
            const roundedBaseAmount = Math.floor(rawBaseAmount * 100) / 100;
            const totalOfRoundedInstallments = roundedBaseAmount * numInstallments;
            const remainder = parseFloat((zakatAmount - totalOfRoundedInstallments).toFixed(2));
            const installments = [];
            let currentDate = new Date();
            for (let i = 0; i < numInstallments; i++) {
                const installmentAmount = (i === numInstallments - 1) ? roundedBaseAmount + remainder : roundedBaseAmount;
                if (frequency === 'monthly') currentDate.setMonth(currentDate.getMonth() + 1);
                else if (frequency === 'quarterly') currentDate.setMonth(currentDate.getMonth() + 3);
                else if (frequency === 'half-yearly') currentDate.setMonth(currentDate.getMonth() + 6);
                installments.push({
                    dueDate: currentDate.toISOString().slice(0, 10),
                    amount: parseFloat(installmentAmount.toFixed(2)),
                    status: 'pending',
                    paymentId: null
                });
            }
            const plan = {
                year,
                totalAmount: zakatAmount,
                frequency,
                installments
            };
            await saveData(STORES.plans, plan);
            showToast('ادائیگی کا پلان کامیابی سے بن گیا ہے۔', 'success');
            toggleModal('plan-modal', false);
            await renderUpcomingInstallments();
        }
        async function renderUpcomingInstallments() {
            const area = document.getElementById('upcoming-installments-area');
            const plans = await dbRequest(getStore(STORES.plans, 'readonly').getAll());
            let html = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let pendingInstallments = [];
            plans.forEach(plan => {
                plan.installments.forEach((inst, index) => {
                    if (inst.status === 'pending') {
                        pendingInstallments.push({ ...inst, year: plan.year, index: index });
                    }
                });
            });
            if (pendingInstallments.length === 0) {
                area.innerHTML = '';
                return;
            }
            pendingInstallments.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            html += '<h3>آنے والی قسطیں</h3>';
            pendingInstallments.forEach(inst => {
                const dueDate = new Date(inst.dueDate);
                const timeDiff = dueDate.getTime() - today.getTime();
                const daysRemaining = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
                let className = 'installment-item';
                let dateText = `مقررہ تاریخ: ${new Date(inst.dueDate).toLocaleDateString('ur-PK')}`;
                if (daysRemaining < 0) {
                    className += ' overdue';
                    dateText += ` (${Math.abs(daysRemaining)} دن پہلے)`;
                } else if (daysRemaining <= 7) {
                    className += ' due-soon';
                    dateText += ` (${daysRemaining} دن میں)`;
                }
                html += `
                    <div class="${className}">
                        <div class="installment-details">
                            <strong>${formatCurrency(inst.amount)}</strong>
                            <span>${dateText}</span>
                        </div>
                        <div class="installment-actions">
                            <button class="btn-pay" onclick="recordInstallmentAsPaid(${inst.year}, ${inst.index})">
                                <i class="bi bi-check-circle-fill"></i> ادا شدہ نشان لگائیں
                            </button>
                        </div>
                    </div>
                `;
            });
            area.innerHTML = html;
        }
        async function recordInstallmentAsPaid(year, index) {
            const plan = await dbRequest(getStore(STORES.plans, 'readonly').get(year));
            if (!plan) return;
            const installment = plan.installments[index];
            showConfirmation(
                'ادائیگی کی تصدیق کریں؟',
                `کیا آپ واقعی ${formatCurrency(installment.amount)} کی قسط کو ادا شدہ کے طور پر نشان زد کرنا چاہتے ہیں؟`,
                async () => {
                    const paymentData = {
                        year: year,
                        amount: installment.amount,
                        date: new Date().toISOString().slice(0, 10),
                        recipient: 'Zakat Installment',
                        category: 'Installment',
                        notes: `Installment ${index + 1}/${plan.installments.length} for Zakat year ${year}.`,
                        impactTag: 'none'
                    };
                    const paymentId = await saveData(STORES.payments, paymentData);
                    plan.installments[index].status = 'paid';
                    plan.installments[index].paymentId = paymentId;
                    await saveData(STORES.plans, plan);
                    showToast('قسط کامیابی سے ادا ہو گئی۔', 'success');
                    await renderPaymentHistory();
                    await renderUpcomingInstallments();
                }
            );
        }
        function renderCharities() {
            const list = document.getElementById('charity-list');
            if (CHARITIES_DATA.length === 0) {
                list.innerHTML = `<p class="placeholder-text">کوئی ادارہ شامل نہیں کیا گیا۔</p>`;
                return;
            }
            list.innerHTML = CHARITIES_DATA.map(charity => `
                <div class="summary-card">
                    <div class="summary-content">
                        <h3 style="margin-bottom: 0.5rem; font-size: 1.4em;">${charity.name}</h3>
                        <p>${charity.description}</p>
                        <a href="${charity.website}" target="_blank" rel="noopener noreferrer" class="button-like-label" style="margin-top: 1rem; text-decoration: none;">ویب سائٹ دیکھیں <i class="bi bi-box-arrow-up-right"></i></a>
                    </div>
                </div>
            `).join('');
        }
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId)?.classList.add('active');
            document.getElementById(`tab-${tabId.substring(0, 4)}`)?.classList.add('active');
            const handler = {
                dashboard: renderDashboard,
                charities: renderCharities,
                ushr: updateUshrMannDisplay,
                history: renderCalculationHistory,
                payments: async () => {
                    await populatePaymentYearSelect();
                    await populateRecipientSuggestions();
                    await renderPaymentHistory();
                    await setDefaultPaymentYear();
                    await renderUpcomingInstallments();
                },
                reports: () => {
                    populateReportYearFilter();
                    generateReport()
                },
                calculator: () => {
                    const yearInput = document.getElementById('year');
                    if (!yearInput.value) yearInput.value = new Date().getFullYear()
                },
                info: () => {
                    document.querySelector('.lang-btn.active').click()
                },
                'fidya-kaffara': updateFkForm
            }[tabId];
            if (handler) handler()
        }
        function updateUshrMannDisplay() {
            const kgInput = document.getElementById('produce-amount');
            const mannDisplay = document.getElementById('produce-amount-mann-display');
            const kg = parseFloat(kgInput.value) || 0;
            if (kg > 0) {
                const mann = kg / 40;
                mannDisplay.textContent = `≈ ${mann.toLocaleString('en-US', { maximumFractionDigits: 2 })} من`;
            } else {
                mannDisplay.textContent = '';
            }
        }

        document.getElementById('produce-amount').addEventListener('input', updateUshrMannDisplay);
        function updateFkForm() {
            const type = document.getElementById('fk-type').value;
            const quantityLabel = document.getElementById('fk-quantity-label');
            const costInput = document.getElementById('fk-cost');
            const KaffaraMapping = {
                'kaffara-fast': { label: 'افراد کی تعداد', quantity: 60 },
                'kaffara-oath': { label: 'افراد کی تعداد', quantity: 10 },
                'fidya': { label: 'دنوں کی تعداد', quantity: 1 }
            };
            const mapping = KaffaraMapping[type];
            if (mapping) {
                quantityLabel.textContent = mapping.label;
                document.getElementById('fk-quantity').value = mapping.quantity;
            }
            document.getElementById('fk-currency-symbol').textContent = appState.settings.currencySymbol || 'PKR';
            costInput.value = (appState.settings.currencySymbol === 'PKR') ? 90 : 1;
        }
        function setupFkEventListeners() {
            document.getElementById('fk-type').addEventListener('change', updateFkForm);
            document.getElementById('fk-form').addEventListener('submit', (event) => {
                event.preventDefault();
                const cost = parseFloat(document.getElementById('fk-cost').value);
                const quantity = parseInt(document.getElementById('fk-quantity').value);
                if (isNaN(cost) || isNaN(quantity) || cost <= 0 || quantity <= 0) {
                    showToast('براہ کرم درست لاگت اور تعداد درج کریں۔', 'error');
                    return;
                }
                const total = cost * quantity;
                const resultArea = document.getElementById('fk-result');
                resultArea.innerHTML = `<h3>کل واجب الادا رقم: <strong>${formatCurrency(total)}</strong></h3>`;
                resultArea.style.display = 'block';
            });
        }
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icons = {
                success: 'check-circle-fill',
                error: 'x-circle-fill',
                info: 'info-circle-fill'
            };
            toast.innerHTML = `<i class="bi bi-${icons[type]} toast-icon"></i> <span>${message}</span>`;
            container.prepend(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove())
            }, 5000)
        }
        async function autofillPaymentAmount() {
            const yearSelect = document.getElementById('payment-year');
            const amountInput = document.getElementById('payment-amount');
            const year = yearSelect.value ? parseInt(yearSelect.value) : null;
            amountInput.value = '';
            if (!year) return;
            try {
                const calc = await dbRequest(getStore(STORES.calculations, 'readonly').get(year));
                if (!calc || !calc.isZakatDue) return;
                const payments = await dbRequest(getStore(STORES.payments, 'readonly').index('year_idx').getAll(IDBKeyRange.only(year)));
                const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
                const remaining = Math.max(0, calc.zakatAmount - totalPaid);
                if (remaining > 0) {
                    amountInput.value = remaining;
                }
            } catch (error) {
                console.error("Failed to autofill payment amount:", error);
            }
        }
        function toggleModal(modalId, show) {
            const modal = document.getElementById(modalId);
            if (show) {
                modal.classList.add('active')
            } else {
                modal.classList.remove('active')
            }
        }
        function showConfirmation(title, message, onConfirm) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            toggleModal('confirmation-modal', true);
            document.getElementById('modal-confirm-btn').onclick = () => {
                onConfirm();
                toggleModal('confirmation-modal', false)
            };
            document.getElementById('modal-cancel-btn').onclick = () => toggleModal('confirmation-modal', false)
        }
        function formatCurrency(value) {
            const num = Number(value) || 0;
            return `${num.toLocaleString('en-US', { maximumFractionDigits: 2 })} ${appState.settings.currencySymbol || 'PKR'}`
        }
        function calculateConsecutiveYears(years) {
            if (years.length < 2) return years.length;
            const sortedYears = [...new Set(years)].sort((a, b) => a - b);
            let maxStreak = 0;
            let currentStreak = 0;
            if (sortedYears.length > 0) {
                maxStreak = 1;
                currentStreak = 1;
            }
            for (let i = 1; i < sortedYears.length; i++) {
                if (sortedYears[i] === sortedYears[i - 1] + 1) {
                    currentStreak++;
                } else {
                    currentStreak = 1;
                }
                if (currentStreak > maxStreak) {
                    maxStreak = currentStreak;
                }
            }
            return maxStreak;
        }
        async function renderMilestones() {
            const container = document.getElementById('milestones-container');
            container.innerHTML = '';
            const [calculations, payments] = await Promise.all([
                dbRequest(getStore(STORES.calculations, 'readonly').getAll()),
                dbRequest(getStore(STORES.payments, 'readonly').getAll())
            ]);
            const stats = {
                consecutiveYears: calculateConsecutiveYears(calculations.map(c => c.year)),
                totalPayments: payments.length,
                totalPaid: payments.reduce((sum, p) => sum + p.amount, 0),
                uniqueRecipients: new Set(payments.map(p => p.recipient).filter(Boolean)).size
            };
            const milestones = [
                {
                    condition: stats.consecutiveYears > 1,
                    icon: 'bi-calendar-check-fill',
                    color: '#006400',
                    title: 'مسلسل سال',
                    value: `${stats.consecutiveYears} سال`
                },
                {
                    condition: stats.totalPayments >= 10,
                    icon: 'bi-receipt-cutoff',
                    color: '#17a2b8',
                    title: 'کل ادائیگیاں',
                    value: `${stats.totalPayments} ادائیگیاں`
                },
                {
                    condition: stats.totalPaid > 0,
                    icon: 'bi-piggy-bank-fill',
                    color: '#28a745',
                    title: 'کل ادا شدہ رقم',
                    value: formatCurrency(stats.totalPaid)
                },
                {
                    condition: stats.uniqueRecipients >= 5,
                    icon: 'bi-people-fill',
                    color: '#ffc107',
                    title: 'منفرد وصول کنندگان',
                    value: `${stats.uniqueRecipients} لوگ/ادارے`
                }
            ];
            let milestonesHtml = '';
            milestones.forEach(m => {
                if (m.condition) {
                    milestonesHtml += `
                        <div class="summary-card">
                            <div class="summary-icon" style="background-color:${m.color}"><i class="${m.icon}"></i></div>
                            <div class="summary-content">
                                <p>${m.title}</p>
                                <h3>${m.value}</h3>
                            </div>
                        </div>`;
                }
            });
            if (milestonesHtml) {
                container.innerHTML = milestonesHtml;
            } else {
                container.innerHTML = `<p class="placeholder-text full-width">حساب کتاب اور ادائیگیاں شامل کریں تاکہ آپ اپنے سنگ میل دیکھ سکیں۔</p>`;
            }
        }
        function calculateZakat(data, prices, settings) {
            const { gold, silver, cash, businessGoods, receivables, liabilities, goldKarat } = data;
            const { goldPrice, silverPrice } = prices;
            const purityFactors = { 24: 1, 22: 22 / 24, 18: 18 / 24 };
            const pureGoldWeight = gold * purityFactors[goldKarat];
            const goldValue = pureGoldWeight * goldPrice;
            const silverValue = silver * silverPrice;
            const totalAssets = goldValue + silverValue + cash + businessGoods + receivables;
            const nisabValue = 52.5 * silverPrice;
            if (silverPrice <= 0) {
                return { message: "چاندی کی قیمت سیٹنگز میں درکار ہے۔", isZakatDue: false, zakatAmount: 0 };
            }
            let isNisabMet = false;
            let nisabDeterminationMessage = '';
            const hasOnlyGold = gold > 0 && silver === 0 && cash === 0 && businessGoods === 0 && receivables === 0;
            const hasOnlySilver = silver > 0 && gold === 0 && cash === 0 && businessGoods === 0 && receivables === 0;
            if (hasOnlyGold) {
                if (gold >= 7.5) {
                    isNisabMet = true;
                    nisabDeterminationMessage = `نصاب صرف سونے کی بنیاد پر مکمل ہے (7.5 تولے یا زیادہ)۔`;
                } else {
                    nisabDeterminationMessage = `نصاب مکمل نہیں (صرف سونا 7.5 تولے سے کم ہے)۔`;
                }
            } else if (hasOnlySilver) {
                if (silver >= 52.5) {
                    isNisabMet = true;
                    nisabDeterminationMessage = `نصاب صرف چاندی کی بنیاد پر مکمل ہے (52.5 تولے یا زیادہ)۔`;
                } else {
                    nisabDeterminationMessage = `نصاب مکمل نہیں (صرف چاندی 52.5 تولے سے کم ہے)۔`;
                }
            } else {
                if (totalAssets >= nisabValue) {
                    isNisabMet = true;
                    nisabDeterminationMessage = `نصاب بذریعہ قیمت (ملا جلا مال) مکمل ہے، کیونکہ کل اثاثوں کی مالیت (${formatCurrency(totalAssets)}) چاندی کے نصاب (${formatCurrency(nisabValue)}) سے زیادہ ہے۔`;
                } else {
                    nisabDeterminationMessage = `نصاب مکمل نہیں، کیونکہ کل اثاثوں کی مالیت (${formatCurrency(totalAssets)}) چاندی کے نصاب (${formatCurrency(nisabValue)}) سے کم ہے۔`;
                }
            }
            const zakatableAssetsAfterLiabilities = Math.max(0, totalAssets - liabilities);
            let zakatAmount = 0;
            if (isNisabMet) {
                zakatAmount = zakatableAssetsAfterLiabilities * 0.025;
            }
            const result = {
                inputs: data,
                prices: prices,
                goldValue: goldValue,
                silverValue: silverValue,
                totalAssets: totalAssets,
                zakatableAssets: zakatableAssetsAfterLiabilities,
                isZakatDue: isNisabMet,
                zakatAmount: zakatAmount,
                message: nisabDeterminationMessage,
                nisabValue: nisabValue
            };
            appState.currentCalculationResult = {
                year: data.year,
                ...data,
                ...prices,
                totalAssets: result.totalAssets,
                nisabValue: result.nisabValue,
                zakatableAssets: result.zakatableAssets,
                isZakatDue: result.isZakatDue,
                zakatAmount: result.zakatAmount,
                calculationDate: new Date().toISOString()
            };
            return result;
        }
        function displayCalculationResult(result) {
            const resultArea = document.getElementById('zakat-result');
            const saveBtn = document.getElementById('save-calc-btn');
            const planBtn = document.getElementById('create-plan-btn');
            resultArea.innerHTML = `
        <h3>نتیجہ</h3>
        <ul>
            <li>سونے کی قیمت: ${formatCurrency(result.goldValue)}</li>
            <li>چاندی کی قیمت: ${formatCurrency(result.silverValue)}</li>
            <li>دیگر اثاثے: ${formatCurrency(result.inputs.cash + result.inputs.businessGoods + result.inputs.receivables)}</li>
            <li><strong>کل اثاثے: ${formatCurrency(result.totalAssets)}</strong></li>
            <li>واجب الادا قرضے: ${formatCurrency(result.inputs.liabilities)}</li>
            <li><strong>کل قابلِ زکوٰۃ اثاثے: ${formatCurrency(result.zakatableAssets)}</strong></li>
        </ul>
        <p><em>${result.message}</em></p>
        <h4 style="margin-top:1rem">${result.isZakatDue ? `واجب الادا زکوٰۃ: <strong>${formatCurrency(result.zakatAmount)}</strong>` : '<strong>زکوٰۃ واجب الادا نہیں ہے۔</strong>'}</h4>
    `;
            resultArea.style.display = 'block';
            if (result.isZakatDue) {
                saveBtn.style.display = 'inline-flex';
                planBtn.style.display = 'inline-flex';
                appState.activePlan.year = result.inputs.year;
                appState.activePlan.totalAmount = result.zakatAmount;
            } else {
                saveBtn.style.display = 'none';
                planBtn.style.display = 'none';
            }
        }
        async function saveCalculation() {
            if (!appState.currentCalculationResult) {
                showToast("محفوظ کرنے کے لیے کوئی حساب موجود نہیں۔", 'error');
                return
            }
            const {
                year
            } = appState.currentCalculationResult;
            try {
                const existing = await dbRequest(getStore(STORES.calculations, 'readonly').get(year));
                if (existing) {
                    showConfirmation('اوور رائٹ کریں؟', `سال ${year} کا حساب پہلے سے موجود ہے۔ کیا آپ اسے تبدیل کرنا چاہتے ہیں؟`, async () => {
                        await saveData(STORES.calculations, appState.currentCalculationResult);
                        showToast(`سال ${year} کا حساب اپڈیٹ ہوگیا۔`, 'success');
                        appState.currentCalculationResult = null;
                        document.getElementById('save-calc-btn').style.display = 'none'
                    })
                } else {
                    await saveData(STORES.calculations, appState.currentCalculationResult);
                    showToast(`سال ${year} کا حساب محفوظ ہوگیا۔`, 'success');
                    appState.currentCalculationResult = null;
                    document.getElementById('save-calc-btn').style.display = 'none'
                }
            } catch (error) {
                showToast('حساب محفوظ کرنے میں خرابی۔', 'error');
                console.error(error)
            }
        }
        class Fraction {
            constructor(num, den = 1) {
                if (typeof num !== 'bigint') num = BigInt(num);
                if (typeof den !== 'bigint') den = BigInt(den);
                this.num = num;
                this.den = den;
                this.simplify();
            }
            gcd(a, b) {
                a = a > 0n ? a : -a;
                b = b > 0n ? b : -b;
                return b === 0n ? a : this.gcd(b, a % b);
            }
            simplify() {
                if (this.den === 0n) return;
                const commonDivisor = this.gcd(this.num, this.den);
                this.num /= commonDivisor;
                this.den /= commonDivisor;
                if (this.den < 0n) {
                    this.num = -this.num;
                    this.den = -this.den;
                }
            }
            toString() {
                return `${this.num}/${this.den}`;
            }
            add(other) {
                const newNum = this.num * other.den + other.num * this.den;
                const newDen = this.den * other.den;
                return new Fraction(newNum, newDen);
            }
            subtract(other) {
                const newNum = this.num * other.den - other.num * this.den;
                const newDen = this.den * other.den;
                return new Fraction(newNum, newDen);
            }
            multiply(other) {
                return new Fraction(this.num * other.num, this.den * other.den);
            }
            divide(other) {
                return new Fraction(this.num * other.den, this.den * other.num);
            }
            toDecimal() {
                if (this.den === 0n) return 0;
                return Number(this.num) / Number(this.den);
            }
        }
        const MirasCalculator = {
            calculate: function (inputs) {
                let log = [];
                let estate = Number(inputs.estate) || 0;
                let funeral = Number(inputs.funeral) || 0;
                let debt = Number(inputs.debt) || 0;
                let willInput = Number(inputs.will) || 0;
                log.push({
                    title: "ابتدائی حساب کتاب",
                    details: `کل ترکہ: ${formatCurrency(estate)}`
                });
                let estateAfterExpenses = estate - funeral - debt;
                if (estateAfterExpenses < 0) estateAfterExpenses = 0;
                let maxWill = estateAfterExpenses / 3;
                let acceptedWill = Math.min(willInput, maxWill);
                let netEstate = estateAfterExpenses - acceptedWill;
                if (netEstate < 0) netEstate = 0;
                log.push({
                    title: "اخراجات اور وصیت کی کٹوتی",
                    details: `تجہیز و تکفین: ${formatCurrency(funeral)}<br>قرض کی ادائیگی: ${formatCurrency(debt)}<br>جائز وصیت: ${formatCurrency(acceptedWill)} (زیادہ سے زیادہ ${formatCurrency(maxWill)} تک)<br><strong>تقسیم کے لیے قابلِ عمل جائیداد: ${formatCurrency(netEstate)}</strong>`
                });
                if (netEstate === 0) {
                    log.push({ title: "نتیجہ", details: "کٹوتیوں کے بعد تقسیم کے لیے کوئی جائیداد باقی نہیں ہے۔" });
                    return { log, shares: [], finalTable: [] };
                }
                let h = { ...inputs.heirs };
                let excluded = new Set();
                const hasSon = h.sons > 0;
                const hasDaughter = h.daughters > 0;
                const hasDescendant = hasSon || hasDaughter;
                const hasMaleDescendant = hasSon;
                const hasFemaleDescendant = hasDaughter;
                if (hasSon) {
                    ['سگے بھائی', 'سگی بہنیں', 'باپ شریک بھائی', 'باپ شریک بہنیں', 'ماں شریک بھائی/بہنیں'].forEach(p => excluded.add(p));
                }
                if (h.father) {
                    ['دادا', 'سگے بھائی', 'سگی بہنیں', 'باپ شریک بھائی', 'باپ شریک بہنیں'].forEach(p => excluded.add(p));
                }
                if (hasDescendant || h.father || h.pGrandfather) {
                    excluded.add('ماں شریک بھائی/بہنیں');
                }
                if (h.fullBrothers > 0) {
                    ['باپ شریک بھائی', 'باپ شریک بہنیں'].forEach(p => excluded.add(p));
                }
                if (h.fullSisters > 0 && hasDaughter && !hasSon) {
                    excluded.add('باپ شریک بہنیں');
                }
                if (h.pGrandfather && !h.father) {
                    ['باپ شریک بھائی', 'باپ شریک بہنیں'].forEach(p => excluded.add(p));
                }
                let hajblog = "محروم ہونے والے ورثاء (حجب):<br>";
                hajblog += excluded.size > 0 ? [...excluded].join('، ') + ' قریب ترین وارث کی موجودگی کی وجہ سے محروم ہیں۔' : "کوئی وارث محروم نہیں ہوا۔";
                log.push({ title: "حجب (Exclusion)", details: hajblog });
                let shares = {};
                let asabaList = new Set();
                const ONE = new Fraction(1, 1);
                let fardSharesTotal = new Fraction(0, 1);
                const addShare = (heir, fraction) => {
                    shares[heir] = fraction;
                    fardSharesTotal = fardSharesTotal.add(fraction);
                };
                if (h.husband) addShare('شوہر', hasDescendant ? new Fraction(1, 4) : new Fraction(1, 2));
                if (h.wives > 0) addShare(`بیوی/بیاں (${h.wives})`, hasDescendant ? new Fraction(1, 8) : new Fraction(1, 4));
                if (h.mother) {
                    const hasMultipleSiblings = (h.fullBrothers + h.fullSisters + h.paternalBrothers + h.paternalSisters + h.uterineSiblings) >= 2;
                    if (hasDescendant || hasMultipleSiblings) addShare('ماں', new Fraction(1, 6));
                    else addShare('ماں', new Fraction(1, 3));
                }
                if (h.father) {
                    if (hasMaleDescendant) addShare('باپ', new Fraction(1, 6));
                    else { asabaList.add('باپ'); if (hasFemaleDescendant) addShare('باپ', new Fraction(1, 6)); }
                }
                if (h.pGrandfather && !h.father) {
                    if (hasMaleDescendant) addShare('دادا', new Fraction(1, 6));
                    else { asabaList.add('دادا'); if (hasFemaleDescendant) addShare('دادا', new Fraction(1, 6)); }
                }
                if (h.mGrandmother && !h.mother) addShare('نانی', new Fraction(1, 6));
                if (h.pGrandmother && !h.mother) addShare('دادی', new Fraction(1, 6));
                if (hasSon) {
                    asabaList.add('بیٹے'); asabaList.add('بیٹیاں');
                } else if (h.daughters > 0) {
                    if (h.daughters === 1) addShare('بیٹی (1)', new Fraction(1, 2));
                    else addShare(`بیٹیاں (${h.daughters})`, new Fraction(2, 3));
                }
                if (!hasMaleDescendant && !h.father && !h.pGrandfather) {
                    if (h.fullBrothers > 0 && !excluded.has('سگے بھائی')) { asabaList.add('سگے بھائی'); asabaList.add('سگی بہنیں'); }
                    else if (h.fullSisters > 0 && !excluded.has('سگی بہنیں')) {
                        if (hasFemaleDescendant) { asabaList.add('سگی بہنیں'); }
                        else {
                            if (h.fullSisters === 1) addShare(`سگی بہن (1)`, new Fraction(1, 2));
                            else addShare(`سگی بہنیں (${h.fullSisters})`, new Fraction(2, 3));
                        }
                    }
                    if (h.uterineSiblings > 0 && !excluded.has('ماں شریک بھائی/بہنیں')) {
                        if (h.uterineSiblings === 1) addShare('ماں شریک بھائی/بہن (1)', new Fraction(1, 6));
                        else addShare(`ماں شریک بھائی/بہنیں (${h.uterineSiblings})`, new Fraction(1, 3));
                    }
                }
                let fardLog = "اصحاب الفروض (مقررہ حصے):<br>";
                Object.keys(shares).forEach(key => { fardLog += `${key}: ${shares[key].toString()}<br>`; });
                if (Object.keys(shares).length === 0) fardLog = "کوئی اصحاب الفروض وارث موجود نہیں۔";
                log.push({ title: "مقررہ حصے", details: fardLog });
                let remainder = ONE.subtract(fardSharesTotal);
                if (fardSharesTotal.num > fardSharesTotal.den) {
                    log.push({ title: "عول (Awl) کا اطلاق", details: `حصوں کا مجموعہ (${fardSharesTotal.toString()}) کل ترکہ سے بڑھ گیا ہے۔ تمام حصوں کو متناسب طور پر (${fardSharesTotal.toString()}) کی بنیاد پر کم کیا جائے گا۔` });
                    Object.keys(shares).forEach(key => {
                        shares[key] = shares[key].divide(fardSharesTotal);
                    });
                }
                else if (remainder.num > 0n && asabaList.size > 0) {
                    let asabaLog = "بقیہ حصہ (" + remainder.toString() + ") عصبات کو دیا جائے گا: " + [...asabaList].join(', ');
                    log.push({ title: "عصبات (Residuary)", details: asabaLog });
                    if (asabaList.has('بیٹے')) {
                        let parts = h.sons * 2 + h.daughters * 1;
                        if (h.sons > 0) shares['بیٹے'] = remainder.multiply(new Fraction(h.sons * 2, parts));
                        if (h.daughters > 0) shares['بیٹیاں'] = remainder.multiply(new Fraction(h.daughters, parts));
                    } else if (asabaList.has('باپ')) {
                        shares['باپ'] = (shares['باپ'] || new Fraction(0)).add(remainder);
                    } else if (asabaList.has('سگے بھائی')) {
                        let parts = h.fullBrothers * 2 + h.fullSisters * 1;
                        if (h.fullBrothers > 0) shares['سگے بھائی'] = remainder.multiply(new Fraction(h.fullBrothers * 2, parts));
                        if (h.fullSisters > 0) shares['سگی بہنیں'] = remainder.multiply(new Fraction(h.fullSisters, parts));
                    } else if (asabaList.has('سگی بہنیں')) {
                        shares['سگی بہنیں'] = remainder;
                    }
                }
                else if (remainder.num > 0n) {
                    let raddHeirs = {};
                    let raddTotal = new Fraction(0, 1);
                    Object.keys(shares).forEach(key => {
                        if (!key.includes('شوہر') && !key.includes('بیوی')) {
                            raddHeirs[key] = shares[key];
                            raddTotal = raddTotal.add(shares[key]);
                        }
                    });
                    if (raddTotal.num > 0n) {
                        log.push({ title: "رد (Radd) کا اطلاق", details: `کوئی عصبہ نہیں، لہذا بچا ہوا حصہ (${remainder.toString()}) مقررہ ورثاء (ماسوائے زوجین) میں ان کے حصوں کی نسبت سے تقسیم کیا جائے گا۔` });
                        Object.keys(raddHeirs).forEach(key => {
                            let raddPortion = remainder.multiply(shares[key].divide(raddTotal));
                            shares[key] = shares[key].add(raddPortion);
                        });
                    }
                }
                let finalTable = [];
                let totalAmount = 0;
                Object.keys(shares).forEach(key => {
                    const fraction = shares[key];
                    const amount = netEstate * fraction.toDecimal();
                    totalAmount += amount;
                    finalTable.push({
                        heir: key,
                        share: fraction.toString(),
                        amount: formatCurrency(amount)
                    });
                });
                finalTable.push({
                    heir: 'کل تقسیم شدہ',
                    share: '',
                    amount: formatCurrency(totalAmount),
                    isTotal: true
                });
                if (Math.abs(netEstate - totalAmount) > 0.01 && netEstate > 0) {
                    finalTable.push({
                        heir: 'غیر تقسیم شدہ / راؤنڈنگ فرق',
                        share: '',
                        amount: formatCurrency(netEstate - totalAmount),
                        isTotal: false
                    });
                }
                return { log, finalTable };
            },
            renderResult: function (result, resultArea) {
                resultArea.innerHTML = '';
                result.log.forEach(entry => {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'result-step';
                    stepDiv.innerHTML = `<h4><i class="bi bi-check2-circle"></i> ${entry.title}</h4><p>${entry.details}</p>`;
                    resultArea.appendChild(stepDiv);
                });
                if (result.finalTable && result.finalTable.length > 0) {
                    const tableDiv = document.createElement('div');
                    tableDiv.className = 'result-step';
                    let tableHTML = `<h4><i class="bi bi-table"></i> حتمی تقسیم کا جدول</h4><div class="table-container"><table id="miras-final-table"><thead><tr><th>وارث</th><th>حصہ (نسبت)</th><th>رقم</th></tr></thead><tbody>`;
                    result.finalTable.forEach(row => {
                        tableHTML += `<tr class="${row.isTotal ? 'total-row' : ''}"><td>${row.heir}</td><td>${row.share}</td><td>${row.amount}</td></tr>`;
                    });
                    tableHTML += `</tbody></table></div>`;
                    tableDiv.innerHTML = tableHTML;
                    resultArea.appendChild(tableDiv);
                }
                resultArea.style.display = 'block';
                resultArea.scrollIntoView({ behavior: 'smooth' });
            }
        };
        function setupMirasListener() {
            document.getElementById('miras-form').addEventListener('submit', event => {
                event.preventDefault();
                const inputs = {
                    estate: document.getElementById('miras-estate').value,
                    funeral: document.getElementById('miras-funeral').value,
                    debt: document.getElementById('miras-debt').value,
                    will: document.getElementById('miras-will').value,
                    heirs: {
                        husband: document.querySelector('input[name="spouse"]:checked').value === 'husband',
                        wives: document.querySelector('input[name="spouse"]:checked').value === 'wife' ? parseInt(document.getElementById('miras-wives').value) : 0,
                        sons: parseInt(document.getElementById('miras-sons').value) || 0,
                        daughters: parseInt(document.getElementById('miras-daughters').value) || 0,
                        father: document.getElementById('miras-father').checked,
                        mother: document.getElementById('miras-mother').checked,
                        pGrandfather: document.getElementById('miras-paternal-grandfather').checked,
                        mGrandmother: document.getElementById('miras-maternal-grandmother').checked,
                        pGrandmother: document.getElementById('miras-paternal-grandmother').checked,
                        fullBrothers: parseInt(document.getElementById('miras-full-brothers').value) || 0,
                        fullSisters: parseInt(document.getElementById('miras-full-sisters').value) || 0,
                        paternalBrothers: parseInt(document.getElementById('miras-paternal-brothers').value) || 0,
                        paternalSisters: parseInt(document.getElementById('miras-paternal-sisters').value) || 0,
                        uterineSiblings: parseInt(document.getElementById('miras-uterine-siblings').value) || 0,
                    },
                    conditions: {
                        isKiller: document.getElementById('miras-killer').checked,
                        isNonMuslim: document.getElementById('miras-non-muslim').checked,
                    }
                };
                if (!inputs.estate) {
                    showToast('براہ کرم کل جائیداد کی رقم درج کریں۔', 'error');
                    return;
                }
                if (inputs.conditions.isKiller || inputs.conditions.isNonMuslim) {
                    showToast('نوٹ: قاتل اور غیر مسلم ورثاء کو وراثت سے خارج کر دیا جاتا ہے۔ کیلکولیشن یہ فرض کر رہی ہے کہ آپ نے ایسے ورثاء کو شمار نہیں کیا ہے۔', 'info');
                }
                const result = MirasCalculator.calculate(inputs);
                const resultArea = document.getElementById('miras-result-area');
                MirasCalculator.renderResult(result, resultArea);
            });
        }
        async function renderDashboard() {
            updateAnniversaryReminder();
            const store = getStore(STORES.calculations, 'readonly');
            const calculations = (await dbRequest(store.getAll())).sort((a, b) => b.year - a.year);
            const dueEl = document.getElementById('summary-due-amount');
            const paidEl = document.getElementById('summary-paid-amount');
            const remainingEl = document.getElementById('summary-remaining-amount');
            if (calculations.length === 0) {
                dueEl.textContent = paidEl.textContent = remainingEl.textContent = 'کوئی حساب نہیں';
                renderPaymentCategoryChart([]);
                return
            }
            const latestCalc = calculations[0];
            const paymentsStore = getStore(STORES.payments, 'readonly');
            const index = paymentsStore.index('year_idx');
            const payments = await dbRequest(index.getAll(IDBKeyRange.only(latestCalc.year)));
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            const remaining = latestCalc.isZakatDue ? Math.max(0, latestCalc.zakatAmount - totalPaid) : 0;
            dueEl.textContent = formatCurrency(latestCalc.zakatAmount);
            paidEl.textContent = formatCurrency(totalPaid);
            remainingEl.textContent = formatCurrency(remaining);
            renderPaymentCategoryChart(payments);
            await renderMilestones();
        }
        function renderPaymentCategoryChart(payments) {
            const canvas = document.getElementById('payment-category-chart');
            const placeholder = document.getElementById('payment-chart-placeholder');
            if (paymentChart) paymentChart.destroy();
            if (payments.length === 0) {
                canvas.style.display = 'none';
                placeholder.style.display = 'block';
                return
            }
            canvas.style.display = 'block';
            placeholder.style.display = 'none';
            const categories = payments.reduce((acc, p) => {
                const category = p.category || 'غیر زمرہ بند';
                acc[category] = (acc[category] || 0) + p.amount;
                return acc
            }, {});
            paymentChart = new Chart(canvas.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: ['#006400', '#28a745', '#ffc107', '#17a2b8', '#6c757d', '#dc3545'],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    family: "'Noto Nastaliq Urdu', serif"
                                }
                            }
                        },
                        tooltip: {
                            rtl: true,
                            textDirection: 'rtl',
                            bodyFont: {
                                family: "'Noto Nastaliq Urdu', serif"
                            }
                        }
                    }
                }
            })
        }
        function updatePriceInfoInCalculator() {
            const infoDiv = document.getElementById('calc-info-prices');
            if (appState.settings.goldPrice > 0 && appState.settings.silverPrice > 0) {
                infoDiv.innerHTML = `<i class="bi bi-info-circle"></i> موجودہ قیمتیں: سونا: ${formatCurrency(appState.settings.goldPrice)}، چاندی: ${formatCurrency(appState.settings.silverPrice)} فی تولہ۔`;
                infoDiv.style.borderColor = 'var(--info-color)'
            } else {
                infoDiv.innerHTML = `<i class="bi bi-exclamation-triangle"></i> براہ کرم 'سیٹنگز' میں سونے اور چاندی کی قیمتیں درج کریں۔`;
                infoDiv.style.borderColor = 'var(--warning-color)'
            }
        }
        async function renderCalculationHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = ``;
            try {
                const calculations = (await dbRequest(getStore(STORES.calculations, 'readonly').getAll())).sort((a, b) => b.year - a.year);
                if (calculations.length === 0) {
                    list.innerHTML = `<p class="placeholder-text">کوئی حسابی ریکارڈ موجود نہیں ہے۔</p>`;
                    return
                }
                list.innerHTML = calculations.map(calc => `<div class="history-item" onclick="showCalculationDetails(${calc.year})"><h3>سال: ${calc.year}</h3><span>${formatCurrency(calc.zakatAmount)}</span></div>`).join('')
            } catch (error) {
                list.innerHTML = `<p class="placeholder-text error-message">تاریخ لوڈ کرنے میں خرابی۔</p>`
            }
        }
        async function showCalculationDetails(year) {
            const calc = await dbRequest(getStore(STORES.calculations, 'readonly').get(year));
            if (!calc) return;
            document.getElementById('details-modal-title').innerText = `سال ${year} کی تفصیلات`;
            const body = document.getElementById('details-modal-body');
            body.innerHTML = `<table><tbody><tr><td>سونا (${calc.goldKarat}k)</td><td>${calc.gold} تولہ</td></tr><tr><td>چاندی</td><td>${calc.silver} تولہ</td></tr><tr><td>نقد رقم</td><td>${formatCurrency(calc.cash)}</td></tr><tr><td>مالِ تجارت</td><td>${formatCurrency(calc.businessGoods)}</td></tr><tr><td>وصول طلب قرضے</td><td>${formatCurrency(calc.receivables)}</td></tr><tr><td style="color:var(--error-color);">واجب الادا قرضے (منہا)</td><td style="color:var(--error-color);">${formatCurrency(calc.liabilities)}</td></tr><tr><td colspan="2"><hr></td></tr><tr><td>کل قابلِ زکوٰۃ اثاثے</td><td><strong>${formatCurrency(calc.zakatableAssets)}</strong></td></tr><tr><td>واجب الادا زکوٰۃ (2.5%)</td><td><strong>${formatCurrency(calc.zakatAmount)}</strong></td></tr></tbody></table>`;
            toggleModal('details-modal', true)
        }
        async function renderPaymentHistory() {
            const tbody = document.getElementById('payment-history-table-body');
            const year = document.getElementById('payment-history-year-filter').value;
            tbody.innerHTML = `<tr><td colspan="7" class="placeholder-text">لوڈ ہو رہا ہے...</td></tr>`;
            try {
                const store = getStore(STORES.payments, 'readonly');
                let payments;
                if (year) {
                    payments = await dbRequest(store.index('year_idx').getAll(IDBKeyRange.only(Number(year))))
                } else {
                    payments = await dbRequest(store.getAll())
                }
                payments.sort((a, b) => new Date(b.date) - new Date(a.date));
                if (payments.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7" class="placeholder-text">کوئی ادائیگی ریکارڈ موجود نہیں ہے۔</td></tr>`;
                    return
                }
                tbody.innerHTML = payments.map(p => `<tr><td>${p.year}</td><td>${new Date(p.date).toLocaleDateString('ur-PK')}</td><td>${formatCurrency(p.amount)}</td><td>${p.recipient || '-'}</td><td>${p.category || '-'}</td><td>${p.notes || '-'}</td><td><button class="secondary small" onclick="editPayment(${p.id})"><i class="bi bi-pencil-fill"></i></button><button class="danger small" onclick="confirmDeletePayment(${p.id})"><i class="bi bi-trash-fill"></i></button></td></tr>`).join('')
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="7" class="placeholder-text error-message">ادائیگیوں کی تاریخ لوڈ کرنے میں خرابی۔</td></tr>`
            }
        }
        function confirmDeletePayment(id) {
            showConfirmation('حذف کریں؟', 'کیا آپ واقعی اس ادائیگی کو حذف کرنا چاہتے ہیں؟', async () => {
                try {
                    await deleteData(STORES.payments, id);
                    showToast('ادائیگی حذف کر دی گئی۔', 'success');
                    renderPaymentHistory()
                } catch (error) {
                    showToast('ادائیگی حذف کرنے میں خرابی۔', 'error')
                }
            })
        }
        async function editPayment(id) {
            const payment = await dbRequest(getStore(STORES.payments, 'readonly').get(id));
            if (!payment) {
                showToast('ادائیگی نہیں ملی۔', 'error');
                return
            }
            appState.isEditingPayment = id;
            document.getElementById('payment-year').value = payment.year;
            document.getElementById('payment-amount').value = payment.amount;
            document.getElementById('payment-date').value = payment.date;
            document.getElementById('payment-recipient').value = payment.recipient;
            document.getElementById('payment-category').value = payment.category;
            document.getElementById('payment-impact-tag').value = payment.impactTag || 'none';
            document.getElementById('payment-notes').value = payment.notes;
            const submitBtn = document.querySelector('#payment-form button[type="submit"]');
            submitBtn.innerHTML = '<i class="bi bi-check-lg"></i> اپڈیٹ کریں';
            submitBtn.scrollIntoView({
                behavior: 'smooth'
            })
        }
        async function populateYearFilter(filterId, allOptionText) {
            const select = document.getElementById(filterId);
            select.innerHTML = `<option value="">${allOptionText}</option>`;
            const calcs = await dbRequest(getStore(STORES.calculations, 'readonly').getAll());
            const years = new Set(calcs.map(c => c.year));
            Array.from(years).sort((a, b) => b - a).forEach(year => {
                select.innerHTML += `<option value="${year}">${year}</option>`
            })
        }
        const populatePaymentHistoryYearFilter = () => populateYearFilter('payment-history-year-filter', 'تمام سال');
        const populateReportYearFilter = () => populateYearFilter('report-year-filter', 'سال منتخب کریں');
        async function populatePaymentYearSelect() {
            const select = document.getElementById('payment-year');
            select.innerHTML = '<option value="">سال منتخب کریں</option>';
            const calculations = await dbRequest(getStore(STORES.calculations, 'readonly').getAll());
            const payments = await dbRequest(getStore(STORES.payments, 'readonly').getAll());
            const paymentMap = payments.reduce((acc, p) => {
                acc[p.year] = (acc[p.year] || 0) + p.amount;
                return acc
            }, {});
            const allYears = new Set([...calculations.map(c => c.year), ...payments.map(p => p.year)]);
            Array.from(allYears).sort((a, b) => b - a).forEach(year => {
                const calcForYear = calculations.find(c => c.year === year);
                let label = String(year);
                if (calcForYear && calcForYear.zakatAmount > (paymentMap[year] || 0)) {
                    label += ` (بقایا)`
                }
                select.innerHTML += `<option value="${year}">${label}</option>`
            })
        }
        async function populateRecipientSuggestions() {
            const datalist = document.getElementById('recipient-suggestions');
            const payments = await dbRequest(getStore(STORES.payments, 'readonly').getAll());
            const recipients = new Set(payments.map(p => p.recipient).filter(Boolean));
            datalist.innerHTML = '';
            recipients.forEach(r => {
                datalist.innerHTML += `<option value="${r}">`
            })
        }
        async function setDefaultPaymentYear() {
            const calcs = await dbRequest(getStore(STORES.calculations, 'readonly').getAll());
            const payments = await dbRequest(getStore(STORES.payments, 'readonly').getAll());
            const paymentMap = payments.reduce((acc, p) => {
                acc[p.year] = (acc[p.year] || 0) + p.amount;
                return acc
            }, {});
            const yearsWithDue = calcs.filter(c => c.zakatAmount > (paymentMap[c.year] || 0)).map(c => c.year).sort((a, b) => b - a);
            let yearToSelect = '';
            const currentYear = new Date().getFullYear();
            if (yearsWithDue.includes(currentYear)) {
                yearToSelect = currentYear
            } else if (yearsWithDue.length > 0) {
                yearToSelect = yearsWithDue[0]
            }
            if (yearToSelect) {
                document.getElementById('payment-year').value = yearToSelect;
                document.getElementById('payment-history-year-filter').value = yearToSelect;
                await renderPaymentHistory();
                await autofillPaymentAmount();
            } else {
                document.getElementById('payment-amount').value = '';
            }
        }
        async function updateHeaderIslamicDate() {
            const displayElement = document.getElementById('islamic-date-display');
            try {
                const todayGregorianString = new Date().toISOString().slice(0, 10);
                const currentIslamicDate = await getIslamicDateFromGregorian(todayGregorianString);
                if (!currentIslamicDate) {
                    displayElement.textContent = '';
                    return;
                }
                const hijriMonths = ["محرم", "صفر", "ربیع الاول", "ربیع الثانی", "جمادی الاولی", "جمادی الآخر", "رجب", "شعبان", "رمضان", "شوال", "ذوالقعدة", "ذوالحجة"];
                const [day, month, year] = currentIslamicDate.split('-').map(Number);
                const formattedCurrentDate = `${day} ${hijriMonths[month - 1]} ${year}ھ`;
                let displayText = `موجودہ اسلامی تاریخ: ${formattedCurrentDate}`;
                const anniversaryIslamic = appState.settings.zakatAnniversaryIslamic;
                if (anniversaryIslamic) {
                    const [annivDay, annivMonth] = anniversaryIslamic.split('-').map(Number);
                    let targetIslamicYear = year;
                    if (month > annivMonth || (month === annivMonth && day > annivDay)) {
                        targetIslamicYear++;
                    }
                    const formattedAnnivMonth = hijriMonths[annivMonth - 1];
                    const nextZakatDate = `${annivDay} ${formattedAnnivMonth} ${targetIslamicYear}ھ`;
                    displayText += ` (آپکی اگلی زکوٰۃ: ${nextZakatDate})`;
                }
                displayElement.textContent = displayText;
            } catch (error) {
                console.error("Error updating header Islamic date:", error);
                displayElement.textContent = 'اسلامی تاریخ لوڈ نہیں ہو سکی۔';
            }
        }
        async function calculateHijriAge(event) {
            event.preventDefault();
            const birthDateGregorian = document.getElementById('birth-date-gregorian').value;
            const resultArea = document.getElementById('hijri-age-result');
            if (!birthDateGregorian) {
                showToast('براہ کرم تاریخ پیدائش درج کریں۔', 'error');
                return;
            }
            try {
                resultArea.innerHTML = `<p class="placeholder-text">حساب لگایا جا رہا ہے...</p>`;
                resultArea.style.display = 'block';
                const [birthDateHijri, currentDateHijri] = await Promise.all([
                    getIslamicDateFromGregorian(birthDateGregorian),
                    getIslamicDateFromGregorian(new Date().toISOString().slice(0, 10))
                ]);
                if (!birthDateHijri || !currentDateHijri) {
                    showToast('ہجری تاریخ حاصل کرنے میں ناکامی۔ براہ کرم دوبارہ کوشش کریں۔', 'error');
                    resultArea.style.display = 'none';
                    return;
                }
                const [birthDay, birthMonth, birthYear] = birthDateHijri.split('-').map(Number);
                const [currentDay, currentMonth, currentYear] = currentDateHijri.split('-').map(Number);
                let age = currentYear - birthYear;
                if (currentMonth < birthMonth || (currentMonth === birthMonth && currentDay < birthDay)) {
                    age--;
                }
                const hijriMonths = ["محرم", "صفر", "ربیع الاول", "ربیع الثانی", "جمادی الاولی", "جمادی الآخر", "رجب", "شعبان", "رمضان", "شوال", "ذوالقعدة", "ذوالحجة"];
                const formattedBirthDateHijri = `${birthDay} ${hijriMonths[birthMonth - 1]} ${birthYear}ھ`;
                resultArea.innerHTML = `
                    <h3>نتیجہ</h3>
                    <ul>
                        <li>آپ کی تاریخ پیدائش (ہجری): <strong>${formattedBirthDateHijri}</strong></li>
                        <li>آپ کی موجودہ ہجری عمر تقریباً: <strong>${age} سال</strong></li>
                    </ul>
                `;
                resultArea.style.display = 'block';
            } catch (error) {
                console.error("Hijri age calculation error:", error);
                showToast('عمر کا حساب لگانے میں خرابی۔', 'error');
                resultArea.style.display = 'none';
            }
        }
        async function getGregorianDateFromIslamic(islamicDateString) {
            const cacheKey = `gregorianDate_from_islamic_${islamicDateString}`;
            const cachedGregorianDate = localStorage.getItem(cacheKey);
            if (cachedGregorianDate) {
                console.log(`DEBUG: Gregorian date found in cache for Islamic date ${islamicDateString}:`, cachedGregorianDate);
                return cachedGregorianDate;
            }
            try {
                const response = await fetch(`https://api.aladhan.com/v1/hToG/${islamicDateString}`);
                if (!response.ok) {
                    console.error(`DEBUG: API Response not OK for hToG. Status: ${response.status}`);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const responseData = await response.json();
                console.log('DEBUG: Parsed API Response Data for hToG:', responseData);
                if (responseData && responseData.data) {
                    let gregorianData = null;
                    if (Array.isArray(responseData.data) && responseData.data.length > 0 && responseData.data[0].gregorian) {
                        gregorianData = responseData.data[0].gregorian;
                        console.log('DEBUG: Found gregorian data in array format (hToG).');
                    } else if (typeof responseData.data === 'object' && responseData.data.gregorian) {
                        gregorianData = responseData.data.gregorian;
                        console.log('DEBUG: Found gregorian data in object format (hToG).');
                    }
                    if (gregorianData && gregorianData.date) {
                        const [day, month, year] = gregorianData.date.split('-');
                        const gregorianDate = `${year}-${month}-${day}`;
                        localStorage.setItem(cacheKey, gregorianDate);
                        console.log("DEBUG: Gregorian date successfully extracted and cached from hToG:", gregorianDate);
                        return gregorianDate;
                    }
                }
                console.warn("DEBUG: Could not find valid gregorian data within responseData.data for hToG.", responseData);
                return null;
            } catch (error) {
                console.error("DEBUG: Error fetching Gregorian date from Islamic API:", error);
                return null;
            }
        }
        async function generateReport() {
            const year = document.getElementById('report-year-filter').value;
            const area = document.getElementById('report-area');
            area.style.display = 'none';
            if (year) {
                const calc = await dbRequest(getStore(STORES.calculations, 'readonly').get(Number(year)));
                if (!calc) {
                    area.innerHTML = `<p class="placeholder-text">سال ${year} کا ریکارڈ نہیں۔</p>`;
                    area.style.display = 'block';
                    return
                }
                const payments = await dbRequest(getStore(STORES.payments, 'readonly').index('year_idx').getAll(IDBKeyRange.only(Number(year))));
                const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
                const remaining = calc.isZakatDue ? Math.max(0, calc.zakatAmount - totalPaid) : 0;
                const impactCounts = payments.reduce((acc, p) => {
                    if (p.impactTag && p.impactTag !== 'none') {
                        acc[p.impactTag] = (acc[p.impactTag] || 0) + 1;
                    }
                    return acc;
                }, {});
                let impactSummaryHtml = '';
                if (Object.keys(impactCounts).length > 0) {
                    const impactItems = Object.entries(impactCounts).map(([tag, count]) => `<li><strong>${tag}:</strong> ${count} مرتبہ</li>`).join('');
                    impactSummaryHtml = `<div class="card" style="margin-top:1rem"><h3>اثرات کا خلاصہ</h3><p>اس سال آپ کی ادائیگیوں نے مندرجہ ذیل شعبوں میں مدد فراہم کی:</p><ul>${impactItems}</ul></div>`;
                }
                area.innerHTML = `<h2>سال ${year} کی زکوٰۃ رپورٹ</h2><div class="card"><h3>خلاصہ</h3><table><tbody><tr><td>واجب الادا زکوٰۃ</td><td>${formatCurrency(calc.zakatAmount)}</td></tr><tr><td>ادا شدہ زکوٰۃ</td><td>${formatCurrency(totalPaid)}</td></tr><tr><td>بقیہ زکوٰۃ</td><td style="color:${remaining > 0 ? 'var(--error-color)' : 'var(--success-color)'}; font-weight: bold;">${formatCurrency(remaining)}</td></tr></tbody></table></div><div class="card" style="margin-top:1rem"><h3>ادائیگیوں کی تفصیل</h3>${payments.length > 0 ? `<table><thead><th>تاریخ</th><th>رقم</th><th>وصول کنندہ</th><th>کیٹیگری</th></thead><tbody>${payments.map(p => `<tr><td>${new Date(p.date).toLocaleDateString('ur-PK')}</td><td>${formatCurrency(p.amount)}</td><td>${p.recipient || '-'}</td><td>${p.category || '-'}</td></tr>`).join('')}</tbody></table>` : `<p class="placeholder-text">اس سال کوئی ادائیگی نہیں کی گئی۔</p>`}</div>${impactSummaryHtml}`;
                area.style.display = 'block'
            }
            const calcs = await dbRequest(getStore(STORES.calculations, 'readonly').getAll());
            if (calcs.length > 0) {
                document.getElementById('yearly-comparison-chart').style.display = 'block';
                document.getElementById('yearly-chart-placeholder').style.display = 'none';
                const allPayments = await dbRequest(getStore(STORES.payments, 'readonly').getAll());
                renderYearlyComparisonChart(calcs, allPayments)
            } else {
                document.getElementById('yearly-comparison-chart').style.display = 'none';
                document.getElementById('yearly-chart-placeholder').style.display = 'block'
            }
        }
        function renderYearlyComparisonChart(calculations, allPayments) {
            if (yearlyChart) yearlyChart.destroy();
            const sortedCalcs = calculations.sort((a, b) => a.year - b.year);
            const labels = sortedCalcs.map(c => c.year);
            const dueData = sortedCalcs.map(c => c.zakatAmount);
            const paidData = sortedCalcs.map(c => {
                return allPayments.filter(p => p.year === c.year).reduce((sum, p) => sum + p.amount, 0)
            });
            yearlyChart = new Chart(document.getElementById('yearly-comparison-chart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'واجب الادا زکوٰۃ',
                        data: dueData,
                        backgroundColor: 'rgba(220, 53, 69, 0.7)',
                        borderColor: 'var(--error-color)',
                        borderWidth: 1
                    }, {
                        label: 'ادا شدہ زکوٰۃ',
                        data: paidData,
                        backgroundColor: 'rgba(40, 167, 69, 0.7)',
                        borderColor: 'var(--success-color)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    family: "'Noto Nastaliq Urdu', serif"
                                }
                            }
                        },
                        tooltip: {
                            rtl: true,
                            textDirection: 'rtl',
                            bodyFont: {
                                family: "'Noto Nastaliq Urdu', serif"
                            }
                        }
                    }
                }
            })
        }
        async function exportData() {
            try {
                const dataToExport = {
                    settings: await dbRequest(getStore(STORES.settings, 'readonly').getAll()),
                    calculations: await dbRequest(getStore(STORES.calculations, 'readonly').getAll()),
                    payments: await dbRequest(getStore(STORES.payments, 'readonly').getAll())
                };
                const jsonString = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([jsonString], {
                    type: 'application/json'
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `zakat_backup_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('ڈیٹا کامیابی سے ایکسپورٹ ہو گیا۔', 'success')
            } catch (e) {
                showToast('ڈیٹا ایکسپورٹ کرنے میں خرابی۔', 'error')
            }
        }
        function importData() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            if (!file) return;
            document.getElementById('import-filename').textContent = file.name;
            showConfirmation('ڈیٹا امپورٹ کریں؟', 'موجودہ تمام ڈیٹا اوور رائٹ ہو جائے گا۔ کیا آپ واقعی آگے بڑھنا چاہتے ہیں؟', () => {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (!data.settings || !data.calculations || !data.payments) throw new Error("Invalid file structure");
                        const tx = db.transaction(Object.values(STORES), 'readwrite');
                        await Promise.all([dbRequest(tx.objectStore(STORES.settings).clear()), dbRequest(tx.objectStore(STORES.calculations).clear()), dbRequest(tx.objectStore(STORES.payments).clear())]);
                        await Promise.all([...data.settings.map(item => dbRequest(tx.objectStore(STORES.settings).put(item))), ...data.calculations.map(item => dbRequest(tx.objectStore(STORES.calculations).put(item))), ...data.payments.map(item => dbRequest(tx.objectStore(STORES.payments).put(item)))]);
                        showToast('ڈیٹا کامیابی سے امپورٹ ہو گیا۔ ایپ دوبارہ لوڈ کی جا رہی ہے۔', 'success');
                        setTimeout(() => window.location.reload(), 2000)
                    } catch (e) {
                        showToast('ڈیٹا امپورٹ کرنے میں خرابی۔', 'error')
                    } finally {
                        fileInput.value = '';
                        document.getElementById('import-filename').textContent = 'کوئی فائل منتخب نہیں'
                    }
                };
                reader.readAsText(file)
            })
        }
        async function updateAnniversaryReminder() {
            const reminderDiv = document.getElementById('anniversary-reminder');
            const anniversaryIslamic = appState.settings.zakatAnniversaryIslamic;
            if (!anniversaryIslamic) {
                reminderDiv.innerHTML = `<i class="bi bi-info-circle"></i> اپنی زکوٰۃ کی سالگرہ کی تاریخ 'سیٹنگز' میں درج کریں تاکہ آپ کو یاد دہانی کروائی جا سکے۔`;
                return;
            }
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayGregorianString = today.toISOString().slice(0, 10);
            const [annivDay, annivMonth, annivYear] = anniversaryIslamic.split('-').map(Number);
            let nextAnniversaryIslamicDate = null;
            const currentIslamicDate = await getIslamicDateFromGregorian(todayGregorianString);
            if (!currentIslamicDate) {
                reminderDiv.innerHTML = `<i class="bi bi-exclamation-triangle"></i> اسلامی تاریخ کی یاد دہانی دستیاب نہیں۔`;
                return;
            }
            const [currentDay, currentMonth, currentYear] = currentIslamicDate.split('-').map(Number);
            let targetIslamicYear = currentYear;
            if (currentMonth > annivMonth || (currentMonth === annivMonth && currentDay > annivDay)) {
                targetIslamicYear++;
            }
            nextAnniversaryIslamicDate = `${annivDay}-${annivMonth}-${targetIslamicYear}`;
            const nextAnniversaryGregorianString = await getGregorianDateFromIslamic(nextAnniversaryIslamicDate);
            if (!nextAnniversaryGregorianString) {
                reminderDiv.innerHTML = `<i class="bi bi-exclamation-triangle"></i> اسلامی سالگرہ کی گریگورین تاریخ حاصل کرنے میں ناکامی۔`;
                return;
            }
            const nextAnniversaryGregorian = new Date(nextAnniversaryGregorianString);
            nextAnniversaryGregorian.setHours(0, 0, 0, 0);
            const timeDiff = nextAnniversaryGregorian.getTime() - today.getTime();
            const daysRemaining = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
            let message = `<i class="bi bi-calendar-heart"></i> آپ کی اگلی زکوٰۃ کی اسلامی سالگرہ ${anniversaryIslamic} کو ہے۔`;
            if (daysRemaining === 0) {
                message = `<i class="bi bi-calendar-heart-fill"></i> آج آپ کی زکوٰۃ کی اسلامی سالگرہ ہے! اپنا حساب لگانا نہ بھولیں۔`;
            } else if (daysRemaining > 0) {
                message += ` (${daysRemaining} دن باقی ہیں)`;
            } else {
                message = `<i class="bi bi-calendar-heart"></i> آپ کی اگلی زکوٰۃ کی اسلامی سالگرہ ${anniversaryIslamic} کو ہے۔`;
            }
            reminderDiv.innerHTML = message;
        }
        function requestNotificationPermission() {
            if (!('Notification' in window)) {
                showToast('یہ براؤزر اطلاعات کو سپورٹ نہیں کرتا۔', 'error');
                return
            }
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    showToast('اطلاعات فعال کر دی گئی ہیں۔', 'success');
                    checkAndShowNotification()
                } else if (permission === "denied") {
                    showToast('اطلاعات بلاک ہیں۔ براہ کرم براؤزر سیٹنگز سے فعال کریں۔', 'warning')
                } else {
                    showToast('اطلاعات کی اجازت نہیں دی گئی۔', 'info')
                }
            })
        }
        async function checkAndShowNotification() {
            if (!('Notification' in window) || Notification.permission !== "granted" || !appState.settings.zakatAnniversaryIslamic) return;

            const notificationStateJSON = localStorage.getItem('zakatNotificationState');
            let lastNotifiedState = null;
            try {
                if (notificationStateJSON) {
                    lastNotifiedState = JSON.parse(notificationStateJSON);
                }
            } catch (e) {
                console.error("Could not parse notification state.", e);
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayGregorianString = today.toISOString().slice(0, 10);

            const anniversaryIslamic = appState.settings.zakatAnniversaryIslamic;
            const [annivDay, annivMonth] = anniversaryIslamic.split('-').map(Number);
            const currentIslamicDate = await getIslamicDateFromGregorian(todayGregorianString);

            if (!currentIslamicDate) {
                console.warn("DEBUG: Could not get current Islamic date for notification check.");
                return;
            }

            const [currentDay, currentMonth, currentYear] = currentIslamicDate.split('-').map(Number);
            let targetIslamicYear = currentYear;
            if (currentMonth > annivMonth || (currentMonth === annivMonth && currentDay > annivDay)) {
                targetIslamicYear++;
            }

            const nextAnniversaryIslamicDate = `${annivDay}-${annivMonth}-${targetIslamicYear}`;
            const nextAnniversaryGregorianString = await getGregorianDateFromIslamic(nextAnniversaryIslamicDate);

            if (!nextAnniversaryGregorianString) {
                console.warn("DEBUG: Could not get next Gregorian anniversary date for notification check.");
                return;
            }

            const nextAnniversaryGregorian = new Date(nextAnniversaryGregorianString);
            nextAnniversaryGregorian.setHours(0, 0, 0, 0);
            const timeDiff = nextAnniversaryGregorian.getTime() - today.getTime();
            const daysRemaining = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

            if (daysRemaining >= 0 && daysRemaining <= 20) {
                const shouldNotify = !lastNotifiedState || lastNotifiedState.year !== targetIslamicYear || lastNotifiedState.days !== daysRemaining;

                if (shouldNotify) {
                    console.log(`DEBUG: Sending notification for ${daysRemaining} days remaining.`);
                    let notificationBody = `آپ کی زکوٰۃ کی اسلامی سالگرہ ${anniversaryIslamic} کو ہے۔`;
                    if (daysRemaining === 0) {
                        notificationBody = `آج آپ کی زکوٰۃ کی اسلامی سالگرہ ہے! اپنا حساب لگانا نہ بھولیں۔`;
                    } else {
                        notificationBody += ` (${daysRemaining} دن باقی ہیں)`;
                    }

                    const reg = await navigator.serviceWorker.ready;
                    reg.showNotification('زکوٰۃ کی یاد دہانی', {
                        body: notificationBody,
                        icon: 'icons/icon-192x192.png',
                        tag: 'zakat-reminder'
                    });

                    localStorage.setItem('zakatNotificationState', JSON.stringify({ year: targetIslamicYear, days: daysRemaining }));
                } else {
                    console.log(`DEBUG: Notification already sent for ${daysRemaining} days remaining.`);
                }
            }
        }
        async function autofillPaymentAmount() {
            const yearSelect = document.getElementById('payment-year');
            const amountInput = document.getElementById('payment-amount');
            const year = yearSelect.value ? parseInt(yearSelect.value) : null;
            amountInput.value = '';
            if (!year) return;
            try {
                const calc = await dbRequest(getStore(STORES.calculations, 'readonly').get(year));
                if (!calc || !calc.isZakatDue) return;
                const payments = await dbRequest(getStore(STORES.payments, 'readonly').index('year_idx').getAll(IDBKeyRange.only(year)));
                const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
                const remaining = Math.max(0, calc.zakatAmount - totalPaid);
                if (remaining > 0) {
                    amountInput.value = remaining.toFixed(2)
                }
            } catch (error) {
                console.error("Failed to autofill payment amount:", error)
            }
        }
        async function getIslamicDateFromGregorian(gregorianDateString) {
            const cacheKey = `islamicDate_${gregorianDateString}`;
            const cachedIslamicDate = localStorage.getItem(cacheKey);
            if (cachedIslamicDate) {
                console.log(`DEBUG: Islamic date found in cache for ${gregorianDateString}:`, cachedIslamicDate);
                return cachedIslamicDate;
            }
            try {
                const [year, month, day] = gregorianDateString.split('-');
                const formattedDate = `${day}-${month}-${year}`;
                const response = await fetch(`https://api.aladhan.com/v1/gToH/${formattedDate}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const responseData = await response.json();
                let hijriData = null;
                if (responseData && responseData.data) {
                    if (Array.isArray(responseData.data) && responseData.data.length > 0 && responseData.data[0].hijri) {
                        hijriData = responseData.data[0].hijri;
                    }
                    else if (typeof responseData.data === 'object' && responseData.data.hijri) {
                        hijriData = responseData.data.hijri;
                    }
                }
                if (hijriData) {
                    const islamicDate = `${hijriData.day}-${hijriData.month.number}-${hijriData.year}`;
                    localStorage.setItem(cacheKey, islamicDate);
                    return islamicDate;
                } else {
                    return null;
                }
            } catch (error) {
                return null;
            }
        }
        function setupEventListeners() {
            setupMirasListener();
            document.getElementById('hijri-age-form').addEventListener('submit', calculateHijriAge);
            document.getElementById('ushr-form').addEventListener('submit', event => {
                event.preventDefault();
                const produceAmount = parseFloat(document.getElementById('produce-amount').value);
                const pricePerKg = parseFloat(document.getElementById('price-per-kg').value);
                const irrigationType = parseFloat(document.getElementById('irrigation-type').value);
                const resultArea = document.getElementById('ushr-result');
                if (isNaN(produceAmount) || isNaN(pricePerKg) || produceAmount <= 0 || pricePerKg <= 0) {
                    showToast("برائے مہربانی پیداوار اور قیمت کی درست مقدار درج کریں۔", "error");
                    return;
                }
                document.getElementById('produce-amount').addEventListener('input', () => {
                    const kg = parseFloat(document.getElementById('produce-amount').value) || 0;
                    const mannDisplay = document.getElementById('produce-amount-mann-display');
                    if (kg > 0) {
                        const mann = kg / 40;
                        mannDisplay.textContent = `≈ ${mann.toLocaleString('en-US', { maximumFractionDigits: 2 })} من`;
                    } else {
                        mannDisplay.textContent = '';
                    }
                });
                const nisabKg = 653;
                let resultHTML = '';
                if (produceAmount < nisabKg) {
                    resultHTML = `<h3>عشر واجب نہیں ہے</h3><p>پیداوار کی مقدار نصاب (${nisabKg} کلوگرام) سے کم ہے۔</p>`;
                } else {
                    const totalValue = produceAmount * pricePerKg;
                    const ushrAmount = totalValue * irrigationType;
                    const ushrInKg = produceAmount * irrigationType;
                    const ushrInMann = ushrInKg / 40;
                    const ushrRatePercent = irrigationType * 100;
                    resultHTML = `
            <h3>نتیجہ</h3>
            <ul>
                <li>پیداوار کی کل مالیت: <strong>${formatCurrency(totalValue)}</strong></li>
                <li>لاگو شرح: <strong>${ushrRatePercent}%</strong></li>
            </ul>
            <h4 style="margin-top:1rem">واجب الادا عشر</h4>
            <ul>
                <li>مالیت میں: <strong>${formatCurrency(ushrAmount)}</strong></li>
                <li>پیداوار میں: <strong>${ushrInKg.toLocaleString('en-US', { maximumFractionDigits: 2 })} کلوگرام</strong> (تقریباً ${ushrInMann.toLocaleString('en-US', { maximumFractionDigits: 2 })} من)</li>
            </ul>
        `;
                }
                resultArea.innerHTML = resultHTML;
                resultArea.style.display = 'block';
            });
            document.getElementById('zakat-form').addEventListener('submit', event => {
                event.preventDefault();
                if ((parseFloat(document.getElementById('gold').value) > 0 && appState.settings.goldPrice <= 0) || appState.settings.silverPrice <= 0) {
                    showToast("براہ کرم پہلے 'سیٹنگز' میں سونے اور چاندی کی درست قیمتیں درج کریں۔", 'error');
                    showTab('settings');
                    return
                }
                const data = {
                    year: parseInt(document.getElementById('year').value),
                    goldKarat: parseInt(document.getElementById('gold-karat').value),
                    gold: parseFloat(document.getElementById('gold').value) || 0,
                    silver: parseFloat(document.getElementById('silver').value) || 0,
                    cash: parseFloat(document.getElementById('cash').value) || 0,
                    businessGoods: parseFloat(document.getElementById('business-goods').value) || 0,
                    receivables: parseFloat(document.getElementById('receivables').value) || 0,
                    liabilities: parseFloat(document.getElementById('liabilities').value) || 0,
                };
                if (!data.year) {
                    showToast("براہ کرم ایک درست سال درج کریں۔", 'error');
                    return
                }
                displayCalculationResult(calculateZakat(data, appState.settings, appState.settings));
            });
            document.getElementById('settings-form').addEventListener('submit', async event => {
                event.preventDefault();
                const settingsData = {
                    id: 'current',
                    goldPrice: parseFloat(document.getElementById('gold-price').value),
                    silverPrice: parseFloat(document.getElementById('silver-price').value),
                    currencySymbol: document.getElementById('currency-symbol').value,
                    zakatAnniversary: document.getElementById('zakat-anniversary').value,
                    calculationMethod: document.getElementById('calculation-method').value
                };
                if (isNaN(settingsData.goldPrice) || isNaN(settingsData.silverPrice) || !settingsData.currencySymbol) {
                    showToast("براہ کرم درست قیمتیں اور کرنسی کی علامت درج کریں۔", 'error');
                    return
                }
                if (settingsData.zakatAnniversary) {
                    try {
                        const islamicDate = await getIslamicDateFromGregorian(settingsData.zakatAnniversary);
                        if (islamicDate) {
                            settingsData.zakatAnniversaryIslamic = islamicDate;
                        } else {
                            showToast("اسلامی تاریخ حاصل کرنے میں ناکامی۔", 'warning');
                        }
                    } catch (error) {
                        console.error("Error fetching Islamic date:", error);
                        showToast("اسلامی تاریخ حاصل کرنے میں خرابی۔", 'error');
                    }
                } else {
                    settingsData.zakatAnniversaryIslamic = null;
                }
                await saveData(STORES.settings, settingsData);
                appState.settings = settingsData;
                showToast("سیٹنگز محفوظ ہو گئیں۔", 'success');
                updatePriceInfoInCalculator();
                updateAnniversaryReminder();
                updateHeaderIslamicDate();
                checkAndShowNotification()
            });
            document.getElementById('create-plan-btn').addEventListener('click', () => {
                document.getElementById('plan-total-amount').textContent = formatCurrency(appState.activePlan.totalAmount);
                toggleModal('plan-modal', true);
            });
            document.getElementById('plan-cancel-btn').addEventListener('click', () => toggleModal('plan-modal', false));
            document.getElementById('plan-form').addEventListener('submit', (e) => {
                e.preventDefault();
                createInstallmentPlan();
            });
            document.getElementById('payment-form').addEventListener('submit', async event => {
                event.preventDefault();
                const form = event.target;
                const paymentData = {
                    year: parseInt(document.getElementById('payment-year').value),
                    amount: parseFloat(document.getElementById('payment-amount').value),
                    date: document.getElementById('payment-date').value,
                    recipient: document.getElementById('payment-recipient').value.trim(),
                    category: document.getElementById('payment-category').value.trim(),
                    notes: document.getElementById('payment-notes').value.trim(),
                    impactTag: document.getElementById('payment-impact-tag').value
                };
                if (appState.isEditingPayment) paymentData.id = appState.isEditingPayment;
                if (!paymentData.year || !paymentData.amount || !paymentData.date) {
                    showToast('براہ کرم سال، رقم، اور تاریخ درج کریں۔', 'error');
                    return
                }
                await saveData(STORES.payments, paymentData);
                showToast(appState.isEditingPayment ? 'ادائیگی اپڈیٹ ہو گئی۔' : 'ادائیگی محفوظ ہو گئی۔', 'success');
                form.reset();
                appState.isEditingPayment = null;
                document.querySelector('#payment-form button[type="submit"]').innerHTML = '<i class="bi bi-plus-circle-fill"></i> ادائیگی محفوظ کریں';
                renderPaymentHistory();
                populateRecipientSuggestions();
                populatePaymentYearSelect()
            });
            document.getElementById('clear-data-btn').addEventListener('click', () => {
                showConfirmation('تمام ڈیٹا حذف کریں؟', 'یہ عمل واپس نہیں لیا جا سکتا! تمام حسابات، ادائیگیاں، اور سیٹنگز حذف ہو جائیں گی۔', async () => {
                    await db.close();
                    await indexedDB.deleteDatabase(DB_NAME);
                    showToast('تمام ڈیٹا حذف کر دیا گیا۔ ایپ دوبارہ لوڈ کی جا رہی ہے۔', 'success');
                    setTimeout(() => window.location.reload(), 2000)
                })
            });
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    document.querySelectorAll('.lang-content').forEach(c => c.classList.remove('active'));
                    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
                    const lang = e.target.dataset.lang;
                    document.getElementById(`lang-${lang}`).classList.add('active');
                    e.target.classList.add('active');
                    document.getElementById('info').dir = lang === 'en' ? 'ltr' : 'rtl'
                })
            });
            document.getElementById('fetch-prices-btn').addEventListener('click', fetchLivePrices);
            const updateRealTimeValue = (inputId, displayId, price, isGold = false) => {
                const input = document.getElementById(inputId);
                const display = document.getElementById(displayId);
                const value = parseFloat(input.value) || 0;
                if (value > 0 && price > 0) {
                    let finalValue = value * price;
                    if (isGold) {
                        const karat = parseInt(document.getElementById('gold-karat').value);
                        const purityFactors = {
                            24: 1,
                            22: 22 / 24,
                            18: 18 / 24
                        };
                        finalValue = value * purityFactors[karat] * price
                    }
                    display.textContent = `≈ ${formatCurrency(finalValue)}`
                } else {
                    display.textContent = ''
                }
            };
            document.getElementById('gold').addEventListener('input', () => updateRealTimeValue('gold', 'gold-value-display', appState.settings.goldPrice, true));
            document.getElementById('gold-karat').addEventListener('change', () => updateRealTimeValue('gold', 'gold-value-display', appState.settings.goldPrice, true));
            document.getElementById('silver').addEventListener('input', () => updateRealTimeValue('silver', 'silver-value-display', appState.settings.silverPrice));
            document.getElementById('details-modal-close-btn').onclick = () => toggleModal('details-modal', false);
            document.getElementById('enable-notifications-btn').onclick = requestNotificationPermission;
            document.getElementById('payment-year').addEventListener('change', autofillPaymentAmount)
        }
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await openDB();
                window.db = db;
                window.STORES = STORES;
                window.dbRequest = dbRequest;
                await loadSettings();
                updateHeaderIslamicDate();
                /* Load initial data  for actual prices for gold and silver
                await fetchLivePrices();
                */
                await fetchLivePrices();
                showTab('dashboard');
                setupEventListeners();
                setupFkEventListeners();
                await Promise.all([populatePaymentHistoryYearFilter(), populateReportYearFilter(), checkAndShowNotification()]);
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('./sw.js').then(reg => console.log('Service Worker registered successfully', reg)).catch(err => console.error('Service Worker registration failed', err))
                }
            } catch (error) {
                console.error('Initialization failed:', error);
                document.body.innerHTML = `<div style="text-align:center;padding:2rem;color:var(--error-color);"><h1>ایپلی کیشن شروع کرنے میں خرابی</h1><p>براہ کرم یقینی بنائیں کہ آپ کا براؤزر IndexedDB کو سپورٹ کرتا ہے اور پرائیویٹ موڈ میں نہیں ہے۔</p></div>`
            }
        });	
    </script>
</body>

</html>